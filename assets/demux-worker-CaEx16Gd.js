(function(){"use strict";function p(r){if(!r)throw new Error("Assertion failed.")}const Ft=r=>{const e=(r%360+360)%360;if(e===0||e===90||e===180||e===270)return e;throw new Error(`Invalid rotation ${r}.`)},J=r=>r&&r[r.length-1];class N{constructor(e){this.bytes=e,this.pos=0}seekToByte(e){this.pos=8*e}readBit(){const e=Math.floor(this.pos/8),t=this.bytes[e]??0,a=7-(this.pos&7),n=(t&1<<a)>>a;return this.pos++,n}readBits(e){if(e===1)return this.readBit();let t=0;for(let a=0;a<e;a++)t<<=1,t|=this.readBit();return t}writeBits(e,t){const a=this.pos+e;for(let n=this.pos;n<a;n++){const s=Math.floor(n/8);let i=this.bytes[s];const o=7-(n&7);i&=~(1<<o),i|=(t&1<<a-n-1)>>a-n-1<<o,this.bytes[s]=i}this.pos=a}readAlignedByte(){if(this.pos%8!==0)throw new Error("Bitstream is not byte-aligned.");const e=this.pos/8,t=this.bytes[e]??0;return this.pos+=8,t}skipBits(e){this.pos+=e}getBitsLeft(){return this.bytes.length*8-this.pos}clone(){const e=new N(this.bytes);return e.pos=this.pos,e}}const _=r=>{let e=0;for(;r.readBits(1)===0&&e<32;)e++;if(e>=32)throw new Error("Invalid exponential-Golomb code.");return(1<<e)-1+r.readBits(e)},Re=r=>{const e=_(r);return(e&1)===0?-(e>>1):e+1>>1},ze=r=>r.constructor===Uint8Array?r:r instanceof ArrayBuffer?new Uint8Array(r):new Uint8Array(r.buffer,r.byteOffset,r.byteLength),V=r=>r.constructor===DataView?r:r instanceof ArrayBuffer?new DataView(r):new DataView(r.buffer,r.byteOffset,r.byteLength),K=new TextDecoder;new TextEncoder;const st=r=>Object.fromEntries(Object.entries(r).map(([e,t])=>[t,e])),At={bt709:1,bt470bg:5,smpte170m:6,bt2020:9,smpte432:12},Et=st(At),Bt={bt709:1,smpte170m:6,linear:8,"iec61966-2-1":13,pq:16,hlg:18},Rt=st(Bt),zt={rgb:0,bt709:1,bt470bg:5,smpte170m:6,"bt2020-ncl":9},Nt=st(zt),Dr=r=>r instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&r instanceof SharedArrayBuffer||ArrayBuffer.isView(r);class Ke{constructor(){this.currentPromise=Promise.resolve()}async acquire(){let e;const t=new Promise(n=>{e=n}),a=this.currentPromise;return this.currentPromise=t,await a,e}}const Ot=r=>[...r].map(e=>e.toString(16).padStart(2,"0")).join(""),Mt=r=>(r=r>>1&1431655765|(r&1431655765)<<1,r=r>>2&858993459|(r&858993459)<<2,r=r>>4&252645135|(r&252645135)<<4,r=r>>8&16711935|(r&16711935)<<8,r=r>>16&65535|(r&65535)<<16,r>>>0),ot=(r,e,t)=>{let a=0,n=r.length-1,s=-1;for(;a<=n;){const i=a+n>>1,o=t(r[i]);o===e?(s=i,n=i-1):o<e?a=i+1:n=i-1}return s},z=(r,e,t)=>{let a=0,n=r.length-1,s=-1;for(;a<=n;){const i=a+(n-a+1)/2|0;t(r[i])<=e?(s=i,a=i+1):n=i-1}return s},Ut=(r,e,t)=>{const a=z(r,t(e),t);r.splice(a+1,0,e)},L=()=>{let r,e;return{promise:new Promise((a,n)=>{r=a,e=n}),resolve:r,reject:e}},Vt=(r,e)=>{for(let t=r.length-1;t>=0;t--)if(e(r[t]))return r[t]},Ht=(r,e)=>{for(let t=r.length-1;t>=0;t--)if(e(r[t]))return t;return-1},Fr=async function*(r){Symbol.iterator in r?yield*r[Symbol.iterator]():yield*r[Symbol.asyncIterator]()},Ar=r=>{if(!(Symbol.iterator in r)&&!(Symbol.asyncIterator in r))throw new TypeError("Argument must be an iterable or async iterable.")},ct=r=>{throw new Error(`Unexpected value: ${r}`)},qt=(r,e,t)=>{const a=r.getUint8(e),n=r.getUint8(e+1),s=r.getUint8(e+2);return a<<16|n<<8|s},Lt=(r,e,t)=>Math.max(e,Math.min(t,r)),Q="und",je=(r,e)=>{const t=10**e;return Math.round(r*t)/t},Er=(r,e)=>Math.round(r/e)*e,Br=r=>{let e=0;for(;r;)e++,r>>=1;return e},Rr=/^[a-z]{3}$/,Wt=r=>Rr.test(r),pe=1e6*(1+Number.EPSILON);class zr{constructor(){this.currentPromise=Promise.resolve()}call(e){return this.currentPromise=this.currentPromise.then(e)}}let lt=null;const ut=()=>{if(lt!==null)return lt;const r=!!(typeof navigator<"u"&&navigator.vendor?.match(/apple/i)&&!navigator.userAgent?.match(/crios/i)&&!navigator.userAgent?.match(/fxios/i)&&!navigator.userAgent?.match(/Opera|OPT\//));return lt=r,r};let dt=null;const Nr=()=>dt!==null?dt:dt=typeof navigator<"u"&&navigator.userAgent?.includes("Firefox"),ge=(r,e)=>r!==-1?r:e,Kt=(r,e,t,a)=>r<=a&&t<=e,Or=r=>{const e=atob(r),t=new Uint8Array(e.length);for(let a=0;a<e.length;a++)t[a]=e.charCodeAt(a);return t},jt=()=>{Symbol.dispose??=Symbol("Symbol.dispose")},Qt=r=>typeof r=="number"&&!Number.isNaN(r);class Qe{constructor(e,t){if(this.data=e,this.mimeType=t,!(e instanceof Uint8Array))throw new TypeError("data must be a Uint8Array.");if(typeof t!="string")throw new TypeError("mimeType must be a string.")}}class Mr{constructor(e,t,a,n){if(this.data=e,this.mimeType=t,this.name=a,this.description=n,!(e instanceof Uint8Array))throw new TypeError("data must be a Uint8Array.");if(t!==void 0&&typeof t!="string")throw new TypeError("mimeType, when provided, must be a string.");if(a!==void 0&&typeof a!="string")throw new TypeError("name, when provided, must be a string.");if(n!==void 0&&typeof n!="string")throw new TypeError("description, when provided, must be a string.")}}const ft=["pcm-s16","pcm-s16be","pcm-s24","pcm-s24be","pcm-s32","pcm-s32be","pcm-f32","pcm-f32be","pcm-f64","pcm-f64be","pcm-u8","pcm-s8","ulaw","alaw"],ke=[{maxPictureSize:36864,maxBitrate:2e5,level:10},{maxPictureSize:73728,maxBitrate:8e5,level:11},{maxPictureSize:122880,maxBitrate:18e5,level:20},{maxPictureSize:245760,maxBitrate:36e5,level:21},{maxPictureSize:552960,maxBitrate:72e5,level:30},{maxPictureSize:983040,maxBitrate:12e6,level:31},{maxPictureSize:2228224,maxBitrate:18e6,level:40},{maxPictureSize:2228224,maxBitrate:3e7,level:41},{maxPictureSize:8912896,maxBitrate:6e7,level:50},{maxPictureSize:8912896,maxBitrate:12e7,level:51},{maxPictureSize:8912896,maxBitrate:18e7,level:52},{maxPictureSize:35651584,maxBitrate:18e7,level:60},{maxPictureSize:35651584,maxBitrate:24e7,level:61},{maxPictureSize:35651584,maxBitrate:48e7,level:62}],$t=".01.01.01.01.00",Gt=".0.110.01.01.01.0",Xt=r=>{const{codec:e,codecDescription:t,colorSpace:a,avcCodecInfo:n,hevcCodecInfo:s,vp9CodecInfo:i,av1CodecInfo:o}=r;if(e==="avc"){if(n){const c=new Uint8Array([n.avcProfileIndication,n.profileCompatibility,n.avcLevelIndication]);return`avc1.${Ot(c)}`}if(!t||t.byteLength<4)throw new TypeError("AVC decoder description is not provided or is not at least 4 bytes long.");return`avc1.${Ot(t.subarray(1,4))}`}else if(e==="hevc"){let c,l,d,u,f,h;if(s)c=s.generalProfileSpace,l=s.generalProfileIdc,d=Mt(s.generalProfileCompatibilityFlags),u=s.generalTierFlag,f=s.generalLevelIdc,h=[...s.generalConstraintIndicatorFlags];else{if(!t||t.byteLength<23)throw new TypeError("HEVC decoder description is not provided or is not at least 23 bytes long.");const k=V(t),b=k.getUint8(1);c=b>>6&3,l=b&31,d=Mt(k.getUint32(2)),u=b>>5&1,f=k.getUint8(12),h=[];for(let T=0;T<6;T++)h.push(k.getUint8(6+T))}let m="hev1.";for(m+=["","A","B","C"][c]+l,m+=".",m+=d.toString(16).toUpperCase(),m+=".",m+=u===0?"L":"H",m+=f;h.length>0&&h[h.length-1]===0;)h.pop();return h.length>0&&(m+=".",m+=h.map(k=>k.toString(16).toUpperCase()).join(".")),m}else{if(e==="vp8")return"vp8";if(e==="vp9"){if(!i){const T=r.width*r.height;let g=J(ke).level;for(const w of ke)if(T<=w.maxPictureSize){g=w.level;break}return`vp09.00.${g.toString().padStart(2,"0")}.08`}const c=i.profile.toString().padStart(2,"0"),l=i.level.toString().padStart(2,"0"),d=i.bitDepth.toString().padStart(2,"0"),u=i.chromaSubsampling.toString().padStart(2,"0"),f=i.colourPrimaries.toString().padStart(2,"0"),h=i.transferCharacteristics.toString().padStart(2,"0"),m=i.matrixCoefficients.toString().padStart(2,"0"),k=i.videoFullRangeFlag.toString().padStart(2,"0");let b=`vp09.${c}.${l}.${d}.${u}`;return b+=`.${f}.${h}.${m}.${k}`,b.endsWith($t)&&(b=b.slice(0,-$t.length)),b}else if(e==="av1"){if(!o){const w=r.width*r.height;let y=J(ke).level;for(const I of ke)if(w<=I.maxPictureSize){y=I.level;break}return`av01.0.${y.toString().padStart(2,"0")}M.08`}const c=o.profile,l=o.level.toString().padStart(2,"0"),d=o.tier?"H":"M",u=o.bitDepth.toString().padStart(2,"0"),f=o.monochrome?"1":"0",h=100*o.chromaSubsamplingX+10*o.chromaSubsamplingY+1*(o.chromaSubsamplingX&&o.chromaSubsamplingY?o.chromaSamplePosition:0),m=a?.primaries?At[a.primaries]:1,k=a?.transfer?Bt[a.transfer]:1,b=a?.matrix?zt[a.matrix]:1,T=a?.fullRange?1:0;let g=`av01.${c}.${l}${d}.${u}`;return g+=`.${f}.${h.toString().padStart(3,"0")}`,g+=`.${m.toString().padStart(2,"0")}`,g+=`.${k.toString().padStart(2,"0")}`,g+=`.${b.toString().padStart(2,"0")}`,g+=`.${T}`,g.endsWith(Gt)&&(g=g.slice(0,-Gt.length)),g}}throw new TypeError(`Unhandled codec '${e}'.`)},Zt=r=>{const{codec:e,codecDescription:t,aacCodecInfo:a}=r;if(e==="aac"){if(!a)throw new TypeError("AAC codec info must be provided.");return a.isMpeg2?"mp4a.67":`mp4a.40.${Jt(t).objectType}`}else{if(e==="mp3")return"mp3";if(e==="opus")return"opus";if(e==="vorbis")return"vorbis";if(e==="flac")return"flac";if(e&&ft.includes(e))return e}throw new TypeError(`Unhandled codec '${e}'.`)},$e=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],Yt=[-1,1,2,3,4,5,6,8],Jt=r=>{if(!r||r.byteLength<2)throw new TypeError("AAC description must be at least 2 bytes long.");const e=new N(r);let t=e.readBits(5);t===31&&(t=32+e.readBits(6));const a=e.readBits(4);let n=null;a===15?n=e.readBits(24):a<$e.length&&(n=$e[a]);const s=e.readBits(4);let i=null;return s>=1&&s<=7&&(i=Yt[s]),{objectType:t,frequencyIndex:a,sampleRate:n,channelConfiguration:s,numberOfChannels:i}},Ge=48e3,Ur=/^pcm-([usf])(\d+)+(be)?$/,Vr=r=>{if(p(ft.includes(r)),r==="ulaw")return{dataType:"ulaw",sampleSize:1,littleEndian:!0,silentValue:255};if(r==="alaw")return{dataType:"alaw",sampleSize:1,littleEndian:!0,silentValue:213};const e=Ur.exec(r);p(e);let t;e[1]==="u"?t="unsigned":e[1]==="s"?t="signed":t="float";const a=Number(e[2])/8,n=e[3]!=="be",s=r==="pcm-u8"?2**7:0;return{dataType:t,sampleSize:a,littleEndian:n,silentValue:s}};var be;(function(r){r[r.IDR=5]="IDR",r[r.SPS=7]="SPS",r[r.PPS=8]="PPS",r[r.SPS_EXT=13]="SPS_EXT"})(be||(be={}));var H;(function(r){r[r.RASL_N=8]="RASL_N",r[r.RASL_R=9]="RASL_R",r[r.BLA_W_LP=16]="BLA_W_LP",r[r.RSV_IRAP_VCL23=23]="RSV_IRAP_VCL23",r[r.VPS_NUT=32]="VPS_NUT",r[r.SPS_NUT=33]="SPS_NUT",r[r.PPS_NUT=34]="PPS_NUT",r[r.PREFIX_SEI_NUT=39]="PREFIX_SEI_NUT",r[r.SUFFIX_SEI_NUT=40]="SUFFIX_SEI_NUT"})(H||(H={}));const Xe=r=>{const e=[];let t=0;for(;t<r.length;){let a=-1,n=0;for(let s=t;s<r.length-3;s++){if(r[s]===0&&r[s+1]===0&&r[s+2]===1){a=s,n=3;break}if(s<r.length-4&&r[s]===0&&r[s+1]===0&&r[s+2]===0&&r[s+3]===1){a=s,n=4;break}}if(a===-1)break;if(t>0&&a>t){const s=r.subarray(t,a);s.length>0&&e.push(s)}t=a+n}if(t<r.length){const a=r.subarray(t);a.length>0&&e.push(a)}return e},er=(r,e)=>{const t=[];let a=0;const n=new DataView(r.buffer,r.byteOffset,r.byteLength);for(;a+e<=r.length;){let s;e===1?s=n.getUint8(a):e===2?s=n.getUint16(a,!1):e===3?s=qt(n,a):e===4?s=n.getUint32(a,!1):(ct(e),p(!1)),a+=e;const i=r.subarray(a,a+s);t.push(i),a+=s}return t},ht=r=>{const e=[],t=r.length;for(let a=0;a<t;a++)a+2<t&&r[a]===0&&r[a+1]===0&&r[a+2]===3?(e.push(0,0),a+=2):e.push(r[a]);return new Uint8Array(e)},Hr=(r,e)=>{if(e.description){const n=(ze(e.description)[4]&3)+1;return er(r,n)}else return Xe(r)},Ze=r=>r[0]&31,qr=r=>{try{const e=Xe(r),t=e.filter(f=>Ze(f)===be.SPS),a=e.filter(f=>Ze(f)===be.PPS),n=e.filter(f=>Ze(f)===be.SPS_EXT);if(t.length===0||a.length===0)return null;const s=t[0],i=new N(ht(s));if(i.skipBits(1),i.skipBits(2),i.readBits(5)!==7)return console.error("Invalid SPS NAL unit type"),null;const c=i.readAlignedByte(),l=i.readAlignedByte(),d=i.readAlignedByte(),u={configurationVersion:1,avcProfileIndication:c,profileCompatibility:l,avcLevelIndication:d,lengthSizeMinusOne:3,sequenceParameterSets:t,pictureParameterSets:a,chromaFormat:null,bitDepthLumaMinus8:null,bitDepthChromaMinus8:null,sequenceParameterSetExt:null};if(c===100||c===110||c===122||c===144){_(i);const f=_(i);f===3&&i.skipBits(1);const h=_(i),m=_(i);u.chromaFormat=f,u.bitDepthLumaMinus8=h,u.bitDepthChromaMinus8=m,u.sequenceParameterSetExt=n}return u}catch(e){return console.error("Error building AVC Decoder Configuration Record:",e),null}},tr=(r,e)=>{if(e.description){const n=(ze(e.description)[21]&3)+1;return er(r,n)}else return Xe(r)},ne=r=>r[0]>>1&63,Lr=r=>{try{const e=Xe(r),t=e.filter(R=>ne(R)===H.VPS_NUT),a=e.filter(R=>ne(R)===H.SPS_NUT),n=e.filter(R=>ne(R)===H.PPS_NUT),s=e.filter(R=>ne(R)===H.PREFIX_SEI_NUT||ne(R)===H.SUFFIX_SEI_NUT);if(a.length===0||n.length===0)return null;const i=a[0],o=new N(ht(i));o.skipBits(16),o.readBits(4);const c=o.readBits(3),l=o.readBits(1),{general_profile_space:d,general_tier_flag:u,general_profile_idc:f,general_profile_compatibility_flags:h,general_constraint_indicator_flags:m,general_level_idc:k}=Wr(o,c);_(o);const b=_(o);b===3&&o.skipBits(1),_(o),_(o),o.readBits(1)&&(_(o),_(o),_(o),_(o));const T=_(o),g=_(o);_(o);const y=o.readBits(1)?0:c;for(let R=y;R<=c;R++)_(o),_(o),_(o);_(o),_(o),_(o),_(o),_(o),_(o),o.readBits(1)&&o.readBits(1)&&Kr(o),o.skipBits(1),o.skipBits(1),o.readBits(1)&&(o.skipBits(4),o.skipBits(4),_(o),_(o),o.skipBits(1));const I=_(o);if(jr(o,I),o.readBits(1)){const R=_(o);for(let B=0;B<R;B++)_(o),o.skipBits(1)}o.skipBits(1),o.skipBits(1);let v=0;o.readBits(1)&&(v=$r(o,c));let x=0;if(n.length>0){const R=n[0],B=new N(ht(R));B.skipBits(16),_(B),_(B),B.skipBits(1),B.skipBits(1),B.skipBits(3),B.skipBits(1),B.skipBits(1),_(B),_(B),Re(B),B.skipBits(1),B.skipBits(1),B.readBits(1)&&_(B),Re(B),Re(B),B.skipBits(1),B.skipBits(1),B.skipBits(1),B.skipBits(1);const X=B.readBits(1),We=B.readBits(1);!X&&!We?x=0:X&&!We?x=2:!X&&We?x=3:x=0}const C=[...t.length?[{arrayCompleteness:1,nalUnitType:H.VPS_NUT,nalUnits:t}]:[],...a.length?[{arrayCompleteness:1,nalUnitType:H.SPS_NUT,nalUnits:a}]:[],...n.length?[{arrayCompleteness:1,nalUnitType:H.PPS_NUT,nalUnits:n}]:[],...s.length?[{arrayCompleteness:1,nalUnitType:ne(s[0]),nalUnits:s}]:[]];return{configurationVersion:1,generalProfileSpace:d,generalTierFlag:u,generalProfileIdc:f,generalProfileCompatibilityFlags:h,generalConstraintIndicatorFlags:m,generalLevelIdc:k,minSpatialSegmentationIdc:v,parallelismType:x,chromaFormatIdc:b,bitDepthLumaMinus8:T,bitDepthChromaMinus8:g,avgFrameRate:0,constantFrameRate:0,numTemporalLayers:c+1,temporalIdNested:l,lengthSizeMinusOne:3,arrays:C}}catch(e){return console.error("Error building HEVC Decoder Configuration Record:",e),null}},Wr=(r,e)=>{const t=r.readBits(2),a=r.readBits(1),n=r.readBits(5);let s=0;for(let d=0;d<32;d++)s=s<<1|r.readBits(1);const i=new Uint8Array(6);for(let d=0;d<6;d++)i[d]=r.readBits(8);const o=r.readBits(8),c=[],l=[];for(let d=0;d<e;d++)c.push(r.readBits(1)),l.push(r.readBits(1));if(e>0)for(let d=e;d<8;d++)r.skipBits(2);for(let d=0;d<e;d++)c[d]&&r.skipBits(88),l[d]&&r.skipBits(8);return{general_profile_space:t,general_tier_flag:a,general_profile_idc:n,general_profile_compatibility_flags:s,general_constraint_indicator_flags:i,general_level_idc:o}},Kr=r=>{for(let e=0;e<4;e++)for(let t=0;t<(e===3?2:6);t++)if(!r.readBits(1))_(r);else{const n=Math.min(64,1<<4+(e<<1));e>1&&Re(r);for(let s=0;s<n;s++)Re(r)}},jr=(r,e)=>{const t=[];for(let a=0;a<e;a++)t[a]=Qr(r,a,e,t)},Qr=(r,e,t,a)=>{let n=0,s=0,i=0;if(e!==0&&(s=r.readBits(1)),s){if(e===t){const c=_(r);i=e-(c+1)}else i=e-1;r.readBits(1),_(r);const o=a[i]??0;for(let c=0;c<=o;c++)r.readBits(1)||r.readBits(1);n=a[i]}else{const o=_(r),c=_(r);for(let l=0;l<o;l++)_(r),r.readBits(1);for(let l=0;l<c;l++)_(r),r.readBits(1);n=o+c}return n},$r=(r,e)=>{if(r.readBits(1)&&r.readBits(8)===255&&(r.readBits(16),r.readBits(16)),r.readBits(1)&&r.readBits(1),r.readBits(1)&&(r.readBits(3),r.readBits(1),r.readBits(1)&&(r.readBits(8),r.readBits(8),r.readBits(8))),r.readBits(1)&&(_(r),_(r)),r.readBits(1),r.readBits(1),r.readBits(1),r.readBits(1)&&(_(r),_(r),_(r),_(r)),r.readBits(1)&&(r.readBits(32),r.readBits(32),r.readBits(1)&&_(r),r.readBits(1)&&Gr(r,!0,e)),r.readBits(1)){r.readBits(1),r.readBits(1),r.readBits(1);const t=_(r);return _(r),_(r),_(r),_(r),t}return 0},Gr=(r,e,t)=>{let a=!1,n=!1,s=!1;a=r.readBits(1)===1,n=r.readBits(1)===1,(a||n)&&(s=r.readBits(1)===1,s&&(r.readBits(8),r.readBits(5),r.readBits(1),r.readBits(5)),r.readBits(4),r.readBits(4),s&&r.readBits(4),r.readBits(5),r.readBits(5),r.readBits(5));for(let i=0;i<=t;i++){const o=r.readBits(1)===1;let c=!0;o||(c=r.readBits(1)===1);let l=!1;c?_(r):l=r.readBits(1)===1;let d=1;l||(d=_(r)+1),a&&rr(r,d,s),n&&rr(r,d,s)}},rr=(r,e,t)=>{for(let a=0;a<e;a++)_(r),_(r),t&&(_(r),_(r)),r.readBits(1)},ar=r=>{const e=new N(r);if(e.readBits(2)!==2)return null;const a=e.readBits(1),s=(e.readBits(1)<<1)+a;if(s===3&&e.skipBits(1),e.readBits(1)===1||e.readBits(1)!==0||(e.skipBits(2),e.readBits(24)!==4817730))return null;let l=8;s>=2&&(l=e.readBits(1)?12:10);const d=e.readBits(3);let u=0,f=0;if(d!==7)if(f=e.readBits(1),s===1||s===3){const x=e.readBits(1),C=e.readBits(1);u=!x&&!C?3:x&&!C?2:1,e.skipBits(1)}else u=1;else u=3,f=1;const h=e.readBits(16),m=e.readBits(16),k=h+1,b=m+1,T=k*b;let g=J(ke).level;for(const v of ke)if(T<=v.maxPictureSize){g=v.level;break}return{profile:s,level:g,bitDepth:l,chromaSubsampling:u,videoFullRangeFlag:f,colourPrimaries:d===2?1:d===1?6:2,transferCharacteristics:d===2?1:d===1?6:2,matrixCoefficients:d===7?0:d===2?1:d===1?6:2}},nr=function*(r){const e=new N(r),t=()=>{let a=0;for(let n=0;n<8;n++){const s=e.readAlignedByte();if(a|=(s&127)<<n*7,!(s&128))break;if(n===7&&s&128)return null}return a>=2**32-1?null:a};for(;e.getBitsLeft()>=8;){e.skipBits(1);const a=e.readBits(4),n=e.readBits(1),s=e.readBits(1);e.skipBits(1),n&&e.skipBits(8);let i;if(s){const o=t();if(o===null)return;i=o}else i=Math.floor(e.getBitsLeft()/8);p(e.pos%8===0),yield{type:a,data:r.subarray(e.pos/8,e.pos/8+i)},e.skipBits(i*8)}},ir=r=>{for(const{type:e,data:t}of nr(r)){if(e!==1)continue;const a=new N(t),n=a.readBits(3);a.readBits(1);const s=a.readBits(1);let i=0,o=0,c=0;if(s)i=a.readBits(5);else{if(a.readBits(1)&&(a.skipBits(32),a.skipBits(32),a.readBits(1)))return null;const b=a.readBits(1);b&&(c=a.readBits(5),a.skipBits(32),a.skipBits(5),a.skipBits(5));const T=a.readBits(5);for(let g=0;g<=T;g++){a.skipBits(12);const w=a.readBits(5);if(g===0&&(i=w),w>7){const I=a.readBits(1);g===0&&(o=I)}if(b&&a.readBits(1)){const v=c+1;a.skipBits(v),a.skipBits(v),a.skipBits(1)}a.readBits(1)&&a.skipBits(4)}}const l=a.readBits(1);let d=8;n===2&&l?d=a.readBits(1)?12:10:n<=2&&(d=l?10:8);let u=0;n!==1&&(u=a.readBits(1));let f=1,h=1,m=0;return u||(n===0?(f=1,h=1):n===1?(f=0,h=0):d===12&&(f=a.readBits(1),f&&(h=a.readBits(1))),f&&h&&(m=a.readBits(2))),{profile:n,level:i,tier:o,bitDepth:d,monochrome:u,chromaSubsamplingX:f,chromaSubsamplingY:h,chromaSamplePosition:m}}return null},Xr=r=>{const e=V(r),t=e.getUint8(9),a=e.getUint16(10,!0),n=e.getUint32(12,!0),s=e.getInt16(16,!0),i=e.getUint8(18);let o=null;return i&&(o=r.subarray(19,21+t)),{outputChannelCount:t,preSkip:a,inputSampleRate:n,outputGain:s,channelMappingFamily:i,channelMappingTable:o}},Zr=[480,960,1920,2880,480,960,1920,2880,480,960,1920,2880,480,960,480,960,120,240,480,960,120,240,480,960,120,240,480,960,120,240,480,960],Yr=r=>{const e=r[0]>>3;return{durationInSamples:Zr[e]}},Jr=r=>{if(r.length<7)throw new Error("Setup header is too short.");if(r[0]!==5)throw new Error("Wrong packet type in Setup header.");if(String.fromCharCode(...r.slice(1,7))!=="vorbis")throw new Error("Invalid packet signature in Setup header.");const t=r.length,a=new Uint8Array(t);for(let u=0;u<t;u++)a[u]=r[t-1-u];const n=new N(a);let s=0;for(;n.getBitsLeft()>97;)if(n.readBits(1)===1){s=n.pos;break}if(s===0)throw new Error("Invalid Setup header: framing bit not found.");let i=0,o=!1,c=0;for(;n.getBitsLeft()>=97;){const u=n.pos,f=n.readBits(8),h=n.readBits(16),m=n.readBits(16);if(f>63||h!==0||m!==0){n.pos=u;break}if(n.skipBits(1),i++,i>64)break;n.clone().readBits(6)+1===i&&(o=!0,c=i)}if(!o)throw new Error("Invalid Setup header: mode header not found.");if(c>63)throw new Error(`Unsupported mode count: ${c}.`);const l=c;n.pos=0,n.skipBits(s);const d=Array(l).fill(0);for(let u=l-1;u>=0;u--)n.skipBits(40),d[u]=n.readBits(1);return{modeBlockflags:d}},sr=(r,e,t)=>{switch(r){case"avc":return Hr(t,e).some(s=>Ze(s)===be.IDR)?"key":"delta";case"hevc":return tr(t,e).some(s=>{const i=ne(s);return H.BLA_W_LP<=i&&i<=H.RSV_IRAP_VCL23})?"key":"delta";case"vp8":return(t[0]&1)===0?"key":"delta";case"vp9":{const a=new N(t);if(a.readBits(2)!==2)return null;const n=a.readBits(1);return(a.readBits(1)<<1)+n===3&&a.skipBits(1),a.readBits(1)?null:a.readBits(1)===0?"key":"delta"}case"av1":{let a=!1;for(const{type:n,data:s}of nr(t))if(n===1){const i=new N(s);i.skipBits(4),a=!!i.readBits(1)}else if(n===3||n===6||n===7){if(a)return"key";const i=new N(s);return i.readBits(1)?null:i.readBits(2)===0?"key":"delta"}return null}default:ct(r),p(!1)}};var Te;(function(r){r[r.STREAMINFO=0]="STREAMINFO",r[r.VORBIS_COMMENT=4]="VORBIS_COMMENT",r[r.PICTURE=6]="PICTURE"})(Te||(Te={}));const mt=(r,e)=>{const t=V(r);let a=0;const n=t.getUint32(a,!0);a+=4;const s=K.decode(r.subarray(a,a+n));a+=n,n>0&&(e.raw??={},e.raw.vendor??=s);const i=t.getUint32(a,!0);a+=4;for(let o=0;o<i;o++){const c=t.getUint32(a,!0);a+=4;const l=K.decode(r.subarray(a,a+c));a+=c;const d=l.indexOf("=");if(d===-1)continue;const u=l.slice(0,d).toUpperCase(),f=l.slice(d+1);switch(e.raw??={},e.raw[u]??=f,u){case"TITLE":e.title??=f;break;case"DESCRIPTION":e.description??=f;break;case"ARTIST":e.artist??=f;break;case"ALBUM":e.album??=f;break;case"ALBUMARTIST":e.albumArtist??=f;break;case"COMMENT":e.comment??=f;break;case"LYRICS":e.lyrics??=f;break;case"TRACKNUMBER":{const h=f.split("/"),m=Number.parseInt(h[0],10),k=h[1]&&Number.parseInt(h[1],10);Number.isInteger(m)&&m>0&&(e.trackNumber??=m),k&&Number.isInteger(k)&&k>0&&(e.tracksTotal??=k)}break;case"TRACKTOTAL":{const h=Number.parseInt(f,10);Number.isInteger(h)&&h>0&&(e.tracksTotal??=h)}break;case"DISCNUMBER":{const h=f.split("/"),m=Number.parseInt(h[0],10),k=h[1]&&Number.parseInt(h[1],10);Number.isInteger(m)&&m>0&&(e.discNumber??=m),k&&Number.isInteger(k)&&k>0&&(e.discsTotal??=k)}break;case"DISCTOTAL":{const h=Number.parseInt(f,10);Number.isInteger(h)&&h>0&&(e.discsTotal??=h)}break;case"DATE":{const h=new Date(f);Number.isNaN(h.getTime())||(e.date??=h)}break;case"GENRE":e.genre??=f;break;case"METADATA_BLOCK_PICTURE":{const h=Or(f),m=V(h),k=m.getUint32(0,!1),b=m.getUint32(4,!1),T=String.fromCharCode(...h.subarray(8,8+b)),g=m.getUint32(8+b,!1),w=K.decode(h.subarray(12+b,12+b+g)),y=m.getUint32(b+g+28),I=h.subarray(b+g+32,b+g+32+y);e.images??=[],e.images.push({data:I,mimeType:T,kind:k===3?"coverFront":k===4?"coverBack":"unknown",name:void 0,description:w||void 0})}break}}};class de{constructor(e){this.input=e}}const or=[],ea=[];const j=new Uint8Array(0);class O{constructor(e,t,a,n,s=-1,i,o){if(this.data=e,this.type=t,this.timestamp=a,this.duration=n,this.sequenceNumber=s,e===j&&i===void 0)throw new Error("Internal error: byteLength must be explicitly provided when constructing metadata-only packets.");if(i===void 0&&(i=e.byteLength),!(e instanceof Uint8Array))throw new TypeError("data must be a Uint8Array.");if(t!=="key"&&t!=="delta")throw new TypeError('type must be either "key" or "delta".');if(!Number.isFinite(a))throw new TypeError("timestamp must be a number.");if(!Number.isFinite(n)||n<0)throw new TypeError("duration must be a non-negative number.");if(!Number.isFinite(s))throw new TypeError("sequenceNumber must be a number.");if(!Number.isInteger(i)||i<0)throw new TypeError("byteLength must be a non-negative integer.");if(o!==void 0&&(typeof o!="object"||!o))throw new TypeError("sideData, when provided, must be an object.");if(o?.alpha!==void 0&&!(o.alpha instanceof Uint8Array))throw new TypeError("sideData.alpha, when provided, must be a Uint8Array.");if(o?.alphaByteLength!==void 0&&(!Number.isInteger(o.alphaByteLength)||o.alphaByteLength<0))throw new TypeError("sideData.alphaByteLength, when provided, must be a non-negative integer.");this.byteLength=i,this.sideData=o??{},this.sideData.alpha&&this.sideData.alphaByteLength===void 0&&(this.sideData.alphaByteLength=this.sideData.alpha.byteLength)}get isMetadataOnly(){return this.data===j}get microsecondTimestamp(){return Math.trunc(pe*this.timestamp)}get microsecondDuration(){return Math.trunc(pe*this.duration)}toEncodedVideoChunk(){if(this.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be converted to a video chunk.");if(typeof EncodedVideoChunk>"u")throw new Error("Your browser does not support EncodedVideoChunk.");return new EncodedVideoChunk({data:this.data,type:this.type,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}alphaToEncodedVideoChunk(e=this.type){if(!this.sideData.alpha)throw new TypeError("This packet does not contain alpha side data.");if(this.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be converted to a video chunk.");if(typeof EncodedVideoChunk>"u")throw new Error("Your browser does not support EncodedVideoChunk.");return new EncodedVideoChunk({data:this.sideData.alpha,type:e,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}toEncodedAudioChunk(){if(this.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be converted to an audio chunk.");if(typeof EncodedAudioChunk>"u")throw new Error("Your browser does not support EncodedAudioChunk.");return new EncodedAudioChunk({data:this.data,type:this.type,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}static fromEncodedChunk(e,t){if(!(e instanceof EncodedVideoChunk||e instanceof EncodedAudioChunk))throw new TypeError("chunk must be an EncodedVideoChunk or EncodedAudioChunk.");const a=new Uint8Array(e.byteLength);return e.copyTo(a),new O(a,e.type,e.timestamp/1e6,(e.duration??0)/1e6,void 0,void 0,t)}clone(e){if(e!==void 0&&(typeof e!="object"||e===null))throw new TypeError("options, when provided, must be an object.");if(e?.timestamp!==void 0&&!Number.isFinite(e.timestamp))throw new TypeError("options.timestamp, when provided, must be a number.");if(e?.duration!==void 0&&!Number.isFinite(e.duration))throw new TypeError("options.duration, when provided, must be a number.");return new O(this.data,this.type,e?.timestamp??this.timestamp,e?.duration??this.duration,this.sequenceNumber,this.byteLength)}}jt();class ie{get displayWidth(){return this.rotation%180===0?this.codedWidth:this.codedHeight}get displayHeight(){return this.rotation%180===0?this.codedHeight:this.codedWidth}get microsecondTimestamp(){return Math.trunc(pe*this.timestamp)}get microsecondDuration(){return Math.trunc(pe*this.duration)}get hasAlpha(){return this.format&&this.format.includes("A")}constructor(e,t){if(this._closed=!1,e instanceof ArrayBuffer||ArrayBuffer.isView(e)){if(!t||typeof t!="object")throw new TypeError("init must be an object.");if(!("format"in t)||typeof t.format!="string")throw new TypeError("init.format must be a string.");if(!Number.isInteger(t.codedWidth)||t.codedWidth<=0)throw new TypeError("init.codedWidth must be a positive integer.");if(!Number.isInteger(t.codedHeight)||t.codedHeight<=0)throw new TypeError("init.codedHeight must be a positive integer.");if(t.rotation!==void 0&&![0,90,180,270].includes(t.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(!Number.isFinite(t.timestamp))throw new TypeError("init.timestamp must be a number.");if(t.duration!==void 0&&(!Number.isFinite(t.duration)||t.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");this._data=ze(e).slice(),this.format=t.format,this.codedWidth=t.codedWidth,this.codedHeight=t.codedHeight,this.rotation=t.rotation??0,this.timestamp=t.timestamp,this.duration=t.duration??0,this.colorSpace=new VideoColorSpace(t.colorSpace)}else if(typeof VideoFrame<"u"&&e instanceof VideoFrame){if(t?.rotation!==void 0&&![0,90,180,270].includes(t.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(t?.timestamp!==void 0&&!Number.isFinite(t?.timestamp))throw new TypeError("init.timestamp, when provided, must be a number.");if(t?.duration!==void 0&&(!Number.isFinite(t.duration)||t.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");this._data=e,this.format=e.format,this.codedWidth=e.displayWidth,this.codedHeight=e.displayHeight,this.rotation=t?.rotation??0,this.timestamp=t?.timestamp??e.timestamp/1e6,this.duration=t?.duration??(e.duration??0)/1e6,this.colorSpace=e.colorSpace}else if(typeof HTMLImageElement<"u"&&e instanceof HTMLImageElement||typeof SVGImageElement<"u"&&e instanceof SVGImageElement||typeof ImageBitmap<"u"&&e instanceof ImageBitmap||typeof HTMLVideoElement<"u"&&e instanceof HTMLVideoElement||typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&e instanceof OffscreenCanvas){if(!t||typeof t!="object")throw new TypeError("init must be an object.");if(t.rotation!==void 0&&![0,90,180,270].includes(t.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(!Number.isFinite(t.timestamp))throw new TypeError("init.timestamp must be a number.");if(t.duration!==void 0&&(!Number.isFinite(t.duration)||t.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");if(typeof VideoFrame<"u")return new ie(new VideoFrame(e,{timestamp:Math.trunc(t.timestamp*pe),duration:Math.trunc((t.duration??0)*pe)||void 0}),t);let a=0,n=0;if("naturalWidth"in e?(a=e.naturalWidth,n=e.naturalHeight):"videoWidth"in e?(a=e.videoWidth,n=e.videoHeight):"width"in e&&(a=Number(e.width),n=Number(e.height)),!a||!n)throw new TypeError("Could not determine dimensions.");const s=new OffscreenCanvas(a,n),i=s.getContext("2d",{alpha:Nr(),willReadFrequently:!0});p(i),i.drawImage(e,0,0),this._data=s,this.format="RGBX",this.codedWidth=a,this.codedHeight=n,this.rotation=t.rotation??0,this.timestamp=t.timestamp,this.duration=t.duration??0,this.colorSpace=new VideoColorSpace({matrix:"rgb",primaries:"bt709",transfer:"iec61966-2-1",fullRange:!0})}else throw new TypeError("Invalid data type: Must be a BufferSource or CanvasImageSource.")}clone(){if(this._closed)throw new Error("VideoSample is closed.");return p(this._data!==null),Ne(this._data)?new ie(this._data.clone(),{timestamp:this.timestamp,duration:this.duration,rotation:this.rotation}):this._data instanceof Uint8Array?new ie(this._data.slice(),{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.timestamp,duration:this.duration,colorSpace:this.colorSpace,rotation:this.rotation}):new ie(this._data,{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.timestamp,duration:this.duration,colorSpace:this.colorSpace,rotation:this.rotation})}close(){this._closed||(Ne(this._data)?this._data.close():this._data=null,this._closed=!0)}allocationSize(){if(this._closed)throw new Error("VideoSample is closed.");return p(this._data!==null),Ne(this._data)?this._data.allocationSize():this._data instanceof Uint8Array?this._data.byteLength:this.codedWidth*this.codedHeight*4}async copyTo(e){if(!Dr(e))throw new TypeError("destination must be an ArrayBuffer or an ArrayBuffer view.");if(this._closed)throw new Error("VideoSample is closed.");if(p(this._data!==null),Ne(this._data))await this._data.copyTo(e);else if(this._data instanceof Uint8Array)ze(e).set(this._data);else{const a=this._data.getContext("2d");p(a);const n=a.getImageData(0,0,this.codedWidth,this.codedHeight);ze(e).set(n.data)}}toVideoFrame(){if(this._closed)throw new Error("VideoSample is closed.");return p(this._data!==null),Ne(this._data)?new VideoFrame(this._data,{timestamp:this.microsecondTimestamp,duration:this.microsecondDuration||void 0}):this._data instanceof Uint8Array?new VideoFrame(this._data,{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration||void 0,colorSpace:this.colorSpace}):new VideoFrame(this._data,{timestamp:this.microsecondTimestamp,duration:this.microsecondDuration||void 0})}draw(e,t,a,n,s,i,o,c,l){let d=0,u=0,f=this.displayWidth,h=this.displayHeight,m=0,k=0,b=this.displayWidth,T=this.displayHeight;if(i!==void 0?(d=t,u=a,f=n,h=s,m=i,k=o,c!==void 0?(b=c,T=l):(b=f,T=h)):(m=t,k=a,n!==void 0&&(b=n,T=s)),!(typeof CanvasRenderingContext2D<"u"&&e instanceof CanvasRenderingContext2D||typeof OffscreenCanvasRenderingContext2D<"u"&&e instanceof OffscreenCanvasRenderingContext2D))throw new TypeError("context must be a CanvasRenderingContext2D or OffscreenCanvasRenderingContext2D.");if(!Number.isFinite(d))throw new TypeError("sx must be a number.");if(!Number.isFinite(u))throw new TypeError("sy must be a number.");if(!Number.isFinite(f)||f<0)throw new TypeError("sWidth must be a non-negative number.");if(!Number.isFinite(h)||h<0)throw new TypeError("sHeight must be a non-negative number.");if(!Number.isFinite(m))throw new TypeError("dx must be a number.");if(!Number.isFinite(k))throw new TypeError("dy must be a number.");if(!Number.isFinite(b)||b<0)throw new TypeError("dWidth must be a non-negative number.");if(!Number.isFinite(T)||T<0)throw new TypeError("dHeight must be a non-negative number.");if(this._closed)throw new Error("VideoSample is closed.");({sx:d,sy:u,sWidth:f,sHeight:h}=this._rotateSourceRegion(d,u,f,h,this.rotation));const g=this.toCanvasImageSource();e.save();const w=m+b/2,y=k+T/2;e.translate(w,y),e.rotate(this.rotation*Math.PI/180);const I=this.rotation%180===0?1:b/T;e.scale(1/I,I),e.drawImage(g,d,u,f,h,-b/2,-T/2,b,T),e.restore()}drawWithFit(e,t){if(!(typeof CanvasRenderingContext2D<"u"&&e instanceof CanvasRenderingContext2D||typeof OffscreenCanvasRenderingContext2D<"u"&&e instanceof OffscreenCanvasRenderingContext2D))throw new TypeError("context must be a CanvasRenderingContext2D or OffscreenCanvasRenderingContext2D.");if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(!["fill","contain","cover"].includes(t.fit))throw new TypeError("options.fit must be 'fill', 'contain', or 'cover'.");if(t.rotation!==void 0&&![0,90,180,270].includes(t.rotation))throw new TypeError("options.rotation, when provided, must be 0, 90, 180, or 270.");t.crop!==void 0&&ra(t.crop,"options.");const a=e.canvas.width,n=e.canvas.height,s=t.rotation??this.rotation,[i,o]=s%180===0?[this.codedWidth,this.codedHeight]:[this.codedHeight,this.codedWidth];t.crop&&ta(t.crop,i,o);let c,l,d,u;const{sx:f,sy:h,sWidth:m,sHeight:k}=this._rotateSourceRegion(t.crop?.left??0,t.crop?.top??0,t.crop?.width??i,t.crop?.height??o,s);if(t.fit==="fill")c=0,l=0,d=a,u=n;else{const[T,g]=t.crop?[t.crop.width,t.crop.height]:[i,o],w=t.fit==="contain"?Math.min(a/T,n/g):Math.max(a/T,n/g);d=T*w,u=g*w,c=(a-d)/2,l=(n-u)/2}const b=s%180===0?1:d/u;e.translate(a/2,n/2),e.rotate(s*Math.PI/180),e.scale(1/b,b),e.translate(-a/2,-n/2),e.drawImage(this.toCanvasImageSource(),f,h,m,k,c,l,d,u)}_rotateSourceRegion(e,t,a,n,s){return s===90?[e,t,a,n]=[t,this.codedHeight-e-a,n,a]:s===180?[e,t]=[this.codedWidth-e-a,this.codedHeight-t-n]:s===270&&([e,t,a,n]=[this.codedWidth-t-n,e,n,a]),{sx:e,sy:t,sWidth:a,sHeight:n}}toCanvasImageSource(){if(this._closed)throw new Error("VideoSample is closed.");if(p(this._data!==null),this._data instanceof Uint8Array){const e=this.toVideoFrame();return queueMicrotask(()=>e.close()),e}else return this._data}setRotation(e){if(![0,90,180,270].includes(e))throw new TypeError("newRotation must be 0, 90, 180, or 270.");this.rotation=e}setTimestamp(e){if(!Number.isFinite(e))throw new TypeError("newTimestamp must be a number.");this.timestamp=e}setDuration(e){if(!Number.isFinite(e)||e<0)throw new TypeError("newDuration must be a non-negative number.");this.duration=e}[Symbol.dispose](){this.close()}}const Ne=r=>typeof VideoFrame<"u"&&r instanceof VideoFrame,ta=(r,e,t)=>{r.left=Math.min(r.left,e),r.top=Math.min(r.top,t),r.width=Math.min(r.width,e-r.left),r.height=Math.min(r.height,t-r.top),p(r.width>=0),p(r.height>=0)},ra=(r,e)=>{if(!r||typeof r!="object")throw new TypeError(e+"crop, when provided, must be an object.");if(!Number.isInteger(r.left)||r.left<0)throw new TypeError(e+"crop.left must be a non-negative integer.");if(!Number.isInteger(r.top)||r.top<0)throw new TypeError(e+"crop.top must be a non-negative integer.");if(!Number.isInteger(r.width)||r.width<0)throw new TypeError(e+"crop.width must be a non-negative integer.");if(!Number.isInteger(r.height)||r.height<0)throw new TypeError(e+"crop.height must be a non-negative integer.")};const Se=r=>{if(!r||typeof r!="object")throw new TypeError("options must be an object.");if(r.metadataOnly!==void 0&&typeof r.metadataOnly!="boolean")throw new TypeError("options.metadataOnly, when defined, must be a boolean.");if(r.verifyKeyPackets!==void 0&&typeof r.verifyKeyPackets!="boolean")throw new TypeError("options.verifyKeyPackets, when defined, must be a boolean.");if(r.verifyKeyPackets&&r.metadataOnly)throw new TypeError("options.verifyKeyPackets and options.metadataOnly cannot be enabled together.")},ye=r=>{if(!Qt(r))throw new TypeError("timestamp must be a number.")},pt=(r,e,t)=>t.verifyKeyPackets?e.then(async a=>{if(!a||a.type==="delta")return a;const n=await r.determinePacketType(a);return n&&(a.type=n),a}):e;class cr{constructor(e){if(!(e instanceof gt))throw new TypeError("track must be an InputTrack.");this._track=e}getFirstPacket(e={}){if(Se(e),this._track.input._disposed)throw new W;return pt(this._track,this._track._backing.getFirstPacket(e),e)}getPacket(e,t={}){if(ye(e),Se(t),this._track.input._disposed)throw new W;return pt(this._track,this._track._backing.getPacket(e,t),t)}getNextPacket(e,t={}){if(!(e instanceof O))throw new TypeError("packet must be an EncodedPacket.");if(Se(t),this._track.input._disposed)throw new W;return pt(this._track,this._track._backing.getNextPacket(e,t),t)}async getKeyPacket(e,t={}){if(ye(e),Se(t),this._track.input._disposed)throw new W;if(!t.verifyKeyPackets)return this._track._backing.getKeyPacket(e,t);const a=await this._track._backing.getKeyPacket(e,t);return!a||a.type==="delta"?a:await this._track.determinePacketType(a)==="delta"?this.getKeyPacket(a.timestamp-1/this._track.timeResolution,t):a}async getNextKeyPacket(e,t={}){if(!(e instanceof O))throw new TypeError("packet must be an EncodedPacket.");if(Se(t),this._track.input._disposed)throw new W;if(!t.verifyKeyPackets)return this._track._backing.getNextKeyPacket(e,t);const a=await this._track._backing.getNextKeyPacket(e,t);return!a||a.type==="delta"?a:await this._track.determinePacketType(a)==="delta"?this.getNextKeyPacket(a,t):a}packets(e,t,a={}){if(e!==void 0&&!(e instanceof O))throw new TypeError("startPacket must be an EncodedPacket.");if(e!==void 0&&e.isMetadataOnly&&!a?.metadataOnly)throw new TypeError("startPacket can only be metadata-only if options.metadataOnly is enabled.");if(t!==void 0&&!(t instanceof O))throw new TypeError("endPacket must be an EncodedPacket.");if(Se(a),this._track.input._disposed)throw new W;const n=[];let{promise:s,resolve:i}=L(),{promise:o,resolve:c}=L(),l=!1,d=!1,u=null;const f=[],h=()=>Math.max(2,f.length);(async()=>{let k=e??await this.getFirstPacket(a);for(;k&&!d&&!this._track.input._disposed&&!(t&&k.sequenceNumber>=t?.sequenceNumber);){if(n.length>h()){({promise:o,resolve:c}=L()),await o;continue}n.push(k),i(),{promise:s,resolve:i}=L(),k=await this.getNextPacket(k,a)}l=!0,i()})().catch(k=>{u||(u=k,i())});const m=this._track;return{async next(){for(;;){if(m.input._disposed)throw new W;if(d)return{value:void 0,done:!0};if(u)throw u;if(n.length>0){const k=n.shift(),b=performance.now();for(f.push(b);f.length>0&&b-f[0]>=1e3;)f.shift();return c(),{value:k,done:!1}}else{if(l)return{value:void 0,done:!0};await s}}},async return(){return d=!0,c(),i(),{value:void 0,done:!0}},async throw(k){throw k},[Symbol.asyncIterator](){return this}}}}class aa{constructor(e,t){this.onSample=e,this.onError=t}}class na{mediaSamplesInRange(e=0,t=1/0){ye(e),ye(t);const a=[];let n=!1,s=null,{promise:i,resolve:o}=L(),{promise:c,resolve:l}=L(),d=!1,u=!1,f=!1,h=null;(async()=>{const b=new Error,T=await this._createDecoder(x=>{if(l(),x.timestamp>=t&&(u=!0),u){x.close();return}s&&(x.timestamp>e?(a.push(s),n=!0):s.close()),x.timestamp>=e&&(a.push(x),n=!0),s=n?null:x,a.length>0&&(o(),{promise:i,resolve:o}=L())},x=>{h||(x.stack=b.stack,h=x,o())}),g=this._createPacketSink(),w=await g.getKeyPacket(e,{verifyKeyPackets:!0})??await g.getFirstPacket();if(!w)return;let y=w,I;if(t<1/0){const x=await g.getPacket(t),C=x?x.type==="key"&&x.timestamp===t?x:await g.getNextKeyPacket(x,{verifyKeyPackets:!0}):null;C&&(I=C)}const v=g.packets(w,I);for(await v.next();y&&!u&&!this._track.input._disposed;){const x=lr(a.length);if(a.length+T.getDecodeQueueSize()>x){({promise:c,resolve:l}=L()),await c;continue}T.decode(y);const C=await v.next();if(C.done)break;y=C.value}await v.return(),!f&&!this._track.input._disposed&&await T.flush(),T.close(),!n&&s&&a.push(s),d=!0,o()})().catch(b=>{h||(h=b,o())});const m=this._track,k=()=>{s?.close();for(const b of a)b.close()};return{async next(){for(;;){if(m.input._disposed)throw k(),new W;if(f)return{value:void 0,done:!0};if(h)throw k(),h;if(a.length>0){const b=a.shift();return l(),{value:b,done:!1}}else if(!d)await i;else return{value:void 0,done:!0}}},async return(){return f=!0,u=!0,l(),o(),k(),{value:void 0,done:!0}},async throw(b){throw b},[Symbol.asyncIterator](){return this}}}mediaSamplesAtTimestamps(e){Ar(e);const t=Fr(e),a=[],n=[];let{promise:s,resolve:i}=L(),{promise:o,resolve:c}=L(),l=!1,d=!1,u=null;const f=k=>{n.push(k),i(),{promise:s,resolve:i}=L()};(async()=>{const k=new Error,b=await this._createDecoder(x=>{if(c(),d){x.close();return}let C=0;for(;a.length>0&&x.timestamp-a[0]>-1e-10;)C++,a.shift();if(C>0)for(let A=0;A<C;A++)f(A<C-1?x.clone():x);else x.close()},x=>{u||(x.stack=k.stack,u=x,i())}),T=this._createPacketSink();let g=null,w=null,y=-1;const I=async()=>{p(w);let x=w;for(b.decode(x);x.sequenceNumber<y;){const C=lr(n.length);for(;n.length+b.getDecodeQueueSize()>C&&!d;)({promise:o,resolve:c}=L()),await o;if(d)break;const A=await T.getNextPacket(x);p(A),b.decode(A),x=A}y=-1},v=async()=>{await b.flush();for(let x=0;x<a.length;x++)f(null);a.length=0};for await(const x of t){if(ye(x),d||this._track.input._disposed)break;const C=await T.getPacket(x),A=C&&await T.getKeyPacket(x,{verifyKeyPackets:!0});if(!A){y!==-1&&(await I(),await v()),f(null),g=null;continue}g&&(A.sequenceNumber!==w.sequenceNumber||C.timestamp<g.timestamp)&&(await I(),await v()),a.push(C.timestamp),y=Math.max(C.sequenceNumber,y),g=C,w=A}!d&&!this._track.input._disposed&&(y!==-1&&await I(),await v()),b.close(),l=!0,i()})().catch(k=>{u||(u=k,i())});const h=this._track,m=()=>{for(const k of n)k?.close()};return{async next(){for(;;){if(h.input._disposed)throw m(),new W;if(d)return{value:void 0,done:!0};if(u)throw m(),u;if(n.length>0){const k=n.shift();return p(k!==void 0),c(),{value:k,done:!1}}else if(!l)await s;else return{value:void 0,done:!0}}},async return(){return d=!0,c(),i(),m(),{value:void 0,done:!0}},async throw(k){throw k},[Symbol.asyncIterator](){return this}}}}const lr=r=>r===0?40:8;class ia extends aa{constructor(e,t,a,n,s,i){super(e,t),this.codec=a,this.decoderConfig=n,this.rotation=s,this.timeResolution=i,this.decoder=null,this.customDecoder=null,this.customDecoderCallSerializer=new zr,this.customDecoderQueueSize=0,this.inputTimestamps=[],this.sampleQueue=[],this.currentPacketIndex=0,this.raslSkipped=!1,this.alphaDecoder=null,this.alphaHadKeyframe=!1,this.colorQueue=[],this.alphaQueue=[],this.merger=null,this.mergerCreationFailed=!1,this.decodedAlphaChunkCount=0,this.alphaDecoderQueueSize=0,this.nullAlphaFrameQueue=[],this.currentAlphaPacketIndex=0,this.alphaRaslSkipped=!1;const o=or.find(c=>c.supports(a,n));if(o)this.customDecoder=new o,this.customDecoder.codec=a,this.customDecoder.config=n,this.customDecoder.onSample=c=>{if(!(c instanceof ie))throw new TypeError("The argument passed to onSample must be a VideoSample.");this.finalizeAndEmitSample(c)},this.customDecoderCallSerializer.call(()=>this.customDecoder.init());else{const c=l=>{if(this.alphaQueue.length>0){const d=this.alphaQueue.shift();p(d!==void 0),this.mergeAlpha(l,d)}else this.colorQueue.push(l)};this.decoder=new VideoDecoder({output:l=>{try{c(l)}catch(d){this.onError(d)}},error:t}),this.decoder.configure(n)}}getDecodeQueueSize(){return this.customDecoder?this.customDecoderQueueSize:(p(this.decoder),Math.max(this.decoder.decodeQueueSize,this.alphaDecoder?.decodeQueueSize??0))}decode(e){if(this.codec==="hevc"&&this.currentPacketIndex>0&&!this.raslSkipped){if(this.hasHevcRaslPicture(e.data))return;this.raslSkipped=!0}this.currentPacketIndex++,this.customDecoder?(this.customDecoderQueueSize++,this.customDecoderCallSerializer.call(()=>this.customDecoder.decode(e)).then(()=>this.customDecoderQueueSize--)):(p(this.decoder),ut()||Ut(this.inputTimestamps,e.timestamp,t=>t),this.decoder.decode(e.toEncodedVideoChunk()),this.decodeAlphaData(e))}decodeAlphaData(e){if(!e.sideData.alpha||this.mergerCreationFailed){this.pushNullAlphaFrame();return}if(!this.merger)try{this.merger=new sa}catch(a){console.error("Due to an error, only color data will be decoded.",a),this.mergerCreationFailed=!0,this.decodeAlphaData(e);return}if(!this.alphaDecoder){const a=n=>{if(this.alphaDecoderQueueSize--,this.colorQueue.length>0){const s=this.colorQueue.shift();p(s!==void 0),this.mergeAlpha(s,n)}else this.alphaQueue.push(n);for(this.decodedAlphaChunkCount++;this.nullAlphaFrameQueue.length>0&&this.nullAlphaFrameQueue[0]===this.decodedAlphaChunkCount;)if(this.nullAlphaFrameQueue.shift(),this.colorQueue.length>0){const s=this.colorQueue.shift();p(s!==void 0),this.mergeAlpha(s,null)}else this.alphaQueue.push(null)};this.alphaDecoder=new VideoDecoder({output:n=>{try{a(n)}catch(s){this.onError(s)}},error:this.onError}),this.alphaDecoder.configure(this.decoderConfig)}const t=sr(this.codec,this.decoderConfig,e.sideData.alpha);if(this.alphaHadKeyframe||(this.alphaHadKeyframe=t==="key"),this.alphaHadKeyframe){if(this.codec==="hevc"&&this.currentAlphaPacketIndex>0&&!this.alphaRaslSkipped){if(this.hasHevcRaslPicture(e.sideData.alpha)){this.pushNullAlphaFrame();return}this.alphaRaslSkipped=!0}this.currentAlphaPacketIndex++,this.alphaDecoder.decode(e.alphaToEncodedVideoChunk(t??e.type)),this.alphaDecoderQueueSize++}else this.pushNullAlphaFrame()}pushNullAlphaFrame(){this.alphaDecoderQueueSize===0?this.alphaQueue.push(null):this.nullAlphaFrameQueue.push(this.decodedAlphaChunkCount+this.alphaDecoderQueueSize)}hasHevcRaslPicture(e){return tr(e,this.decoderConfig).some(a=>{const n=ne(a);return n===H.RASL_N||n===H.RASL_R})}sampleHandler(e){if(ut()){if(this.sampleQueue.length>0&&e.timestamp>=J(this.sampleQueue).timestamp){for(const t of this.sampleQueue)this.finalizeAndEmitSample(t);this.sampleQueue.length=0}Ut(this.sampleQueue,e,t=>t.timestamp)}else{const t=this.inputTimestamps.shift();p(t!==void 0),e.setTimestamp(t),this.finalizeAndEmitSample(e)}}finalizeAndEmitSample(e){e.setTimestamp(Math.round(e.timestamp*this.timeResolution)/this.timeResolution),e.setDuration(Math.round(e.duration*this.timeResolution)/this.timeResolution),e.setRotation(this.rotation),this.onSample(e)}mergeAlpha(e,t){if(!t){const s=new ie(e);this.sampleHandler(s);return}p(this.merger),this.merger.update(e,t),e.close(),t.close();const a=new VideoFrame(this.merger.canvas,{timestamp:e.timestamp,duration:e.duration??void 0}),n=new ie(a);this.sampleHandler(n)}async flush(){if(this.customDecoder?await this.customDecoderCallSerializer.call(()=>this.customDecoder.flush()):(p(this.decoder),await Promise.all([this.decoder.flush(),this.alphaDecoder?.flush()]),this.colorQueue.forEach(e=>e.close()),this.colorQueue.length=0,this.alphaQueue.forEach(e=>e?.close()),this.alphaQueue.length=0,this.alphaHadKeyframe=!1,this.decodedAlphaChunkCount=0,this.alphaDecoderQueueSize=0,this.nullAlphaFrameQueue.length=0,this.currentAlphaPacketIndex=0,this.alphaRaslSkipped=!1),ut()){for(const e of this.sampleQueue)this.finalizeAndEmitSample(e);this.sampleQueue.length=0}this.currentPacketIndex=0,this.raslSkipped=!1}close(){this.customDecoder?this.customDecoderCallSerializer.call(()=>this.customDecoder.close()):(p(this.decoder),this.decoder.close(),this.alphaDecoder?.close(),this.colorQueue.forEach(e=>e.close()),this.colorQueue.length=0,this.alphaQueue.forEach(e=>e?.close()),this.alphaQueue.length=0,this.merger?.close());for(const e of this.sampleQueue)e.close();this.sampleQueue.length=0}}class sa{constructor(){typeof OffscreenCanvas<"u"?this.canvas=new OffscreenCanvas(300,150):this.canvas=document.createElement("canvas");const e=this.canvas.getContext("webgl2",{premultipliedAlpha:!1});if(!e)throw new Error("Couldn't acquire WebGL 2 context.");this.gl=e,this.program=this.createProgram(),this.vao=this.createVAO(),this.colorTexture=this.createTexture(),this.alphaTexture=this.createTexture(),this.gl.useProgram(this.program),this.gl.uniform1i(this.gl.getUniformLocation(this.program,"u_colorTexture"),0),this.gl.uniform1i(this.gl.getUniformLocation(this.program,"u_alphaTexture"),1)}createProgram(){const e=this.createShader(this.gl.VERTEX_SHADER,`#version 300 es
			in vec2 a_position;
			in vec2 a_texCoord;
			out vec2 v_texCoord;
			
			void main() {
				gl_Position = vec4(a_position, 0.0, 1.0);
				v_texCoord = a_texCoord;
			}
		`),t=this.createShader(this.gl.FRAGMENT_SHADER,`#version 300 es
			precision highp float;
			
			uniform sampler2D u_colorTexture;
			uniform sampler2D u_alphaTexture;
			in vec2 v_texCoord;
			out vec4 fragColor;
			
			void main() {
				vec3 color = texture(u_colorTexture, v_texCoord).rgb;
				float alpha = texture(u_alphaTexture, v_texCoord).r;
				fragColor = vec4(color, alpha);
			}
		`),a=this.gl.createProgram();return this.gl.attachShader(a,e),this.gl.attachShader(a,t),this.gl.linkProgram(a),a}createShader(e,t){const a=this.gl.createShader(e);return this.gl.shaderSource(a,t),this.gl.compileShader(a),a}createVAO(){const e=this.gl.createVertexArray();this.gl.bindVertexArray(e);const t=new Float32Array([-1,-1,0,1,1,-1,1,1,-1,1,0,0,1,1,1,0]),a=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,a),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.STATIC_DRAW);const n=this.gl.getAttribLocation(this.program,"a_position"),s=this.gl.getAttribLocation(this.program,"a_texCoord");return this.gl.enableVertexAttribArray(n),this.gl.vertexAttribPointer(n,2,this.gl.FLOAT,!1,16,0),this.gl.enableVertexAttribArray(s),this.gl.vertexAttribPointer(s,2,this.gl.FLOAT,!1,16,8),e}createTexture(){const e=this.gl.createTexture();return this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),e}update(e,t){(e.displayWidth!==this.canvas.width||e.displayHeight!==this.canvas.height)&&(this.canvas.width=e.displayWidth,this.canvas.height=e.displayHeight),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.colorTexture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),this.gl.activeTexture(this.gl.TEXTURE1),this.gl.bindTexture(this.gl.TEXTURE_2D,this.alphaTexture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t),this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.bindVertexArray(this.vao),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}close(){this.gl.getExtension("WEBGL_lose_context")?.loseContext(),this.gl=null}}class oa extends na{constructor(e){if(!(e instanceof Ye))throw new TypeError("videoTrack must be an InputVideoTrack.");super(),this._track=e}async _createDecoder(e,t){if(!await this._track.canDecode())throw new Error("This video track cannot be decoded by this browser. Make sure to check decodability before using a track.");const a=this._track.codec,n=this._track.rotation,s=await this._track.getDecoderConfig(),i=this._track.timeResolution;return p(a&&s),new ia(e,t,a,s,n,i)}_createPacketSink(){return new cr(this._track)}async getSample(e){ye(e);for await(const t of this.mediaSamplesAtTimestamps([e]))return t;throw new Error("Internal error: Iterator returned nothing.")}samples(e=0,t=1/0){return this.mediaSamplesInRange(e,t)}samplesAtTimestamps(e){return this.mediaSamplesAtTimestamps(e)}}class gt{constructor(e,t){this.input=e,this._backing=t}isVideoTrack(){return this instanceof Ye}isAudioTrack(){return this instanceof se}get id(){return this._backing.getId()}get internalCodecId(){return this._backing.getInternalCodecId()}get languageCode(){return this._backing.getLanguageCode()}get name(){return this._backing.getName()}get timeResolution(){return this._backing.getTimeResolution()}getFirstTimestamp(){return this._backing.getFirstTimestamp()}computeDuration(){return this._backing.computeDuration()}async computePacketStats(e=1/0){const t=new cr(this);let a=1/0,n=-1/0,s=0,i=0;for await(const o of t.packets(void 0,void 0,{metadataOnly:!0})){if(s>=e&&o.timestamp>=n)break;a=Math.min(a,o.timestamp),n=Math.max(n,o.timestamp+o.duration),s++,i+=o.byteLength}return{packetCount:s,averagePacketRate:s?Number((s/(n-a)).toPrecision(16)):0,averageBitrate:s?Number((8*i/(n-a)).toPrecision(16)):0}}}class Ye extends gt{constructor(e,t){super(e,t),this._backing=t}get type(){return"video"}get codec(){return this._backing.getCodec()}get codedWidth(){return this._backing.getCodedWidth()}get codedHeight(){return this._backing.getCodedHeight()}get rotation(){return this._backing.getRotation()}get displayWidth(){return this._backing.getRotation()%180===0?this._backing.getCodedWidth():this._backing.getCodedHeight()}get displayHeight(){return this._backing.getRotation()%180===0?this._backing.getCodedHeight():this._backing.getCodedWidth()}getColorSpace(){return this._backing.getColorSpace()}async hasHighDynamicRange(){const e=await this._backing.getColorSpace();return e.primaries==="bt2020"||e.primaries==="smpte432"||e.transfer==="pg"||e.transfer==="hlg"||e.matrix==="bt2020-ncl"}canBeTransparent(){return this._backing.canBeTransparent()}getDecoderConfig(){return this._backing.getDecoderConfig()}async getCodecParameterString(){return(await this._backing.getDecoderConfig())?.codec??null}async canDecode(){try{const e=await this._backing.getDecoderConfig();if(!e)return!1;const t=this._backing.getCodec();return p(t!==null),or.some(n=>n.supports(t,e))?!0:typeof VideoDecoder>"u"?!1:(await VideoDecoder.isConfigSupported(e)).supported===!0}catch(e){return console.error("Error during decodability check:",e),!1}}async determinePacketType(e){if(!(e instanceof O))throw new TypeError("packet must be an EncodedPacket.");if(e.isMetadataOnly)throw new TypeError("packet must not be metadata-only to determine its type.");if(this.codec===null)return null;const t=await this.getDecoderConfig();return p(t),sr(this.codec,t,e.data)}}class se extends gt{constructor(e,t){super(e,t),this._backing=t}get type(){return"audio"}get codec(){return this._backing.getCodec()}get numberOfChannels(){return this._backing.getNumberOfChannels()}get sampleRate(){return this._backing.getSampleRate()}getDecoderConfig(){return this._backing.getDecoderConfig()}async getCodecParameterString(){return(await this._backing.getDecoderConfig())?.codec??null}async canDecode(){try{const e=await this._backing.getDecoderConfig();if(!e)return!1;const t=this._backing.getCodec();return p(t!==null),ea.some(a=>a.supports(t,e))||e.codec.startsWith("pcm-")?!0:typeof AudioDecoder>"u"?!1:(await AudioDecoder.isConfigSupported(e)).supported===!0}catch(e){return console.error("Error during decodability check:",e),!1}}async determinePacketType(e){if(!(e instanceof O))throw new TypeError("packet must be an EncodedPacket.");return this.codec===null?null:"key"}}const ca=r=>{let t=(r.hasVideo?"video/":r.hasAudio?"audio/":"application/")+(r.isQuickTime?"quicktime":"mp4");if(r.codecStrings.length>0){const a=[...new Set(r.codecStrings)];t+=`; codecs="${a.join(", ")}"`}return t};const we=8,Oe=16,oe=r=>{let e=P(r);const t=M(r,4);let a=8;e===1&&(e=G(r),a=16);const s=e-a;return s<0?null:{name:t,totalSize:e,headerSize:a,contentSize:s}},fe=r=>me(r)/65536,kt=r=>me(r)/1073741824,bt=r=>{let e=0;for(let t=0;t<4;t++){e<<=7;const a=D(r);if(e|=a&127,(a&128)===0)break}return e},Z=r=>{let e=U(r);return r.skip(2),e=Math.min(e,r.remainingLength),K.decode(F(r,e))},la=r=>{const e=oe(r);if(!e||e.name!=="data"||r.remainingLength<8)return null;const t=P(r);r.skip(4);const a=F(r,e.contentSize-8);switch(t){case 1:return K.decode(a);case 2:return new TextDecoder("utf-16be").decode(a);case 13:return new Qe(a,"image/jpeg");case 14:return new Qe(a,"image/png");case 27:return new Qe(a,"image/bmp");default:return a}};class ua extends de{constructor(e){super(e),this.moovSlice=null,this.currentTrack=null,this.tracks=[],this.metadataPromise=null,this.movieTimescale=-1,this.movieDurationInTimescale=-1,this.isQuickTime=!1,this.metadataTags={},this.currentMetadataKeys=null,this.isFragmented=!1,this.fragmentTrackDefaults=[],this.currentFragment=null,this.lastReadFragment=null,this.reader=e._reader}async computeDuration(){const e=await this.getTracks(),t=await Promise.all(e.map(a=>a.computeDuration()));return Math.max(0,...t)}async getTracks(){return await this.readMetadata(),this.tracks.map(e=>e.inputTrack)}async getMimeType(){await this.readMetadata();const e=await Promise.all(this.tracks.map(t=>t.inputTrack.getCodecParameterString()));return ca({isQuickTime:this.isQuickTime,hasVideo:this.tracks.some(t=>t.info?.type==="video"),hasAudio:this.tracks.some(t=>t.info?.type==="audio"),codecStrings:e.filter(Boolean)})}async getMetadataTags(){return await this.readMetadata(),this.metadataTags}readMetadata(){return this.metadataPromise??=(async()=>{let e=0;for(;;){let t=this.reader.requestSliceRange(e,we,Oe);if(t instanceof Promise&&(t=await t),!t)break;const a=e,n=oe(t);if(!n)break;if(n.name==="ftyp"){const s=M(t,4);this.isQuickTime=s==="qt  "}else if(n.name==="moov"){let s=this.reader.requestSlice(t.filePos,n.contentSize);if(s instanceof Promise&&(s=await s),!s)break;this.moovSlice=s,this.readContiguousBoxes(this.moovSlice);for(const i of this.tracks){const o=i.editListPreviousSegmentDurations/this.movieTimescale;i.editListOffset-=Math.round(o*i.timescale)}break}e=a+n.totalSize}if(this.isFragmented&&this.reader.fileSize!==null){let t=this.reader.requestSlice(this.reader.fileSize-4,4);t instanceof Promise&&(t=await t),p(t);const a=P(t),n=this.reader.fileSize-a;if(n>=0&&n<=this.reader.fileSize-Oe){let s=this.reader.requestSliceRange(n,we,Oe);if(s instanceof Promise&&(s=await s),s){const i=oe(s);if(i&&i.name==="mfra"){let o=this.reader.requestSlice(s.filePos,i.contentSize);o instanceof Promise&&(o=await o),o&&this.readContiguousBoxes(o)}}}}})()}getSampleTableForTrack(e){if(e.sampleTable)return e.sampleTable;const t={sampleTimingEntries:[],sampleCompositionTimeOffsets:[],sampleSizes:[],keySampleIndices:null,chunkOffsets:[],sampleToChunk:[],presentationTimestamps:null,presentationTimestampIndexMap:null};e.sampleTable=t,p(this.moovSlice);const a=this.moovSlice.slice(e.sampleTableByteOffset);if(this.currentTrack=e,this.traverseBox(a),this.currentTrack=null,e.info?.type==="audio"&&e.info.codec&&ft.includes(e.info.codec)&&t.sampleCompositionTimeOffsets.length===0){p(e.info?.type==="audio");const s=Vr(e.info.codec),i=[],o=[];for(let c=0;c<t.sampleToChunk.length;c++){const l=t.sampleToChunk[c],d=t.sampleToChunk[c+1],u=(d?d.startChunkIndex:t.chunkOffsets.length)-l.startChunkIndex;for(let f=0;f<u;f++){const h=l.startSampleIndex+f*l.samplesPerChunk,m=h+l.samplesPerChunk,k=z(t.sampleTimingEntries,h,C=>C.startIndex),b=t.sampleTimingEntries[k],T=z(t.sampleTimingEntries,m,C=>C.startIndex),g=t.sampleTimingEntries[T],w=b.startDecodeTimestamp+(h-b.startIndex)*b.delta,I=g.startDecodeTimestamp+(m-g.startIndex)*g.delta-w,v=J(i);v&&v.delta===I?v.count++:i.push({startIndex:l.startChunkIndex+f,startDecodeTimestamp:w,count:1,delta:I});const x=l.samplesPerChunk*s.sampleSize*e.info.numberOfChannels;o.push(x)}l.startSampleIndex=l.startChunkIndex,l.samplesPerChunk=1}t.sampleTimingEntries=i,t.sampleSizes=o}if(t.sampleCompositionTimeOffsets.length>0){t.presentationTimestamps=[];for(const s of t.sampleTimingEntries)for(let i=0;i<s.count;i++)t.presentationTimestamps.push({presentationTimestamp:s.startDecodeTimestamp+i*s.delta,sampleIndex:s.startIndex+i});for(const s of t.sampleCompositionTimeOffsets)for(let i=0;i<s.count;i++){const o=s.startIndex+i,c=t.presentationTimestamps[o];c&&(c.presentationTimestamp+=s.offset)}t.presentationTimestamps.sort((s,i)=>s.presentationTimestamp-i.presentationTimestamp),t.presentationTimestampIndexMap=Array(t.presentationTimestamps.length).fill(-1);for(let s=0;s<t.presentationTimestamps.length;s++)t.presentationTimestampIndexMap[t.presentationTimestamps[s].sampleIndex]=s}return t}async readFragment(e){if(this.lastReadFragment?.moofOffset===e)return this.lastReadFragment;let t=this.reader.requestSliceRange(e,we,Oe);t instanceof Promise&&(t=await t),p(t);const a=oe(t);p(a?.name==="moof");let n=this.reader.requestSlice(e,a.totalSize);n instanceof Promise&&(n=await n),p(n),this.traverseBox(n);const s=this.lastReadFragment;p(s&&s.moofOffset===e);for(const[,i]of s.trackData){const o=i.track,{fragmentPositionCache:c}=o;if(!i.startTimestampIsFinal){const d=o.fragmentLookupTable.find(u=>u.moofOffset===s.moofOffset);if(d)Tt(i,d.timestamp);else{const u=z(c,s.moofOffset-1,f=>f.moofOffset);if(u!==-1){const f=c[u];Tt(i,f.endTimestamp)}}i.startTimestampIsFinal=!0}const l=z(c,i.startTimestamp,d=>d.startTimestamp);(l===-1||c[l].moofOffset!==s.moofOffset)&&c.splice(l+1,0,{moofOffset:s.moofOffset,startTimestamp:i.startTimestamp,endTimestamp:i.endTimestamp})}return s}readContiguousBoxes(e){const t=e.filePos;for(;e.filePos-t<=e.length-we&&this.traverseBox(e););}*iterateContiguousBoxes(e){const t=e.filePos;for(;e.filePos-t<=e.length-we;){const a=e.filePos,n=oe(e);if(!n)break;yield{boxInfo:n,slice:e},e.filePos=a+n.totalSize}}traverseBox(e){const t=e.filePos,a=oe(e);if(!a)return!1;const n=e.filePos,s=t+a.totalSize;switch(a.name){case"mdia":case"minf":case"dinf":case"mfra":case"edts":this.readContiguousBoxes(e.slice(n,a.contentSize));break;case"mvhd":{const i=D(e);e.skip(3),i===1?(e.skip(16),this.movieTimescale=P(e),this.movieDurationInTimescale=G(e)):(e.skip(8),this.movieTimescale=P(e),this.movieDurationInTimescale=P(e))}break;case"trak":{const i={id:-1,demuxer:this,inputTrack:null,info:null,timescale:-1,durationInMovieTimescale:-1,durationInMediaTimescale:-1,rotation:0,internalCodecId:null,name:null,languageCode:Q,sampleTableByteOffset:-1,sampleTable:null,fragmentLookupTable:[],currentFragmentState:null,fragmentPositionCache:[],editListPreviousSegmentDurations:0,editListOffset:0};if(this.currentTrack=i,this.readContiguousBoxes(e.slice(n,a.contentSize)),i.id!==-1&&i.timescale!==-1&&i.info!==null){if(i.info.type==="video"&&i.info.width!==-1){const o=i;i.inputTrack=new Ye(this.input,new da(o)),this.tracks.push(i)}else if(i.info.type==="audio"&&i.info.numberOfChannels!==-1){const o=i;i.inputTrack=new se(this.input,new fa(o)),this.tracks.push(i)}}this.currentTrack=null}break;case"tkhd":{const i=this.currentTrack;if(!i)break;const o=D(e);if(!((Ae(e)&1)!==0))break;if(o===0)e.skip(8),i.id=P(e),e.skip(4),i.durationInMovieTimescale=P(e);else if(o===1)e.skip(16),i.id=P(e),e.skip(4),i.durationInMovieTimescale=G(e);else throw new Error(`Incorrect track header version ${o}.`);e.skip(16);const d=[fe(e),fe(e),kt(e),fe(e),fe(e),kt(e),fe(e),fe(e),kt(e)],u=Ft(Er(ga(d),90));p(u===0||u===90||u===180||u===270),i.rotation=u}break;case"elst":{const i=this.currentTrack;if(!i)break;const o=D(e);e.skip(3);let c=!1,l=0;const d=P(e);for(let u=0;u<d;u++){const f=o===1?G(e):P(e),h=o===1?_n(e):me(e),m=fe(e);if(f!==0){if(c){console.warn("Unsupported edit list: multiple edits are not currently supported. Only using first edit.");break}if(h===-1){l+=f;continue}if(m!==1){console.warn("Unsupported edit list entry: media rate must be 1.");break}i.editListPreviousSegmentDurations=l,i.editListOffset=h,c=!0}}}break;case"mdhd":{const i=this.currentTrack;if(!i)break;const o=D(e);e.skip(3),o===0?(e.skip(8),i.timescale=P(e),i.durationInMediaTimescale=P(e)):o===1&&(e.skip(16),i.timescale=P(e),i.durationInMediaTimescale=G(e));let c=U(e);if(c>0){i.languageCode="";for(let l=0;l<3;l++)i.languageCode=String.fromCharCode(96+(c&31))+i.languageCode,c>>=5;Wt(i.languageCode)||(i.languageCode=Q)}}break;case"hdlr":{const i=this.currentTrack;if(!i)break;e.skip(8);const o=M(e,4);o==="vide"?i.info={type:"video",width:-1,height:-1,codec:null,codecDescription:null,colorSpace:null,avcCodecInfo:null,hevcCodecInfo:null,vp9CodecInfo:null,av1CodecInfo:null}:o==="soun"&&(i.info={type:"audio",numberOfChannels:-1,sampleRate:-1,codec:null,codecDescription:null,aacCodecInfo:null})}break;case"stbl":{const i=this.currentTrack;if(!i)break;i.sampleTableByteOffset=t,this.readContiguousBoxes(e.slice(n,a.contentSize))}break;case"stsd":{const i=this.currentTrack;if(!i||i.info===null||i.sampleTable)break;const o=D(e);e.skip(3);const c=P(e);for(let l=0;l<c;l++){const d=e.filePos,u=oe(e);if(!u)break;i.internalCodecId=u.name;const f=u.name.toLowerCase();if(i.info.type==="video")f==="avc1"?i.info.codec="avc":f==="hvc1"||f==="hev1"?i.info.codec="hevc":f==="vp08"?i.info.codec="vp8":f==="vp09"?i.info.codec="vp9":f==="av01"?i.info.codec="av1":console.warn(`Unsupported video codec (sample entry type '${u.name}').`),e.skip(24),i.info.width=U(e),i.info.height=U(e),e.skip(50),this.readContiguousBoxes(e.slice(e.filePos,d+u.totalSize-e.filePos));else{f==="mp4a"||(f==="opus"?i.info.codec="opus":f==="flac"?i.info.codec="flac":f==="twos"||f==="sowt"||f==="raw "||f==="in24"||f==="in32"||f==="fl32"||f==="fl64"||f==="lpcm"||f==="ipcm"||f==="fpcm"||(f==="ulaw"?i.info.codec="ulaw":f==="alaw"?i.info.codec="alaw":console.warn(`Unsupported audio codec (sample entry type '${u.name}').`))),e.skip(8);const h=U(e);e.skip(6);let m=U(e),k=U(e);e.skip(4);let b=P(e)/65536;if(o===0&&h>0){if(h===1)e.skip(4),k=8*P(e),e.skip(8);else if(h===2){e.skip(4),b=vr(e),m=P(e),e.skip(4),k=P(e);const T=P(e);if(e.skip(8),f==="lpcm"){const g=k+7>>3,w=!!(T&1),y=!!(T&2),I=T&4?-1:0;k>0&&k<=64&&(w?k===32&&(i.info.codec=y?"pcm-f32be":"pcm-f32"):I&1<<g-1?g===1?i.info.codec="pcm-s8":g===2?i.info.codec=y?"pcm-s16be":"pcm-s16":g===3?i.info.codec=y?"pcm-s24be":"pcm-s24":g===4&&(i.info.codec=y?"pcm-s32be":"pcm-s32"):g===1&&(i.info.codec="pcm-u8")),i.info.codec===null&&console.warn("Unsupported PCM format.")}}}i.info.codec==="opus"&&(b=Ge),i.info.numberOfChannels=m,i.info.sampleRate=b,f==="twos"?k===8?i.info.codec="pcm-s8":k===16?i.info.codec="pcm-s16be":(console.warn(`Unsupported sample size ${k} for codec 'twos'.`),i.info.codec=null):f==="sowt"?k===8?i.info.codec="pcm-s8":k===16?i.info.codec="pcm-s16":(console.warn(`Unsupported sample size ${k} for codec 'sowt'.`),i.info.codec=null):f==="raw "?i.info.codec="pcm-u8":f==="in24"?i.info.codec="pcm-s24be":f==="in32"?i.info.codec="pcm-s32be":f==="fl32"?i.info.codec="pcm-f32be":f==="fl64"?i.info.codec="pcm-f64be":f==="ipcm"?i.info.codec="pcm-s16be":f==="fpcm"&&(i.info.codec="pcm-f32be"),this.readContiguousBoxes(e.slice(e.filePos,d+u.totalSize-e.filePos))}}}break;case"avcC":{const i=this.currentTrack;if(!i)break;p(i.info),i.info.codecDescription=F(e,a.contentSize)}break;case"hvcC":{const i=this.currentTrack;if(!i)break;p(i.info),i.info.codecDescription=F(e,a.contentSize)}break;case"vpcC":{const i=this.currentTrack;if(!i)break;p(i.info?.type==="video"),e.skip(4);const o=D(e),c=D(e),l=D(e),d=l>>4,u=l>>1&7,f=l&1,h=D(e),m=D(e),k=D(e);i.info.vp9CodecInfo={profile:o,level:c,bitDepth:d,chromaSubsampling:u,videoFullRangeFlag:f,colourPrimaries:h,transferCharacteristics:m,matrixCoefficients:k}}break;case"av1C":{const i=this.currentTrack;if(!i)break;p(i.info?.type==="video"),e.skip(1);const o=D(e),c=o>>5,l=o&31,d=D(e),u=d>>7,f=d>>6&1,h=d>>5&1,m=d>>4&1,k=d>>3&1,b=d>>2&1,T=d&3,g=c===2&&f?h?12:10:f?10:8;i.info.av1CodecInfo={profile:c,level:l,tier:u,bitDepth:g,monochrome:m,chromaSubsamplingX:k,chromaSubsamplingY:b,chromaSamplePosition:T}}break;case"colr":{const i=this.currentTrack;if(!i||(p(i.info?.type==="video"),M(e,4)!=="nclx"))break;const c=U(e),l=U(e),d=U(e),u=!!(D(e)&128);i.info.colorSpace={primaries:Et[c],transfer:Rt[l],matrix:Nt[d],fullRange:u}}break;case"wave":this.readContiguousBoxes(e.slice(n,a.contentSize));break;case"esds":{const i=this.currentTrack;if(!i)break;p(i.info?.type==="audio"),e.skip(4);const o=D(e);p(o===3),bt(e),e.skip(2);const c=D(e),l=(c&128)!==0,d=(c&64)!==0,u=(c&32)!==0;if(l&&e.skip(2),d){const b=D(e);e.skip(b)}u&&e.skip(2);const f=D(e);p(f===4);const h=bt(e),m=e.filePos,k=D(e);if(k===64||k===103?(i.info.codec="aac",i.info.aacCodecInfo={isMpeg2:k===103}):k===105||k===107?i.info.codec="mp3":k===221?i.info.codec="vorbis":console.warn(`Unsupported audio codec (objectTypeIndication ${k}) - discarding track.`),e.skip(12),h>e.filePos-m){const b=D(e);p(b===5);const T=bt(e);if(i.info.codecDescription=F(e,T),i.info.codec==="aac"){const g=Jt(i.info.codecDescription);g.numberOfChannels!==null&&(i.info.numberOfChannels=g.numberOfChannels),g.sampleRate!==null&&(i.info.sampleRate=g.sampleRate)}}}break;case"enda":{const i=this.currentTrack;if(!i)break;p(i.info?.type==="audio"),U(e)&255&&(i.info.codec==="pcm-s16be"?i.info.codec="pcm-s16":i.info.codec==="pcm-s24be"?i.info.codec="pcm-s24":i.info.codec==="pcm-s32be"?i.info.codec="pcm-s32":i.info.codec==="pcm-f32be"?i.info.codec="pcm-f32":i.info.codec==="pcm-f64be"&&(i.info.codec="pcm-f64"))}break;case"pcmC":{const i=this.currentTrack;if(!i)break;p(i.info?.type==="audio"),e.skip(4);const c=!!(D(e)&1),l=D(e);i.info.codec==="pcm-s16be"?c?l===16?i.info.codec="pcm-s16":l===24?i.info.codec="pcm-s24":l===32?i.info.codec="pcm-s32":(console.warn(`Invalid ipcm sample size ${l}.`),i.info.codec=null):l===16?i.info.codec="pcm-s16be":l===24?i.info.codec="pcm-s24be":l===32?i.info.codec="pcm-s32be":(console.warn(`Invalid ipcm sample size ${l}.`),i.info.codec=null):i.info.codec==="pcm-f32be"&&(c?l===32?i.info.codec="pcm-f32":l===64?i.info.codec="pcm-f64":(console.warn(`Invalid fpcm sample size ${l}.`),i.info.codec=null):l===32?i.info.codec="pcm-f32be":l===64?i.info.codec="pcm-f64be":(console.warn(`Invalid fpcm sample size ${l}.`),i.info.codec=null));break}case"dOps":{const i=this.currentTrack;if(!i)break;p(i.info?.type==="audio"),e.skip(1);const o=D(e),c=U(e),l=P(e),d=Dt(e),u=D(e);let f;u!==0?f=F(e,2+o):f=new Uint8Array(0);const h=new Uint8Array(19+f.byteLength),m=new DataView(h.buffer);m.setUint32(0,1332770163,!1),m.setUint32(4,1214603620,!1),m.setUint8(8,1),m.setUint8(9,o),m.setUint16(10,c,!0),m.setUint32(12,l,!0),m.setInt16(16,d,!0),m.setUint8(18,u),h.set(f,19),i.info.codecDescription=h,i.info.numberOfChannels=o}break;case"dfLa":{const i=this.currentTrack;if(!i)break;p(i.info?.type==="audio"),e.skip(4);const o=127,c=128,l=e.filePos;for(;e.filePos<s;){const m=D(e),k=Ae(e);if((m&o)===Te.STREAMINFO){e.skip(10);const T=P(e),g=T>>>12,w=(T>>9&7)+1;i.info.sampleRate=g,i.info.numberOfChannels=w,e.skip(20)}else e.skip(k);if(m&c)break}const d=e.filePos;e.filePos=l;const u=F(e,d-l),f=new Uint8Array(4+u.byteLength);new DataView(f.buffer).setUint32(0,1716281667,!1),f.set(u,4),i.info.codecDescription=f}break;case"stts":{const i=this.currentTrack;if(!i||!i.sampleTable)break;e.skip(4);const o=P(e);let c=0,l=0;for(let d=0;d<o;d++){const u=P(e),f=P(e);i.sampleTable.sampleTimingEntries.push({startIndex:c,startDecodeTimestamp:l,count:u,delta:f}),c+=u,l+=u*f}}break;case"ctts":{const i=this.currentTrack;if(!i||!i.sampleTable)break;e.skip(4);const o=P(e);let c=0;for(let l=0;l<o;l++){const d=P(e),u=me(e);i.sampleTable.sampleCompositionTimeOffsets.push({startIndex:c,count:d,offset:u}),c+=d}}break;case"stsz":{const i=this.currentTrack;if(!i||!i.sampleTable)break;e.skip(4);const o=P(e),c=P(e);if(o===0)for(let l=0;l<c;l++){const d=P(e);i.sampleTable.sampleSizes.push(d)}else i.sampleTable.sampleSizes.push(o)}break;case"stz2":{const i=this.currentTrack;if(!i||!i.sampleTable)break;e.skip(4),e.skip(3);const o=D(e),c=P(e),l=F(e,Math.ceil(c*o/8)),d=new N(l);for(let u=0;u<c;u++){const f=d.readBits(o);i.sampleTable.sampleSizes.push(f)}}break;case"stss":{const i=this.currentTrack;if(!i||!i.sampleTable)break;e.skip(4),i.sampleTable.keySampleIndices=[];const o=P(e);for(let c=0;c<o;c++){const l=P(e)-1;i.sampleTable.keySampleIndices.push(l)}i.sampleTable.keySampleIndices[0]!==0&&i.sampleTable.keySampleIndices.unshift(0)}break;case"stsc":{const i=this.currentTrack;if(!i||!i.sampleTable)break;e.skip(4);const o=P(e);for(let l=0;l<o;l++){const d=P(e)-1,u=P(e),f=P(e);i.sampleTable.sampleToChunk.push({startSampleIndex:-1,startChunkIndex:d,samplesPerChunk:u,sampleDescriptionIndex:f})}let c=0;for(let l=0;l<i.sampleTable.sampleToChunk.length;l++)if(i.sampleTable.sampleToChunk[l].startSampleIndex=c,l<i.sampleTable.sampleToChunk.length-1){const u=i.sampleTable.sampleToChunk[l+1].startChunkIndex-i.sampleTable.sampleToChunk[l].startChunkIndex;c+=u*i.sampleTable.sampleToChunk[l].samplesPerChunk}}break;case"stco":{const i=this.currentTrack;if(!i||!i.sampleTable)break;e.skip(4);const o=P(e);for(let c=0;c<o;c++){const l=P(e);i.sampleTable.chunkOffsets.push(l)}}break;case"co64":{const i=this.currentTrack;if(!i||!i.sampleTable)break;e.skip(4);const o=P(e);for(let c=0;c<o;c++){const l=G(e);i.sampleTable.chunkOffsets.push(l)}}break;case"mvex":this.isFragmented=!0,this.readContiguousBoxes(e.slice(n,a.contentSize));break;case"mehd":{const i=D(e);e.skip(3);const o=i===1?G(e):P(e);this.movieDurationInTimescale=o}break;case"trex":{e.skip(4);const i=P(e),o=P(e),c=P(e),l=P(e),d=P(e);this.fragmentTrackDefaults.push({trackId:i,defaultSampleDescriptionIndex:o,defaultSampleDuration:c,defaultSampleSize:l,defaultSampleFlags:d})}break;case"tfra":{const i=D(e);e.skip(3);const o=P(e),c=this.tracks.find(g=>g.id===o);if(!c)break;const l=P(e),d=(l&48)>>4,u=(l&12)>>2,f=l&3,h=[D,U,Ae,P],m=h[d],k=h[u],b=h[f],T=P(e);for(let g=0;g<T;g++){const w=i===1?G(e):P(e),y=i===1?G(e):P(e);m(e),k(e),b(e),c.fragmentLookupTable.push({timestamp:w,moofOffset:y})}c.fragmentLookupTable.sort((g,w)=>g.timestamp-w.timestamp);for(let g=0;g<c.fragmentLookupTable.length-1;g++){const w=c.fragmentLookupTable[g],y=c.fragmentLookupTable[g+1];w.timestamp===y.timestamp&&(c.fragmentLookupTable.splice(g+1,1),g--)}}break;case"moof":this.currentFragment={moofOffset:t,moofSize:a.totalSize,implicitBaseDataOffset:t,trackData:new Map},this.readContiguousBoxes(e.slice(n,a.contentSize)),this.lastReadFragment=this.currentFragment,this.currentFragment=null;break;case"traf":if(p(this.currentFragment),this.readContiguousBoxes(e.slice(n,a.contentSize)),this.currentTrack){const i=this.currentFragment.trackData.get(this.currentTrack.id);if(i){const{currentFragmentState:o}=this.currentTrack;p(o),o.startTimestamp!==null&&(Tt(i,o.startTimestamp),i.startTimestampIsFinal=!0)}this.currentTrack.currentFragmentState=null,this.currentTrack=null}break;case"tfhd":{p(this.currentFragment),e.skip(1);const i=Ae(e),o=!!(i&1),c=!!(i&2),l=!!(i&8),d=!!(i&16),u=!!(i&32),f=!!(i&65536),h=!!(i&131072),m=P(e),k=this.tracks.find(T=>T.id===m);if(!k)break;const b=this.fragmentTrackDefaults.find(T=>T.trackId===m);this.currentTrack=k,k.currentFragmentState={baseDataOffset:this.currentFragment.implicitBaseDataOffset,sampleDescriptionIndex:b?.defaultSampleDescriptionIndex??null,defaultSampleDuration:b?.defaultSampleDuration??null,defaultSampleSize:b?.defaultSampleSize??null,defaultSampleFlags:b?.defaultSampleFlags??null,startTimestamp:null},o?k.currentFragmentState.baseDataOffset=G(e):h&&(k.currentFragmentState.baseDataOffset=this.currentFragment.moofOffset),c&&(k.currentFragmentState.sampleDescriptionIndex=P(e)),l&&(k.currentFragmentState.defaultSampleDuration=P(e)),d&&(k.currentFragmentState.defaultSampleSize=P(e)),u&&(k.currentFragmentState.defaultSampleFlags=P(e)),f&&(k.currentFragmentState.defaultSampleDuration=0)}break;case"tfdt":{const i=this.currentTrack;if(!i)break;p(i.currentFragmentState);const o=D(e);e.skip(3);const c=o===0?P(e):G(e);i.currentFragmentState.startTimestamp=c}break;case"trun":{const i=this.currentTrack;if(!i)break;if(p(this.currentFragment),p(i.currentFragmentState),this.currentFragment.trackData.has(i.id)){console.warn("Can't have two trun boxes for the same track in one fragment. Ignoring...");break}const o=D(e),c=Ae(e),l=!!(c&1),d=!!(c&4),u=!!(c&256),f=!!(c&512),h=!!(c&1024),m=!!(c&2048),k=P(e);let b=i.currentFragmentState.baseDataOffset;l&&(b+=me(e));let T=null;d&&(T=P(e));let g=b;if(k===0){this.currentFragment.implicitBaseDataOffset=g;break}let w=0;const y={track:i,startTimestamp:0,endTimestamp:0,firstKeyFrameTimestamp:null,samples:[],presentationTimestamps:[],startTimestampIsFinal:!1};this.currentFragment.trackData.set(i.id,y);for(let x=0;x<k;x++){let C;u?C=P(e):(p(i.currentFragmentState.defaultSampleDuration!==null),C=i.currentFragmentState.defaultSampleDuration);let A;f?A=P(e):(p(i.currentFragmentState.defaultSampleSize!==null),A=i.currentFragmentState.defaultSampleSize);let R;h?R=P(e):(p(i.currentFragmentState.defaultSampleFlags!==null),R=i.currentFragmentState.defaultSampleFlags),x===0&&T!==null&&(R=T);let B=0;m&&(o===0?B=P(e):B=me(e));const X=!(R&65536);y.samples.push({presentationTimestamp:w+B,duration:C,byteOffset:g,byteSize:A,isKeyFrame:X}),g+=A,w+=C}y.presentationTimestamps=y.samples.map((x,C)=>({presentationTimestamp:x.presentationTimestamp,sampleIndex:C})).sort((x,C)=>x.presentationTimestamp-C.presentationTimestamp);for(let x=0;x<y.presentationTimestamps.length;x++){const C=y.presentationTimestamps[x],A=y.samples[C.sampleIndex];if(y.firstKeyFrameTimestamp===null&&A.isKeyFrame&&(y.firstKeyFrameTimestamp=A.presentationTimestamp),x<y.presentationTimestamps.length-1){const R=y.presentationTimestamps[x+1];A.duration=R.presentationTimestamp-C.presentationTimestamp}}const I=y.samples[y.presentationTimestamps[0].sampleIndex],v=y.samples[J(y.presentationTimestamps).sampleIndex];y.startTimestamp=I.presentationTimestamp,y.endTimestamp=v.presentationTimestamp+v.duration,this.currentFragment.implicitBaseDataOffset=g}break;case"udta":{const i=this.iterateContiguousBoxes(e.slice(n,a.contentSize));for(const{boxInfo:o,slice:c}of i){if(o.name!=="meta"&&!this.currentTrack){const l=c.filePos;this.metadataTags.raw??={},o.name[0]===""?this.metadataTags.raw[o.name]??=Z(c):this.metadataTags.raw[o.name]??=F(c,o.contentSize),c.filePos=l}switch(o.name){case"meta":c.skip(-o.headerSize),this.traverseBox(c);break;case"nam":case"name":this.currentTrack?this.currentTrack.name=K.decode(F(c,o.contentSize)):this.metadataTags.title??=Z(c);break;case"des":this.currentTrack||(this.metadataTags.description??=Z(c));break;case"ART":this.currentTrack||(this.metadataTags.artist??=Z(c));break;case"alb":this.currentTrack||(this.metadataTags.album??=Z(c));break;case"albr":this.currentTrack||(this.metadataTags.albumArtist??=Z(c));break;case"gen":this.currentTrack||(this.metadataTags.genre??=Z(c));break;case"day":if(!this.currentTrack){const l=new Date(Z(c));Number.isNaN(l.getTime())||(this.metadataTags.date??=l)}break;case"cmt":this.currentTrack||(this.metadataTags.comment??=Z(c));break;case"lyr":this.currentTrack||(this.metadataTags.lyrics??=Z(c));break}}}break;case"meta":{if(this.currentTrack)break;const o=P(e)!==0;this.currentMetadataKeys=new Map,o?this.readContiguousBoxes(e.slice(n,a.contentSize)):this.readContiguousBoxes(e.slice(n+4,a.contentSize-4)),this.currentMetadataKeys=null}break;case"keys":{if(!this.currentMetadataKeys)break;e.skip(4);const i=P(e);for(let o=0;o<i;o++){const c=P(e);e.skip(4);const l=K.decode(F(e,c-8));this.currentMetadataKeys.set(o+1,l)}}break;case"ilst":{if(!this.currentMetadataKeys)break;const i=this.iterateContiguousBoxes(e.slice(n,a.contentSize));for(const{boxInfo:o,slice:c}of i){let l=o.name;const d=(l.charCodeAt(0)<<24)+(l.charCodeAt(1)<<16)+(l.charCodeAt(2)<<8)+l.charCodeAt(3);this.currentMetadataKeys.has(d)&&(l=this.currentMetadataKeys.get(d));const u=la(c);switch(this.metadataTags.raw??={},this.metadataTags.raw[l]??=u,l){case"nam":case"titl":case"com.apple.quicktime.title":case"title":typeof u=="string"&&(this.metadataTags.title??=u);break;case"des":case"desc":case"dscp":case"com.apple.quicktime.description":case"description":typeof u=="string"&&(this.metadataTags.description??=u);break;case"ART":case"com.apple.quicktime.artist":case"artist":typeof u=="string"&&(this.metadataTags.artist??=u);break;case"alb":case"albm":case"com.apple.quicktime.album":case"album":typeof u=="string"&&(this.metadataTags.album??=u);break;case"aART":case"album_artist":typeof u=="string"&&(this.metadataTags.albumArtist??=u);break;case"cmt":case"com.apple.quicktime.comment":case"comment":typeof u=="string"&&(this.metadataTags.comment??=u);break;case"gen":case"gnre":case"com.apple.quicktime.genre":case"genre":typeof u=="string"&&(this.metadataTags.genre??=u);break;case"lyr":case"lyrics":typeof u=="string"&&(this.metadataTags.lyrics??=u);break;case"day":case"rldt":case"com.apple.quicktime.creationdate":case"date":if(typeof u=="string"){const f=new Date(u);Number.isNaN(f.getTime())||(this.metadataTags.date??=f)}break;case"covr":case"com.apple.quicktime.artwork":u instanceof Qe?(this.metadataTags.images??=[],this.metadataTags.images.push({data:u.data,kind:"coverFront",mimeType:u.mimeType})):u instanceof Uint8Array&&(this.metadataTags.images??=[],this.metadataTags.images.push({data:u,kind:"coverFront",mimeType:"image/*"}));break;case"track":if(typeof u=="string"){const f=u.split("/"),h=Number.parseInt(f[0],10),m=f[1]&&Number.parseInt(f[1],10);Number.isInteger(h)&&h>0&&(this.metadataTags.trackNumber??=h),m&&Number.isInteger(m)&&m>0&&(this.metadataTags.tracksTotal??=m)}break;case"trkn":if(u instanceof Uint8Array&&u.length>=6){const f=V(u),h=f.getUint16(2,!1),m=f.getUint16(4,!1);h>0&&(this.metadataTags.trackNumber??=h),m>0&&(this.metadataTags.tracksTotal??=m)}break;case"disc":case"disk":if(u instanceof Uint8Array&&u.length>=6){const f=V(u),h=f.getUint16(2,!1),m=f.getUint16(4,!1);h>0&&(this.metadataTags.discNumber??=h),m>0&&(this.metadataTags.discsTotal??=m)}break}}}break}return e.filePos=s,!0}}class ur{constructor(e){this.internalTrack=e,this.packetToSampleIndex=new WeakMap,this.packetToFragmentLocation=new WeakMap}getId(){return this.internalTrack.id}getCodec(){throw new Error("Not implemented on base class.")}getInternalCodecId(){return this.internalTrack.internalCodecId}getName(){return this.internalTrack.name}getLanguageCode(){return this.internalTrack.languageCode}getTimeResolution(){return this.internalTrack.timescale}async computeDuration(){const e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}async getFirstTimestamp(){return(await this.getFirstPacket({metadataOnly:!0}))?.timestamp??0}async getFirstPacket(e){const t=await this.fetchPacketForSampleIndex(0,e);return t||!this.internalTrack.demuxer.isFragmented?t:this.performFragmentedLookup(null,a=>a.trackData.get(this.internalTrack.id)?{sampleIndex:0,correctSampleFound:!0}:{sampleIndex:-1,correctSampleFound:!1},-1/0,1/0,e)}mapTimestampIntoTimescale(e){return je(e*this.internalTrack.timescale,14)+this.internalTrack.editListOffset}async getPacket(e,t){const a=this.mapTimestampIntoTimescale(e),n=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),s=dr(n,a),i=await this.fetchPacketForSampleIndex(s,t);return!fr(n)||!this.internalTrack.demuxer.isFragmented?i:this.performFragmentedLookup(null,o=>{const c=o.trackData.get(this.internalTrack.id);if(!c)return{sampleIndex:-1,correctSampleFound:!1};const l=z(c.presentationTimestamps,a,f=>f.presentationTimestamp),d=l!==-1?c.presentationTimestamps[l].sampleIndex:-1,u=l!==-1&&a<c.endTimestamp;return{sampleIndex:d,correctSampleFound:u}},a,a,t)}async getNextPacket(e,t){const a=this.packetToSampleIndex.get(e);if(a!==void 0)return this.fetchPacketForSampleIndex(a+1,t);const n=this.packetToFragmentLocation.get(e);if(n===void 0)throw new Error("Packet was not created from this track.");return this.performFragmentedLookup(n.fragment,s=>{if(s===n.fragment){const i=s.trackData.get(this.internalTrack.id);if(n.sampleIndex+1<i.samples.length)return{sampleIndex:n.sampleIndex+1,correctSampleFound:!0}}else if(s.trackData.get(this.internalTrack.id))return{sampleIndex:0,correctSampleFound:!0};return{sampleIndex:-1,correctSampleFound:!1}},-1/0,1/0,t)}async getKeyPacket(e,t){const a=this.mapTimestampIntoTimescale(e),n=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),s=dr(n,a),i=s===-1?-1:ma(n,s),o=await this.fetchPacketForSampleIndex(i,t);return!fr(n)||!this.internalTrack.demuxer.isFragmented?o:this.performFragmentedLookup(null,c=>{const l=c.trackData.get(this.internalTrack.id);if(!l)return{sampleIndex:-1,correctSampleFound:!1};const d=Ht(l.presentationTimestamps,h=>l.samples[h.sampleIndex].isKeyFrame&&h.presentationTimestamp<=a),u=d!==-1?l.presentationTimestamps[d].sampleIndex:-1,f=d!==-1&&a<l.endTimestamp;return{sampleIndex:u,correctSampleFound:f}},a,a,t)}async getNextKeyPacket(e,t){const a=this.packetToSampleIndex.get(e);if(a!==void 0){const s=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),i=pa(s,a);return this.fetchPacketForSampleIndex(i,t)}const n=this.packetToFragmentLocation.get(e);if(n===void 0)throw new Error("Packet was not created from this track.");return this.performFragmentedLookup(n.fragment,s=>{if(s===n.fragment){const o=s.trackData.get(this.internalTrack.id).samples.findIndex((c,l)=>c.isKeyFrame&&l>n.sampleIndex);if(o!==-1)return{sampleIndex:o,correctSampleFound:!0}}else{const i=s.trackData.get(this.internalTrack.id);if(i&&i.firstKeyFrameTimestamp!==null){const o=i.samples.findIndex(c=>c.isKeyFrame);return p(o!==-1),{sampleIndex:o,correctSampleFound:!0}}}return{sampleIndex:-1,correctSampleFound:!1}},-1/0,1/0,t)}async fetchPacketForSampleIndex(e,t){if(e===-1)return null;const a=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),n=ha(a,e);if(!n)return null;let s;if(t.metadataOnly)s=j;else{let l=this.internalTrack.demuxer.reader.requestSlice(n.sampleOffset,n.sampleSize);l instanceof Promise&&(l=await l),p(l),s=F(l,n.sampleSize)}const i=(n.presentationTimestamp-this.internalTrack.editListOffset)/this.internalTrack.timescale,o=n.duration/this.internalTrack.timescale,c=new O(s,n.isKeyFrame?"key":"delta",i,o,e,n.sampleSize);return this.packetToSampleIndex.set(c,e),c}async fetchPacketInFragment(e,t,a){if(t===-1)return null;const s=e.trackData.get(this.internalTrack.id).samples[t];p(s);let i;if(a.metadataOnly)i=j;else{let d=this.internalTrack.demuxer.reader.requestSlice(s.byteOffset,s.byteSize);d instanceof Promise&&(d=await d),p(d),i=F(d,s.byteSize)}const o=(s.presentationTimestamp-this.internalTrack.editListOffset)/this.internalTrack.timescale,c=s.duration/this.internalTrack.timescale,l=new O(i,s.isKeyFrame?"key":"delta",o,c,e.moofOffset+t,s.byteSize);return this.packetToFragmentLocation.set(l,{fragment:e,sampleIndex:t}),l}async performFragmentedLookup(e,t,a,n,s){const i=this.internalTrack.demuxer;let o=null,c=null,l=-1;if(e){const{sampleIndex:b,correctSampleFound:T}=t(e);if(T)return this.fetchPacketInFragment(e,b,s);b!==-1&&(c=e,l=b)}const d=z(this.internalTrack.fragmentLookupTable,a,b=>b.timestamp),u=d!==-1?this.internalTrack.fragmentLookupTable[d]:null,f=z(this.internalTrack.fragmentPositionCache,a,b=>b.startTimestamp),h=f!==-1?this.internalTrack.fragmentPositionCache[f]:null,m=Math.max(u?.moofOffset??0,h?.moofOffset??0)||null;let k;for(e?m===null||e.moofOffset>=m?(k=e.moofOffset+e.moofSize,o=e):k=m:k=m??0;;){if(o){const w=o.trackData.get(this.internalTrack.id);if(w&&w.startTimestamp>n)break}let b=i.reader.requestSliceRange(k,we,Oe);if(b instanceof Promise&&(b=await b),!b)break;const T=k,g=oe(b);if(!g)break;if(g.name==="moof"){o=await i.readFragment(T);const{sampleIndex:w,correctSampleFound:y}=t(o);if(y)return this.fetchPacketInFragment(o,w,s);w!==-1&&(c=o,l=w)}k=T+g.totalSize}if(u&&(!c||c.moofOffset<u.moofOffset)){const b=this.internalTrack.fragmentLookupTable[d-1];p(!b||b.timestamp<u.timestamp);const T=b?.timestamp??-1/0;return this.performFragmentedLookup(null,t,T,n,s)}return c?this.fetchPacketInFragment(c,l,s):null}}class da extends ur{constructor(e){super(e),this.decoderConfigPromise=null,this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getCodedWidth(){return this.internalTrack.info.width}getCodedHeight(){return this.internalTrack.info.height}getRotation(){return this.internalTrack.rotation}async getColorSpace(){return{primaries:this.internalTrack.info.colorSpace?.primaries,transfer:this.internalTrack.info.colorSpace?.transfer,matrix:this.internalTrack.info.colorSpace?.matrix,fullRange:this.internalTrack.info.colorSpace?.fullRange}}async canBeTransparent(){return!1}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfigPromise??=(async()=>{if(this.internalTrack.info.codec==="vp9"&&!this.internalTrack.info.vp9CodecInfo){const e=await this.getFirstPacket({});this.internalTrack.info.vp9CodecInfo=e&&ar(e.data)}else if(this.internalTrack.info.codec==="av1"&&!this.internalTrack.info.av1CodecInfo){const e=await this.getFirstPacket({});this.internalTrack.info.av1CodecInfo=e&&ir(e.data)}return{codec:Xt(this.internalTrack.info),codedWidth:this.internalTrack.info.width,codedHeight:this.internalTrack.info.height,description:this.internalTrack.info.codecDescription??void 0,colorSpace:this.internalTrack.info.colorSpace??void 0}})():null}}class fa extends ur{constructor(e){super(e),this.decoderConfig=null,this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getNumberOfChannels(){return this.internalTrack.info.numberOfChannels}getSampleRate(){return this.internalTrack.info.sampleRate}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfig??={codec:Zt(this.internalTrack.info),numberOfChannels:this.internalTrack.info.numberOfChannels,sampleRate:this.internalTrack.info.sampleRate,description:this.internalTrack.info.codecDescription??void 0}:null}}const dr=(r,e)=>{if(r.presentationTimestamps){const t=z(r.presentationTimestamps,e,a=>a.presentationTimestamp);return t===-1?-1:r.presentationTimestamps[t].sampleIndex}else{const t=z(r.sampleTimingEntries,e,n=>n.startDecodeTimestamp);if(t===-1)return-1;const a=r.sampleTimingEntries[t];return a.startIndex+Math.min(Math.floor((e-a.startDecodeTimestamp)/a.delta),a.count-1)}},ha=(r,e)=>{const t=z(r.sampleTimingEntries,e,T=>T.startIndex),a=r.sampleTimingEntries[t];if(!a||a.startIndex+a.count<=e)return null;let s=a.startDecodeTimestamp+(e-a.startIndex)*a.delta;const i=z(r.sampleCompositionTimeOffsets,e,T=>T.startIndex),o=r.sampleCompositionTimeOffsets[i];o&&e-o.startIndex<o.count&&(s+=o.offset);const c=r.sampleSizes[Math.min(e,r.sampleSizes.length-1)],l=z(r.sampleToChunk,e,T=>T.startSampleIndex),d=r.sampleToChunk[l];p(d);const u=d.startChunkIndex+Math.floor((e-d.startSampleIndex)/d.samplesPerChunk),f=r.chunkOffsets[u],h=d.startSampleIndex+(u-d.startChunkIndex)*d.samplesPerChunk;let m=0,k=f;if(r.sampleSizes.length===1)k+=c*(e-h),m+=c*d.samplesPerChunk;else for(let T=h;T<h+d.samplesPerChunk;T++){const g=r.sampleSizes[T];T<e&&(k+=g),m+=g}let b=a.delta;if(r.presentationTimestamps){const T=r.presentationTimestampIndexMap[e];p(T!==void 0),T<r.presentationTimestamps.length-1&&(b=r.presentationTimestamps[T+1].presentationTimestamp-s)}return{presentationTimestamp:s,duration:b,sampleOffset:k,sampleSize:c,chunkOffset:f,chunkSize:m,isKeyFrame:r.keySampleIndices?ot(r.keySampleIndices,e,T=>T)!==-1:!0}},ma=(r,e)=>{if(!r.keySampleIndices)return e;const t=z(r.keySampleIndices,e,a=>a);return r.keySampleIndices[t]??-1},pa=(r,e)=>{if(!r.keySampleIndices)return e+1;const t=z(r.keySampleIndices,e,a=>a);return r.keySampleIndices[t+1]??-1},Tt=(r,e)=>{r.startTimestamp+=e,r.endTimestamp+=e;for(const t of r.samples)t.presentationTimestamp+=e;for(const t of r.presentationTimestamps)t.presentationTimestamp+=e},ga=r=>{const[e,,,t]=r,a=Math.hypot(e,t),n=e/a,s=t/a,i=-Math.atan2(s,n)*(180/Math.PI);return Number.isFinite(i)?i:0},fr=r=>r.sampleSizes.length===0;var S;(function(r){r[r.EBML=440786851]="EBML",r[r.EBMLVersion=17030]="EBMLVersion",r[r.EBMLReadVersion=17143]="EBMLReadVersion",r[r.EBMLMaxIDLength=17138]="EBMLMaxIDLength",r[r.EBMLMaxSizeLength=17139]="EBMLMaxSizeLength",r[r.DocType=17026]="DocType",r[r.DocTypeVersion=17031]="DocTypeVersion",r[r.DocTypeReadVersion=17029]="DocTypeReadVersion",r[r.Void=236]="Void",r[r.Segment=408125543]="Segment",r[r.SeekHead=290298740]="SeekHead",r[r.Seek=19899]="Seek",r[r.SeekID=21419]="SeekID",r[r.SeekPosition=21420]="SeekPosition",r[r.Duration=17545]="Duration",r[r.Info=357149030]="Info",r[r.TimestampScale=2807729]="TimestampScale",r[r.MuxingApp=19840]="MuxingApp",r[r.WritingApp=22337]="WritingApp",r[r.Tracks=374648427]="Tracks",r[r.TrackEntry=174]="TrackEntry",r[r.TrackNumber=215]="TrackNumber",r[r.TrackUID=29637]="TrackUID",r[r.TrackType=131]="TrackType",r[r.FlagEnabled=185]="FlagEnabled",r[r.FlagDefault=136]="FlagDefault",r[r.FlagForced=21930]="FlagForced",r[r.FlagLacing=156]="FlagLacing",r[r.Name=21358]="Name",r[r.Language=2274716]="Language",r[r.LanguageBCP47=2274717]="LanguageBCP47",r[r.CodecID=134]="CodecID",r[r.CodecPrivate=25506]="CodecPrivate",r[r.CodecDelay=22186]="CodecDelay",r[r.SeekPreRoll=22203]="SeekPreRoll",r[r.DefaultDuration=2352003]="DefaultDuration",r[r.Video=224]="Video",r[r.PixelWidth=176]="PixelWidth",r[r.PixelHeight=186]="PixelHeight",r[r.AlphaMode=21440]="AlphaMode",r[r.Audio=225]="Audio",r[r.SamplingFrequency=181]="SamplingFrequency",r[r.Channels=159]="Channels",r[r.BitDepth=25188]="BitDepth",r[r.SimpleBlock=163]="SimpleBlock",r[r.BlockGroup=160]="BlockGroup",r[r.Block=161]="Block",r[r.BlockAdditions=30113]="BlockAdditions",r[r.BlockMore=166]="BlockMore",r[r.BlockAdditional=165]="BlockAdditional",r[r.BlockAddID=238]="BlockAddID",r[r.BlockDuration=155]="BlockDuration",r[r.ReferenceBlock=251]="ReferenceBlock",r[r.Cluster=524531317]="Cluster",r[r.Timestamp=231]="Timestamp",r[r.Cues=475249515]="Cues",r[r.CuePoint=187]="CuePoint",r[r.CueTime=179]="CueTime",r[r.CueTrackPositions=183]="CueTrackPositions",r[r.CueTrack=247]="CueTrack",r[r.CueClusterPosition=241]="CueClusterPosition",r[r.Colour=21936]="Colour",r[r.MatrixCoefficients=21937]="MatrixCoefficients",r[r.TransferCharacteristics=21946]="TransferCharacteristics",r[r.Primaries=21947]="Primaries",r[r.Range=21945]="Range",r[r.Projection=30320]="Projection",r[r.ProjectionType=30321]="ProjectionType",r[r.ProjectionPoseRoll=30325]="ProjectionPoseRoll",r[r.Attachments=423732329]="Attachments",r[r.AttachedFile=24999]="AttachedFile",r[r.FileDescription=18046]="FileDescription",r[r.FileName=18030]="FileName",r[r.FileMediaType=18016]="FileMediaType",r[r.FileData=18012]="FileData",r[r.FileUID=18094]="FileUID",r[r.Chapters=272869232]="Chapters",r[r.Tags=307544935]="Tags",r[r.Tag=29555]="Tag",r[r.Targets=25536]="Targets",r[r.TargetTypeValue=26826]="TargetTypeValue",r[r.TargetType=25546]="TargetType",r[r.TagTrackUID=25541]="TagTrackUID",r[r.TagEditionUID=25545]="TagEditionUID",r[r.TagChapterUID=25540]="TagChapterUID",r[r.TagAttachmentUID=25542]="TagAttachmentUID",r[r.SimpleTag=26568]="SimpleTag",r[r.TagName=17827]="TagName",r[r.TagLanguage=17530]="TagLanguage",r[r.TagString=17543]="TagString",r[r.TagBinary=17541]="TagBinary",r[r.ContentEncodings=28032]="ContentEncodings",r[r.ContentEncoding=25152]="ContentEncoding",r[r.ContentEncodingOrder=20529]="ContentEncodingOrder",r[r.ContentEncodingScope=20530]="ContentEncodingScope",r[r.ContentCompression=20532]="ContentCompression",r[r.ContentCompAlgo=16980]="ContentCompAlgo",r[r.ContentCompSettings=16981]="ContentCompSettings",r[r.ContentEncryption=20533]="ContentEncryption"})(S||(S={}));const ka=[S.EBML,S.Segment],Me=[S.SeekHead,S.Info,S.Cluster,S.Tracks,S.Cues,S.Attachments,S.Chapters,S.Tags],Je=[...ka,...Me],St=8,$=2,ee=2*St,hr=r=>{const e=D(r);if(r.skip(-1),e===0)return null;let t=1,a=128;for(;(e&a)===0;)t++,a>>=1;return t},Ue=r=>{const e=D(r);if(e===0)return null;let t=1,a=128;for(;(e&a)===0;)t++,a>>=1;let n=e&a-1;for(let s=1;s<t;s++)n*=256,n+=D(r);return n},E=(r,e)=>{if(e<1||e>8)throw new Error("Bad unsigned int size "+e);let t=0;for(let a=0;a<e;a++)t*=256,t+=D(r);return t},ba=(r,e)=>{if(e<1)throw new Error("Bad unsigned int size "+e);let t=0n;for(let a=0;a<e;a++)t<<=8n,t+=BigInt(D(r));return t},Ta=(r,e)=>{let t=E(r,e);return t&1<<e*8-1&&(t-=2**(e*8)),t},yt=r=>{const e=hr(r);return e===null?null:E(r,e)},mr=r=>{let e=D(r);return e===255?e=null:(r.skip(-1),e=Ue(r),e===72057594037927940&&(e=null)),e},te=r=>{const e=yt(r);if(e===null)return null;const t=mr(r);return{id:e,size:t}},Pe=(r,e)=>{const t=F(r,e);let a=0;for(;a<e&&t[a]!==0;)a+=1;return String.fromCharCode(...t.subarray(0,a))},Ve=(r,e)=>{const t=F(r,e);let a=0;for(;a<e&&t[a]!==0;)a+=1;return K.decode(t.subarray(0,a))},wt=(r,e)=>{if(e===0)return 0;if(e!==4&&e!==8)throw new Error("Bad float size "+e);return e===4?Dn(r):vr(r)},Pt=async(r,e,t,a)=>{const n=new Set(t);let s=e;for(;a===null||s<a;){let i=r.requestSliceRange(s,$,ee);if(i instanceof Promise&&(i=await i),!i)break;const o=te(i);if(!o)break;if(n.has(o.id))return{pos:s,found:!0};ce(o.size),s=i.filePos+o.size}return{pos:a!==null&&a>s?a:s,found:!1}},pr=async(r,e,t,a)=>{const s=new Set(t);let i=e;for(;i<a;){let o=r.requestSliceRange(i,0,Math.min(65536,a-i));if(o instanceof Promise&&(o=await o),!o||o.length<St)break;for(let c=0;c<o.length-St;c++){o.filePos=i;const l=yt(o);if(l!==null&&s.has(l))return i;i++}}return null},Y={avc:"V_MPEG4/ISO/AVC",hevc:"V_MPEGH/ISO/HEVC",vp8:"V_VP8",vp9:"V_VP9",av1:"V_AV1",aac:"A_AAC",mp3:"A_MPEG/L3",opus:"A_OPUS",vorbis:"A_VORBIS",flac:"A_FLAC"};function ce(r){if(r===null)throw new Error("Undefined element size is used in a place where it is not supported.")}const Sa=r=>{let t=(r.hasVideo?"video/":r.hasAudio?"audio/":"application/")+(r.isWebM?"webm":"x-matroska");if(r.codecStrings.length>0){const a=[...new Set(r.codecStrings.filter(Boolean))];t+=`; codecs="${a.join(", ")}"`}return t};var re;(function(r){r[r.None=0]="None",r[r.Xiph=1]="Xiph",r[r.FixedSize=2]="FixedSize",r[r.Ebml=3]="Ebml"})(re||(re={}));var et;(function(r){r[r.Block=1]="Block",r[r.Private=2]="Private",r[r.Next=4]="Next"})(et||(et={}));var He;(function(r){r[r.Zlib=0]="Zlib",r[r.Bzlib=1]="Bzlib",r[r.lzo1x=2]="lzo1x",r[r.HeaderStripping=3]="HeaderStripping"})(He||(He={}));const xt=[{id:S.SeekHead,flag:"seekHeadSeen"},{id:S.Info,flag:"infoSeen"},{id:S.Tracks,flag:"tracksSeen"},{id:S.Cues,flag:"cuesSeen"}],gr=10*2**20;class ya extends de{constructor(e){super(e),this.readMetadataPromise=null,this.segments=[],this.currentSegment=null,this.currentTrack=null,this.currentCluster=null,this.currentBlock=null,this.currentBlockAdditional=null,this.currentCueTime=null,this.currentDecodingInstruction=null,this.currentTagTargetIsMovie=!0,this.currentSimpleTagName=null,this.currentAttachedFile=null,this.isWebM=!1,this.reader=e._reader}async computeDuration(){const e=await this.getTracks(),t=await Promise.all(e.map(a=>a.computeDuration()));return Math.max(0,...t)}async getTracks(){return await this.readMetadata(),this.segments.flatMap(e=>e.tracks.map(t=>t.inputTrack))}async getMimeType(){await this.readMetadata();const e=await this.getTracks(),t=await Promise.all(e.map(a=>a.getCodecParameterString()));return Sa({isWebM:this.isWebM,hasVideo:this.segments.some(a=>a.tracks.some(n=>n.info?.type==="video")),hasAudio:this.segments.some(a=>a.tracks.some(n=>n.info?.type==="audio")),codecStrings:t.filter(Boolean)})}async getMetadataTags(){await this.readMetadata();for(const t of this.segments)t.metadataTagsCollected||(this.reader.fileSize!==null&&await this.loadSegmentMetadata(t),t.metadataTagsCollected=!0);let e={};for(const t of this.segments)e={...e,...t.metadataTags};return e}readMetadata(){return this.readMetadataPromise??=(async()=>{let e=0;for(;;){let t=this.reader.requestSliceRange(e,$,ee);if(t instanceof Promise&&(t=await t),!t)break;const a=te(t);if(!a)break;const n=a.id;let s=a.size;const i=t.filePos;if(n===S.EBML){ce(s);let o=this.reader.requestSlice(i,s);if(o instanceof Promise&&(o=await o),!o)break;this.readContiguousElements(o)}else if(n===S.Segment){if(await this.readSegment(i,s),s===null||this.reader.fileSize===null)break}else if(n===S.Cluster){if(this.reader.fileSize===null)break;s===null&&(s=(await Pt(this.reader,i,Je,this.reader.fileSize)).pos-i);const o=J(this.segments);o&&(o.elementEndPos=i+s)}ce(s),e=i+s}})()}async readSegment(e,t){this.currentSegment={seekHeadSeen:!1,infoSeen:!1,tracksSeen:!1,cuesSeen:!1,tagsSeen:!1,attachmentsSeen:!1,timestampScale:-1,timestampFactor:-1,duration:-1,seekEntries:[],tracks:[],cuePoints:[],dataStartPos:e,elementEndPos:t===null?null:e+t,clusterSeekStartPos:e,lastReadCluster:null,metadataTags:{},metadataTagsCollected:!1},this.segments.push(this.currentSegment);let a=e;for(;this.currentSegment.elementEndPos===null||a<this.currentSegment.elementEndPos;){let o=this.reader.requestSliceRange(a,$,ee);if(o instanceof Promise&&(o=await o),!o)break;const c=a,l=te(o);if(!l||!Me.includes(l.id)&&l.id!==S.Void){const m=await pr(this.reader,c,Me,Math.min(this.currentSegment.elementEndPos??1/0,c+gr));if(m){a=m;continue}else break}const{id:d,size:u}=l,f=o.filePos,h=xt.findIndex(m=>m.id===d);if(h!==-1){const m=xt[h].flag;this.currentSegment[m]=!0,ce(u);let k=this.reader.requestSlice(f,u);k instanceof Promise&&(k=await k),k&&this.readContiguousElements(k)}else if(d===S.Tags||d===S.Attachments){d===S.Tags?this.currentSegment.tagsSeen=!0:this.currentSegment.attachmentsSeen=!0,ce(u);let m=this.reader.requestSlice(f,u);m instanceof Promise&&(m=await m),m&&this.readContiguousElements(m)}else if(d===S.Cluster){this.currentSegment.clusterSeekStartPos=c;break}if(u===null)break;a=f+u}if(this.currentSegment.seekEntries.sort((o,c)=>o.segmentPosition-c.segmentPosition),this.reader.fileSize!==null)for(const o of this.currentSegment.seekEntries){const c=xt.find(m=>m.id===o.id);if(!c||this.currentSegment[c.flag])continue;let l=this.reader.requestSliceRange(e+o.segmentPosition,$,ee);if(l instanceof Promise&&(l=await l),!l)continue;const d=te(l);if(!d)continue;const{id:u,size:f}=d;if(u!==c.id)continue;ce(f),this.currentSegment[c.flag]=!0;let h=this.reader.requestSlice(l.filePos,f);h instanceof Promise&&(h=await h),h&&this.readContiguousElements(h)}this.currentSegment.timestampScale===-1&&(this.currentSegment.timestampScale=1e6,this.currentSegment.timestampFactor=1e9/1e6),this.currentSegment.tracks.sort((o,c)=>Number(c.isDefault)-Number(o.isDefault));const n=new Map(this.currentSegment.tracks.map(o=>[o.id,o]));for(const o of this.currentSegment.cuePoints){const c=n.get(o.trackId);c&&c.cuePoints.push(o)}for(const o of this.currentSegment.tracks){o.cuePoints.sort((c,l)=>c.time-l.time);for(let c=0;c<o.cuePoints.length-1;c++){const l=o.cuePoints[c],d=o.cuePoints[c+1];l.time===d.time&&(o.cuePoints.splice(c+1,1),c--)}}let s=null,i=-1/0;for(const o of this.currentSegment.tracks)o.cuePoints.length>i&&(i=o.cuePoints.length,s=o);for(const o of this.currentSegment.tracks)o.cuePoints.length===0&&(o.cuePoints=s.cuePoints);this.currentSegment=null}async readCluster(e,t){if(t.lastReadCluster?.elementStartPos===e)return t.lastReadCluster;let a=this.reader.requestSliceRange(e,$,ee);a instanceof Promise&&(a=await a),p(a);const n=e,s=te(a);p(s);const i=s.id;p(i===S.Cluster);let o=s.size;const c=a.filePos;o===null&&(o=(await Pt(this.reader,c,Je,t.elementEndPos)).pos-c);let l=this.reader.requestSlice(c,o);l instanceof Promise&&(l=await l);const d={segment:t,elementStartPos:n,elementEndPos:c+o,dataStartPos:c,timestamp:-1,trackData:new Map};if(this.currentCluster=d,l){const u=this.readContiguousElements(l,Je);d.elementEndPos=u}for(const[,u]of d.trackData){const f=u.track;p(u.blocks.length>0);let h=!1,m=!1;for(let g=0;g<u.blocks.length;g++){const w=u.blocks[g];w.timestamp+=d.timestamp,h||=w.referencedTimestamps.length>0,m||=w.lacing!==re.None}h&&(u.blocks=xa(u.blocks)),u.presentationTimestamps=u.blocks.map((g,w)=>({timestamp:g.timestamp,blockIndex:w})).sort((g,w)=>g.timestamp-w.timestamp);for(let g=0;g<u.presentationTimestamps.length;g++){const w=u.presentationTimestamps[g],y=u.blocks[w.blockIndex];if(u.firstKeyFrameTimestamp===null&&y.isKeyFrame&&(u.firstKeyFrameTimestamp=y.timestamp),g<u.presentationTimestamps.length-1){const I=u.presentationTimestamps[g+1];y.duration=I.timestamp-y.timestamp}else y.duration===0&&f.defaultDuration!=null&&y.lacing===re.None&&(y.duration=f.defaultDuration)}m&&(this.expandLacedBlocks(u.blocks,f),u.presentationTimestamps=u.blocks.map((g,w)=>({timestamp:g.timestamp,blockIndex:w})).sort((g,w)=>g.timestamp-w.timestamp));const k=u.blocks[u.presentationTimestamps[0].blockIndex],b=u.blocks[J(u.presentationTimestamps).blockIndex];u.startTimestamp=k.timestamp,u.endTimestamp=b.timestamp+b.duration;const T=z(f.clusterPositionCache,u.startTimestamp,g=>g.startTimestamp);(T===-1||f.clusterPositionCache[T].elementStartPos!==n)&&f.clusterPositionCache.splice(T+1,0,{elementStartPos:d.elementStartPos,startTimestamp:u.startTimestamp})}return t.lastReadCluster=d,d}getTrackDataInCluster(e,t){let a=e.trackData.get(t);if(!a){const n=e.segment.tracks.find(s=>s.id===t);if(!n)return null;a={track:n,startTimestamp:0,endTimestamp:0,firstKeyFrameTimestamp:null,blocks:[],presentationTimestamps:[]},e.trackData.set(t,a)}return a}expandLacedBlocks(e,t){for(let a=0;a<e.length;a++){const n=e[a];if(n.lacing===re.None)continue;n.decoded||(n.data=this.decodeBlockData(t,n.data),n.decoded=!0);const s=Fe.tempFromBytes(n.data),i=[],o=D(s)+1;switch(n.lacing){case re.Xiph:{let c=0;for(let l=0;l<o-1;l++){let d=0;for(;s.bufferPos<s.length;){const u=D(s);if(d+=u,u<255){i.push(d),c+=d;break}}}i.push(s.length-(s.bufferPos+c))}break;case re.FixedSize:{const c=s.length-1,l=Math.floor(c/o);for(let d=0;d<o;d++)i.push(l)}break;case re.Ebml:{const c=Ue(s);p(c!==null);let l=c;i.push(l);let d=l;for(let u=1;u<o-1;u++){const f=s.bufferPos,h=Ue(s);p(h!==null);const m=h,b=(1<<(s.bufferPos-f)*7-1)-1,T=m-b;l+=T,i.push(l),d+=l}i.push(s.length-(s.bufferPos+d))}break;default:p(!1)}p(i.length===o),e.splice(a,1);for(let c=0;c<o;c++){const l=i[c],d=F(s,l),u=n.duration||o*(t.defaultDuration??0),f=n.timestamp+u*c/o,h=u/o;e.splice(a+c,0,{timestamp:f,duration:h,isKeyFrame:n.isKeyFrame,referencedTimestamps:n.referencedTimestamps,data:d,lacing:re.None,decoded:!0,mainAdditional:n.mainAdditional})}a+=o,a--}}async loadSegmentMetadata(e){for(const t of e.seekEntries){if(!(t.id===S.Tags&&!e.tagsSeen)){if(!(t.id===S.Attachments&&!e.attachmentsSeen))continue}let a=this.reader.requestSliceRange(e.dataStartPos+t.segmentPosition,$,ee);if(a instanceof Promise&&(a=await a),!a)continue;const n=te(a);if(!n||n.id!==t.id)continue;const{size:s}=n;ce(s),p(!this.currentSegment),this.currentSegment=e;let i=this.reader.requestSlice(a.filePos,s);i instanceof Promise&&(i=await i),i&&this.readContiguousElements(i),this.currentSegment=null,t.id===S.Tags?e.tagsSeen=!0:t.id===S.Attachments&&(e.attachmentsSeen=!0)}}readContiguousElements(e,t){const a=e.filePos;for(;e.filePos-a<=e.length-$;){const n=e.filePos;if(!this.traverseElement(e,t))return n}return e.filePos}traverseElement(e,t){const a=te(e);if(!a||t&&t.includes(a.id))return!1;const{id:n,size:s}=a,i=e.filePos;switch(ce(s),n){case S.DocType:this.isWebM=Pe(e,s)==="webm";break;case S.Seek:{if(!this.currentSegment)break;const o={id:-1,segmentPosition:-1};this.currentSegment.seekEntries.push(o),this.readContiguousElements(e.slice(i,s)),(o.id===-1||o.segmentPosition===-1)&&this.currentSegment.seekEntries.pop()}break;case S.SeekID:{const o=this.currentSegment?.seekEntries[this.currentSegment.seekEntries.length-1];if(!o)break;o.id=E(e,s)}break;case S.SeekPosition:{const o=this.currentSegment?.seekEntries[this.currentSegment.seekEntries.length-1];if(!o)break;o.segmentPosition=E(e,s)}break;case S.TimestampScale:{if(!this.currentSegment)break;this.currentSegment.timestampScale=E(e,s),this.currentSegment.timestampFactor=1e9/this.currentSegment.timestampScale}break;case S.Duration:{if(!this.currentSegment)break;this.currentSegment.duration=wt(e,s)}break;case S.TrackEntry:{if(!this.currentSegment)break;if(this.currentTrack={id:-1,segment:this.currentSegment,demuxer:this,clusterPositionCache:[],cuePoints:[],isDefault:!1,inputTrack:null,codecId:null,codecPrivate:null,defaultDuration:null,name:null,languageCode:Q,decodingInstructions:[],info:null},this.readContiguousElements(e.slice(i,s)),this.currentTrack.decodingInstructions.some(o=>o.data?.type!=="decompress"||o.scope!==et.Block||o.data.algorithm!==He.HeaderStripping)&&(console.warn(`Track #${this.currentTrack.id} has an unsupported content encoding; dropping.`),this.currentTrack=null),this.currentTrack&&this.currentTrack.id!==-1&&this.currentTrack.codecId&&this.currentTrack.info){const o=this.currentTrack.codecId.indexOf("/"),c=o===-1?this.currentTrack.codecId:this.currentTrack.codecId.slice(0,o);if(this.currentTrack.info.type==="video"&&this.currentTrack.info.width!==-1&&this.currentTrack.info.height!==-1){this.currentTrack.codecId===Y.avc?(this.currentTrack.info.codec="avc",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):this.currentTrack.codecId===Y.hevc?(this.currentTrack.info.codec="hevc",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):c===Y.vp8?this.currentTrack.info.codec="vp8":c===Y.vp9?this.currentTrack.info.codec="vp9":c===Y.av1&&(this.currentTrack.info.codec="av1");const l=this.currentTrack,d=new Ye(this.input,new wa(l));this.currentTrack.inputTrack=d,this.currentSegment.tracks.push(this.currentTrack)}else if(this.currentTrack.info.type==="audio"&&this.currentTrack.info.numberOfChannels!==-1&&this.currentTrack.info.sampleRate!==-1){c===Y.aac?(this.currentTrack.info.codec="aac",this.currentTrack.info.aacCodecInfo={isMpeg2:this.currentTrack.codecId.includes("MPEG2")},this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):this.currentTrack.codecId===Y.mp3?this.currentTrack.info.codec="mp3":c===Y.opus?(this.currentTrack.info.codec="opus",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate,this.currentTrack.info.sampleRate=Ge):c===Y.vorbis?(this.currentTrack.info.codec="vorbis",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):c===Y.flac?(this.currentTrack.info.codec="flac",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):this.currentTrack.codecId==="A_PCM/INT/LIT"?this.currentTrack.info.bitDepth===8?this.currentTrack.info.codec="pcm-u8":this.currentTrack.info.bitDepth===16?this.currentTrack.info.codec="pcm-s16":this.currentTrack.info.bitDepth===24?this.currentTrack.info.codec="pcm-s24":this.currentTrack.info.bitDepth===32&&(this.currentTrack.info.codec="pcm-s32"):this.currentTrack.codecId==="A_PCM/INT/BIG"?this.currentTrack.info.bitDepth===8?this.currentTrack.info.codec="pcm-u8":this.currentTrack.info.bitDepth===16?this.currentTrack.info.codec="pcm-s16be":this.currentTrack.info.bitDepth===24?this.currentTrack.info.codec="pcm-s24be":this.currentTrack.info.bitDepth===32&&(this.currentTrack.info.codec="pcm-s32be"):this.currentTrack.codecId==="A_PCM/FLOAT/IEEE"&&(this.currentTrack.info.bitDepth===32?this.currentTrack.info.codec="pcm-f32":this.currentTrack.info.bitDepth===64&&(this.currentTrack.info.codec="pcm-f64"));const l=this.currentTrack,d=new se(this.input,new Pa(l));this.currentTrack.inputTrack=d,this.currentSegment.tracks.push(this.currentTrack)}}this.currentTrack=null}break;case S.TrackNumber:{if(!this.currentTrack)break;this.currentTrack.id=E(e,s)}break;case S.TrackType:{if(!this.currentTrack)break;const o=E(e,s);o===1?this.currentTrack.info={type:"video",width:-1,height:-1,rotation:0,codec:null,codecDescription:null,colorSpace:null,alphaMode:!1}:o===2&&(this.currentTrack.info={type:"audio",numberOfChannels:-1,sampleRate:-1,bitDepth:-1,codec:null,codecDescription:null,aacCodecInfo:null})}break;case S.FlagEnabled:{if(!this.currentTrack)break;E(e,s)||(this.currentSegment.tracks.pop(),this.currentTrack=null)}break;case S.FlagDefault:{if(!this.currentTrack)break;this.currentTrack.isDefault=!!E(e,s)}break;case S.CodecID:{if(!this.currentTrack)break;this.currentTrack.codecId=Pe(e,s)}break;case S.CodecPrivate:{if(!this.currentTrack)break;this.currentTrack.codecPrivate=F(e,s)}break;case S.DefaultDuration:{if(!this.currentTrack)break;this.currentTrack.defaultDuration=this.currentTrack.segment.timestampFactor*E(e,s)/1e9}break;case S.Name:{if(!this.currentTrack)break;this.currentTrack.name=Ve(e,s)}break;case S.Language:{if(!this.currentTrack||this.currentTrack.languageCode!==Q)break;this.currentTrack.languageCode=Pe(e,s),Wt(this.currentTrack.languageCode)||(this.currentTrack.languageCode=Q)}break;case S.LanguageBCP47:{if(!this.currentTrack)break;const c=Pe(e,s).split("-")[0];c?this.currentTrack.languageCode=c:this.currentTrack.languageCode=Q}break;case S.Video:{if(this.currentTrack?.info?.type!=="video")break;this.readContiguousElements(e.slice(i,s))}break;case S.PixelWidth:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.width=E(e,s)}break;case S.PixelHeight:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.height=E(e,s)}break;case S.AlphaMode:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.alphaMode=E(e,s)===1}break;case S.Colour:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.colorSpace={},this.readContiguousElements(e.slice(i,s))}break;case S.MatrixCoefficients:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;const o=E(e,s),c=Nt[o]??null;this.currentTrack.info.colorSpace.matrix=c}break;case S.Range:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;this.currentTrack.info.colorSpace.fullRange=E(e,s)===2}break;case S.TransferCharacteristics:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;const o=E(e,s),c=Rt[o]??null;this.currentTrack.info.colorSpace.transfer=c}break;case S.Primaries:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;const o=E(e,s),c=Et[o]??null;this.currentTrack.info.colorSpace.primaries=c}break;case S.Projection:{if(this.currentTrack?.info?.type!=="video")break;this.readContiguousElements(e.slice(i,s))}break;case S.ProjectionPoseRoll:{if(this.currentTrack?.info?.type!=="video")break;const c=-wt(e,s);try{this.currentTrack.info.rotation=Ft(c)}catch{}}break;case S.Audio:{if(this.currentTrack?.info?.type!=="audio")break;this.readContiguousElements(e.slice(i,s))}break;case S.SamplingFrequency:{if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.sampleRate=wt(e,s)}break;case S.Channels:{if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.numberOfChannels=E(e,s)}break;case S.BitDepth:{if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.bitDepth=E(e,s)}break;case S.CuePoint:{if(!this.currentSegment)break;this.readContiguousElements(e.slice(i,s)),this.currentCueTime=null}break;case S.CueTime:this.currentCueTime=E(e,s);break;case S.CueTrackPositions:{if(this.currentCueTime===null)break;p(this.currentSegment);const o={time:this.currentCueTime,trackId:-1,clusterPosition:-1};this.currentSegment.cuePoints.push(o),this.readContiguousElements(e.slice(i,s)),(o.trackId===-1||o.clusterPosition===-1)&&this.currentSegment.cuePoints.pop()}break;case S.CueTrack:{const o=this.currentSegment?.cuePoints[this.currentSegment.cuePoints.length-1];if(!o)break;o.trackId=E(e,s)}break;case S.CueClusterPosition:{const o=this.currentSegment?.cuePoints[this.currentSegment.cuePoints.length-1];if(!o)break;p(this.currentSegment),o.clusterPosition=this.currentSegment.dataStartPos+E(e,s)}break;case S.Timestamp:{if(!this.currentCluster)break;this.currentCluster.timestamp=E(e,s)}break;case S.SimpleBlock:{if(!this.currentCluster)break;const o=Ue(e);if(o===null)break;const c=this.getTrackDataInCluster(this.currentCluster,o);if(!c)break;const l=Dt(e),d=D(e),u=!!(d&128),f=d>>1&3,h=F(e,s-(e.filePos-i)),m=c.track.decodingInstructions.length>0;c.blocks.push({timestamp:l,duration:0,isKeyFrame:u,referencedTimestamps:[],data:h,lacing:f,decoded:!m,mainAdditional:null})}break;case S.BlockGroup:{if(!this.currentCluster)break;if(this.readContiguousElements(e.slice(i,s)),this.currentBlock){for(let o=0;o<this.currentBlock.referencedTimestamps.length;o++)this.currentBlock.referencedTimestamps[o]+=this.currentBlock.timestamp;this.currentBlock=null}}break;case S.Block:{if(!this.currentCluster)break;const o=Ue(e);if(o===null)break;const c=this.getTrackDataInCluster(this.currentCluster,o);if(!c)break;const l=Dt(e),u=D(e)>>1&3,f=F(e,s-(e.filePos-i)),h=c.track.decodingInstructions.length>0;this.currentBlock={timestamp:l,duration:0,isKeyFrame:!0,referencedTimestamps:[],data:f,lacing:u,decoded:!h,mainAdditional:null},c.blocks.push(this.currentBlock)}break;case S.BlockAdditions:this.readContiguousElements(e.slice(i,s));break;case S.BlockMore:{if(!this.currentBlock)break;this.currentBlockAdditional={addId:1,data:null},this.readContiguousElements(e.slice(i,s)),this.currentBlockAdditional.data&&this.currentBlockAdditional.addId===1&&(this.currentBlock.mainAdditional=this.currentBlockAdditional.data),this.currentBlockAdditional=null}break;case S.BlockAdditional:{if(!this.currentBlockAdditional)break;this.currentBlockAdditional.data=F(e,s)}break;case S.BlockAddID:{if(!this.currentBlockAdditional)break;this.currentBlockAdditional.addId=E(e,s)}break;case S.BlockDuration:{if(!this.currentBlock)break;this.currentBlock.duration=E(e,s)}break;case S.ReferenceBlock:{if(!this.currentBlock)break;this.currentBlock.isKeyFrame=!1;const o=Ta(e,s);this.currentBlock.referencedTimestamps.push(o)}break;case S.Tag:this.currentTagTargetIsMovie=!0,this.readContiguousElements(e.slice(i,s));break;case S.Targets:this.readContiguousElements(e.slice(i,s));break;case S.TargetTypeValue:E(e,s)!==50&&(this.currentTagTargetIsMovie=!1);break;case S.TagTrackUID:case S.TagEditionUID:case S.TagChapterUID:case S.TagAttachmentUID:this.currentTagTargetIsMovie=!1;break;case S.SimpleTag:{if(!this.currentTagTargetIsMovie)break;this.currentSimpleTagName=null,this.readContiguousElements(e.slice(i,s))}break;case S.TagName:this.currentSimpleTagName=Ve(e,s);break;case S.TagString:{if(!this.currentSimpleTagName)break;const o=Ve(e,s);this.processTagValue(this.currentSimpleTagName,o)}break;case S.TagBinary:{if(!this.currentSimpleTagName)break;const o=F(e,s);this.processTagValue(this.currentSimpleTagName,o)}break;case S.AttachedFile:{if(!this.currentSegment)break;this.currentAttachedFile={fileUid:null,fileName:null,fileMediaType:null,fileData:null,fileDescription:null},this.readContiguousElements(e.slice(i,s));const o=this.currentSegment.metadataTags;if(this.currentAttachedFile.fileUid&&this.currentAttachedFile.fileData&&(o.raw??={},o.raw[this.currentAttachedFile.fileUid.toString()]=new Mr(this.currentAttachedFile.fileData,this.currentAttachedFile.fileMediaType??void 0,this.currentAttachedFile.fileName??void 0,this.currentAttachedFile.fileDescription??void 0)),this.currentAttachedFile.fileMediaType?.startsWith("image/")&&this.currentAttachedFile.fileData){const c=this.currentAttachedFile.fileName;let l="unknown";if(c){const d=c.toLowerCase();d.startsWith("cover.")?l="coverFront":d.startsWith("back.")&&(l="coverBack")}o.images??=[],o.images.push({data:this.currentAttachedFile.fileData,mimeType:this.currentAttachedFile.fileMediaType,kind:l,name:this.currentAttachedFile.fileName??void 0,description:this.currentAttachedFile.fileDescription??void 0})}this.currentAttachedFile=null}break;case S.FileUID:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileUid=ba(e,s)}break;case S.FileName:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileName=Ve(e,s)}break;case S.FileMediaType:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileMediaType=Pe(e,s)}break;case S.FileData:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileData=F(e,s)}break;case S.FileDescription:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileDescription=Ve(e,s)}break;case S.ContentEncodings:{if(!this.currentTrack)break;this.readContiguousElements(e.slice(i,s)),this.currentTrack.decodingInstructions.sort((o,c)=>c.order-o.order)}break;case S.ContentEncoding:this.currentDecodingInstruction={order:0,scope:et.Block,data:null},this.readContiguousElements(e.slice(i,s)),this.currentDecodingInstruction.data&&this.currentTrack.decodingInstructions.push(this.currentDecodingInstruction),this.currentDecodingInstruction=null;break;case S.ContentEncodingOrder:{if(!this.currentDecodingInstruction)break;this.currentDecodingInstruction.order=E(e,s)}break;case S.ContentEncodingScope:{if(!this.currentDecodingInstruction)break;this.currentDecodingInstruction.scope=E(e,s)}break;case S.ContentCompression:{if(!this.currentDecodingInstruction)break;this.currentDecodingInstruction.data={type:"decompress",algorithm:He.Zlib,settings:null},this.readContiguousElements(e.slice(i,s))}break;case S.ContentCompAlgo:{if(this.currentDecodingInstruction?.data?.type!=="decompress")break;this.currentDecodingInstruction.data.algorithm=E(e,s)}break;case S.ContentCompSettings:{if(this.currentDecodingInstruction?.data?.type!=="decompress")break;this.currentDecodingInstruction.data.settings=F(e,s)}break;case S.ContentEncryption:{if(!this.currentDecodingInstruction)break;this.currentDecodingInstruction.data={type:"decrypt"}}break}return e.filePos=i+s,!0}decodeBlockData(e,t){p(e.decodingInstructions.length>0);let a=t;for(const n of e.decodingInstructions)switch(p(n.data),n.data.type){case"decompress":switch(n.data.algorithm){case He.HeaderStripping:if(n.data.settings&&n.data.settings.length>0){const s=n.data.settings,i=new Uint8Array(s.length+a.length);i.set(s,0),i.set(a,s.length),a=i}break}break}return a}processTagValue(e,t){if(!this.currentSegment?.metadataTags)return;const a=this.currentSegment.metadataTags;if(a.raw??={},a.raw[e]??=t,typeof t=="string")switch(e.toLowerCase()){case"title":a.title??=t;break;case"description":a.description??=t;break;case"artist":a.artist??=t;break;case"album":a.album??=t;break;case"album_artist":a.albumArtist??=t;break;case"genre":a.genre??=t;break;case"comment":a.comment??=t;break;case"lyrics":a.lyrics??=t;break;case"date":{const n=new Date(t);Number.isNaN(n.getTime())||(a.date??=n)}break;case"track_number":case"part_number":{const n=t.split("/"),s=Number.parseInt(n[0],10),i=n[1]&&Number.parseInt(n[1],10);Number.isInteger(s)&&s>0&&(a.trackNumber??=s),i&&Number.isInteger(i)&&i>0&&(a.tracksTotal??=i)}break;case"disc_number":case"disc":{const n=t.split("/"),s=Number.parseInt(n[0],10),i=n[1]&&Number.parseInt(n[1],10);Number.isInteger(s)&&s>0&&(a.discNumber??=s),i&&Number.isInteger(i)&&i>0&&(a.discsTotal??=i)}break}}}class kr{constructor(e){this.internalTrack=e,this.packetToClusterLocation=new WeakMap}getId(){return this.internalTrack.id}getCodec(){throw new Error("Not implemented on base class.")}getInternalCodecId(){return this.internalTrack.codecId}async computeDuration(){const e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getName(){return this.internalTrack.name}getLanguageCode(){return this.internalTrack.languageCode}async getFirstTimestamp(){return(await this.getFirstPacket({metadataOnly:!0}))?.timestamp??0}getTimeResolution(){return this.internalTrack.segment.timestampFactor}async getFirstPacket(e){return this.performClusterLookup(null,t=>t.trackData.get(this.internalTrack.id)?{blockIndex:0,correctBlockFound:!0}:{blockIndex:-1,correctBlockFound:!1},-1/0,1/0,e)}intoTimescale(e){return je(e*this.internalTrack.segment.timestampFactor,14)}async getPacket(e,t){const a=this.intoTimescale(e);return this.performClusterLookup(null,n=>{const s=n.trackData.get(this.internalTrack.id);if(!s)return{blockIndex:-1,correctBlockFound:!1};const i=z(s.presentationTimestamps,a,l=>l.timestamp),o=i!==-1?s.presentationTimestamps[i].blockIndex:-1,c=i!==-1&&a<s.endTimestamp;return{blockIndex:o,correctBlockFound:c}},a,a,t)}async getNextPacket(e,t){const a=this.packetToClusterLocation.get(e);if(a===void 0)throw new Error("Packet was not created from this track.");return this.performClusterLookup(a.cluster,n=>{if(n===a.cluster){const s=n.trackData.get(this.internalTrack.id);if(a.blockIndex+1<s.blocks.length)return{blockIndex:a.blockIndex+1,correctBlockFound:!0}}else if(n.trackData.get(this.internalTrack.id))return{blockIndex:0,correctBlockFound:!0};return{blockIndex:-1,correctBlockFound:!1}},-1/0,1/0,t)}async getKeyPacket(e,t){const a=this.intoTimescale(e);return this.performClusterLookup(null,n=>{const s=n.trackData.get(this.internalTrack.id);if(!s)return{blockIndex:-1,correctBlockFound:!1};const i=Ht(s.presentationTimestamps,l=>s.blocks[l.blockIndex].isKeyFrame&&l.timestamp<=a),o=i!==-1?s.presentationTimestamps[i].blockIndex:-1,c=i!==-1&&a<s.endTimestamp;return{blockIndex:o,correctBlockFound:c}},a,a,t)}async getNextKeyPacket(e,t){const a=this.packetToClusterLocation.get(e);if(a===void 0)throw new Error("Packet was not created from this track.");return this.performClusterLookup(a.cluster,n=>{if(n===a.cluster){const i=n.trackData.get(this.internalTrack.id).blocks.findIndex((o,c)=>o.isKeyFrame&&c>a.blockIndex);if(i!==-1)return{blockIndex:i,correctBlockFound:!0}}else{const s=n.trackData.get(this.internalTrack.id);if(s&&s.firstKeyFrameTimestamp!==null){const i=s.blocks.findIndex(o=>o.isKeyFrame);return p(i!==-1),{blockIndex:i,correctBlockFound:!0}}}return{blockIndex:-1,correctBlockFound:!1}},-1/0,1/0,t)}async fetchPacketInCluster(e,t,a){if(t===-1)return null;const s=e.trackData.get(this.internalTrack.id).blocks[t];p(s),s.decoded||(s.data=this.internalTrack.demuxer.decodeBlockData(this.internalTrack,s.data),s.decoded=!0);const i=a.metadataOnly?j:s.data,o=s.timestamp/this.internalTrack.segment.timestampFactor,c=s.duration/this.internalTrack.segment.timestampFactor,l={};s.mainAdditional&&this.internalTrack.info?.type==="video"&&this.internalTrack.info.alphaMode&&(l.alpha=a.metadataOnly?j:s.mainAdditional,l.alphaByteLength=s.mainAdditional.byteLength);const d=new O(i,s.isKeyFrame?"key":"delta",o,c,e.dataStartPos+t,s.data.byteLength,l);return this.packetToClusterLocation.set(d,{cluster:e,blockIndex:t}),d}async performClusterLookup(e,t,a,n,s){const{demuxer:i,segment:o}=this.internalTrack;let c=null,l=null,d=-1;if(e){const{blockIndex:T,correctBlockFound:g}=t(e);if(g)return this.fetchPacketInCluster(e,T,s);T!==-1&&(l=e,d=T)}const u=z(this.internalTrack.cuePoints,a,T=>T.time),f=u!==-1?this.internalTrack.cuePoints[u]:null,h=z(this.internalTrack.clusterPositionCache,a,T=>T.startTimestamp),m=h!==-1?this.internalTrack.clusterPositionCache[h]:null,k=Math.max(f?.clusterPosition??0,m?.elementStartPos??0)||null;let b;for(e?k===null||e.elementStartPos>=k?(b=e.elementEndPos,c=e):b=k:b=k??o.clusterSeekStartPos;o.elementEndPos===null||b<=o.elementEndPos-$;){if(c){const C=c.trackData.get(this.internalTrack.id);if(C&&C.startTimestamp>n)break}let T=i.reader.requestSliceRange(b,$,ee);if(T instanceof Promise&&(T=await T),!T)break;const g=b,w=te(T);if(!w||!Me.includes(w.id)&&w.id!==S.Void){const C=await pr(i.reader,g,Me,Math.min(o.elementEndPos??1/0,g+gr));if(C){b=C;continue}else break}const y=w.id;let I=w.size;const v=T.filePos;if(y===S.Cluster){c=await i.readCluster(g,o),I=c.elementEndPos-v;const{blockIndex:C,correctBlockFound:A}=t(c);if(A)return this.fetchPacketInCluster(c,C,s);C!==-1&&(l=c,d=C)}I===null&&(p(y!==S.Cluster),I=(await Pt(i.reader,v,Je,o.elementEndPos)).pos-v);const x=v+I;if(o.elementEndPos===null){let C=i.reader.requestSliceRange(x,$,ee);if(C instanceof Promise&&(C=await C),!C)break;if(yt(C)===S.Segment){o.elementEndPos=x;break}}b=x}if(f&&(!l||l.elementStartPos<f.clusterPosition)){const T=this.internalTrack.cuePoints[u-1];p(!T||T.time<f.time);const g=T?.time??-1/0;return this.performClusterLookup(null,t,g,n,s)}return l?this.fetchPacketInCluster(l,d,s):null}}class wa extends kr{constructor(e){super(e),this.decoderConfigPromise=null,this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getCodedWidth(){return this.internalTrack.info.width}getCodedHeight(){return this.internalTrack.info.height}getRotation(){return this.internalTrack.info.rotation}async getColorSpace(){return{primaries:this.internalTrack.info.colorSpace?.primaries,transfer:this.internalTrack.info.colorSpace?.transfer,matrix:this.internalTrack.info.colorSpace?.matrix,fullRange:this.internalTrack.info.colorSpace?.fullRange}}async canBeTransparent(){return this.internalTrack.info.alphaMode}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfigPromise??=(async()=>{let e=null;return(this.internalTrack.info.codec==="vp9"||this.internalTrack.info.codec==="av1"||this.internalTrack.info.codec==="avc"&&!this.internalTrack.info.codecDescription||this.internalTrack.info.codec==="hevc"&&!this.internalTrack.info.codecDescription)&&(e=await this.getFirstPacket({})),{codec:Xt({width:this.internalTrack.info.width,height:this.internalTrack.info.height,codec:this.internalTrack.info.codec,codecDescription:this.internalTrack.info.codecDescription,colorSpace:this.internalTrack.info.colorSpace,avcCodecInfo:this.internalTrack.info.codec==="avc"&&e?qr(e.data):null,hevcCodecInfo:this.internalTrack.info.codec==="hevc"&&e?Lr(e.data):null,vp9CodecInfo:this.internalTrack.info.codec==="vp9"&&e?ar(e.data):null,av1CodecInfo:this.internalTrack.info.codec==="av1"&&e?ir(e.data):null}),codedWidth:this.internalTrack.info.width,codedHeight:this.internalTrack.info.height,description:this.internalTrack.info.codecDescription??void 0,colorSpace:this.internalTrack.info.colorSpace??void 0}})():null}}class Pa extends kr{constructor(e){super(e),this.decoderConfig=null,this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getNumberOfChannels(){return this.internalTrack.info.numberOfChannels}getSampleRate(){return this.internalTrack.info.sampleRate}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfig??={codec:Zt({codec:this.internalTrack.info.codec,codecDescription:this.internalTrack.info.codecDescription,aacCodecInfo:this.internalTrack.info.aacCodecInfo}),numberOfChannels:this.internalTrack.info.numberOfChannels,sampleRate:this.internalTrack.info.sampleRate,description:this.internalTrack.info.codecDescription??void 0}:null}}const xa=r=>{const e=new Map;for(let s=0;s<r.length;s++){const i=r[s];e.set(i.timestamp,i)}const t=new Set,a=[],n=s=>{if(!t.has(s)){t.add(s);for(let i=0;i<s.referencedTimestamps.length;i++){const o=s.referencedTimestamps[i],c=e.get(o);c&&n(c)}a.push(s)}};for(let s=0;s<r.length;s++)n(r[s]);return a};const br=4,Ia=[44100,48e3,32e3],Ca=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,32,40,48,56,64,80,96,112,128,160,192,224,256,320,-1,-1,32,48,56,64,80,96,112,128,160,192,224,256,320,384,-1,-1,32,64,96,128,160,192,224,256,288,320,352,384,416,448,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,16,24,32,40,48,56,64,80,96,112,128,144,160,-1,-1,8,16,24,32,40,48,56,64,80,96,112,128,144,160,-1,-1,32,48,56,64,80,96,112,128,144,160,176,192,224,256,-1],_a=1483304551,va=1231971951,Da=(r,e,t,a,n)=>e===0?0:e===1?Math.floor(144*t/(a<<r))+n:e===2?Math.floor(144*t/a)+n:(Math.floor(12*t/a)+n)*4,Fa=(r,e)=>r===3?e===3?21:36:e===3?13:21,Aa=(r,e)=>{const t=r>>>24,a=r>>>16&255,n=r>>>8&255,s=r&255;if(t!==255&&a!==255&&n!==255&&s!==255)return{header:null,bytesAdvanced:4};if(t!==255)return{header:null,bytesAdvanced:1};if((a&224)!==224)return{header:null,bytesAdvanced:1};let i=0,o=0;a&16?i=a&8?0:1:(i=1,o=1);const c=a>>3&3,l=a>>1&3,d=n>>4&15,u=(n>>2&3)%3,f=n>>1&1,h=s>>6&3,m=s>>4&3,k=s>>3&1,b=s>>2&1,T=s&3,g=Ca[i*16*4+l*16+d];if(g===-1)return{header:null,bytesAdvanced:1};const w=g*1e3,y=Ia[u]>>i+o,I=Da(i,l,w,y,f);if(e!==null&&e<I)return{header:null,bytesAdvanced:1};let v;return c===3?v=l===3?384:1152:l===3?v=384:l===2?v=1152:v=576,{header:{totalSize:I,mpegVersionId:c,layer:l,bitrate:w,frequencyIndex:u,sampleRate:y,channel:h,modeExtension:m,copyright:k,original:b,emphasis:T,audioSamplesInFrame:v},bytesAdvanced:1}},It=r=>{let e=2130706432,t=0;for(;e!==0;)t>>=1,t|=r&e,e>>=8;return t};var xe;(function(r){r[r.Unsynchronisation=128]="Unsynchronisation",r[r.ExtendedHeader=64]="ExtendedHeader",r[r.ExperimentalIndicator=32]="ExperimentalIndicator",r[r.Footer=16]="Footer"})(xe||(xe={}));var Ie;(function(r){r[r.ISO_8859_1=0]="ISO_8859_1",r[r.UTF_16_WITH_BOM=1]="UTF_16_WITH_BOM",r[r.UTF_16_BE_NO_BOM=2]="UTF_16_BE_NO_BOM",r[r.UTF_8=3]="UTF_8"})(Ie||(Ie={}));const tt=128,rt=10,Ce=["Blues","Classic rock","Country","Dance","Disco","Funk","Grunge","Hip-hop","Jazz","Metal","New age","Oldies","Other","Pop","Rhythm and blues","Rap","Reggae","Rock","Techno","Industrial","Alternative","Ska","Death metal","Pranks","Soundtrack","Euro-techno","Ambient","Trip-hop","Vocal","Jazz & funk","Fusion","Trance","Classical","Instrumental","Acid","House","Game","Sound clip","Gospel","Noise","Alternative rock","Bass","Soul","Punk","Space","Meditative","Instrumental pop","Instrumental rock","Ethnic","Gothic","Darkwave","Techno-industrial","Electronic","Pop-folk","Eurodance","Dream","Southern rock","Comedy","Cult","Gangsta","Top 40","Christian rap","Pop/funk","Jungle music","Native US","Cabaret","New wave","Psychedelic","Rave","Showtunes","Trailer","Lo-fi","Tribal","Acid punk","Acid jazz","Polka","Retro","Musical","Rock 'n' roll","Hard rock","Folk","Folk rock","National folk","Swing","Fast fusion","Bebop","Latin","Revival","Celtic","Bluegrass","Avantgarde","Gothic rock","Progressive rock","Psychedelic rock","Symphonic rock","Slow rock","Big band","Chorus","Easy listening","Acoustic","Humour","Speech","Chanson","Opera","Chamber music","Sonata","Symphony","Booty bass","Primus","Porn groove","Satire","Slow jam","Club","Tango","Samba","Folklore","Ballad","Power ballad","Rhythmic Soul","Freestyle","Duet","Punk rock","Drum solo","A cappella","Euro-house","Dance hall","Goa music","Drum & bass","Club-house","Hardcore techno","Terror","Indie","Britpop","Negerpunk","Polsk punk","Beat","Christian gangsta rap","Heavy metal","Black metal","Crossover","Contemporary Christian","Christian rock","Merengue","Salsa","Thrash metal","Anime","Jpop","Synthpop","Christmas","Art rock","Baroque","Bhangra","Big beat","Breakbeat","Chillout","Downtempo","Dub","EBM","Eclectic","Electro","Electroclash","Emo","Experimental","Garage","Global","IDM","Illbient","Industro-Goth","Jam Band","Krautrock","Leftfield","Lounge","Math rock","New romantic","Nu-breakz","Post-punk","Post-rock","Psytrance","Shoegaze","Space rock","Trop rock","World music","Neoclassical","Audiobook","Audio theatre","Neue Deutsche Welle","Podcast","Indie rock","G-Funk","Dubstep","Garage rock","Psybient"],Ea=(r,e)=>{const t=r.filePos;e.raw??={},e.raw.TAG??=F(r,tt-3),r.filePos=t;const a=_e(r,30);a&&(e.title??=a);const n=_e(r,30);n&&(e.artist??=n);const s=_e(r,30);s&&(e.album??=s);const i=_e(r,4),o=Number.parseInt(i,10);Number.isInteger(o)&&o>0&&(e.date??=new Date(o,0,1));const c=F(r,30);let l;if(c[28]===0&&c[29]!==0){const u=c[29];u>0&&(e.trackNumber??=u),r.skip(-30),l=_e(r,28),r.skip(2)}else r.skip(-30),l=_e(r,30);l&&(e.comment??=l);const d=D(r);d<Ce.length&&(e.genre??=Ce[d])},_e=(r,e)=>{const t=F(r,e),a=ge(t.indexOf(0),t.length),n=t.subarray(0,a);let s="";for(let i=0;i<n.length;i++)s+=String.fromCharCode(n[i]);return s.trimEnd()},at=r=>{const e=r.filePos,t=M(r,3),a=D(r),n=D(r),s=D(r),i=P(r);if(t!=="ID3"||a===255||n===255||(i&2155905152)!==0)return r.filePos=e,null;const o=It(i);return{majorVersion:a,revision:n,flags:s,size:o}},Tr=(r,e,t)=>{if(![2,3,4].includes(e.majorVersion)){console.warn(`Unsupported ID3v2 major version: ${e.majorVersion}`);return}const a=F(r,e.size),n=new Ba(e,a);if(e.flags&xe.Footer&&n.removeFooter(),e.flags&xe.Unsynchronisation&&e.majorVersion===3&&n.ununsynchronizeAll(),e.flags&xe.ExtendedHeader){const s=n.readU32();e.majorVersion===3?n.pos+=s:n.pos+=s-4}for(;n.pos<=n.bytes.length-n.frameHeaderSize();){const s=n.readId3V2Frame();if(!s)break;const i=n.pos,o=n.pos+s.size;let c=!1,l=!1,d=!1;if(e.majorVersion===3?(c=!!(s.flags&64),l=!!(s.flags&128)):e.majorVersion===4&&(c=!!(s.flags&4),l=!!(s.flags&8),d=!!(s.flags&2)||!!(e.flags&xe.Unsynchronisation)),c){console.warn(`Skipping encrypted ID3v2 frame ${s.id}`),n.pos=o;continue}if(l){console.warn(`Skipping compressed ID3v2 frame ${s.id}`),n.pos=o;continue}switch(d&&n.ununsynchronizeRegion(n.pos,o),t.raw??={},s.id[0]==="T"?t.raw[s.id]??=n.readId3V2EncodingAndText(o):t.raw[s.id]??=n.readBytes(s.size),n.pos=i,s.id){case"TIT2":case"TT2":t.title??=n.readId3V2EncodingAndText(o);break;case"TIT3":case"TT3":t.description??=n.readId3V2EncodingAndText(o);break;case"TPE1":case"TP1":t.artist??=n.readId3V2EncodingAndText(o);break;case"TALB":case"TAL":t.album??=n.readId3V2EncodingAndText(o);break;case"TPE2":case"TP2":t.albumArtist??=n.readId3V2EncodingAndText(o);break;case"TRCK":case"TRK":{const f=n.readId3V2EncodingAndText(o).split("/"),h=Number.parseInt(f[0],10),m=f[1]&&Number.parseInt(f[1],10);Number.isInteger(h)&&h>0&&(t.trackNumber??=h),m&&Number.isInteger(m)&&m>0&&(t.tracksTotal??=m)}break;case"TPOS":case"TPA":{const f=n.readId3V2EncodingAndText(o).split("/"),h=Number.parseInt(f[0],10),m=f[1]&&Number.parseInt(f[1],10);Number.isInteger(h)&&h>0&&(t.discNumber??=h),m&&Number.isInteger(m)&&m>0&&(t.discsTotal??=m)}break;case"TCON":case"TCO":{const u=n.readId3V2EncodingAndText(o);let f=/^\((\d+)\)/.exec(u);if(f){const h=Number.parseInt(f[1]);if(Ce[h]!==void 0){t.genre??=Ce[h];break}}if(f=/^\d+$/.exec(u),f){const h=Number.parseInt(f[0]);if(Ce[h]!==void 0){t.genre??=Ce[h];break}}t.genre??=u}break;case"TDRC":case"TDAT":{const u=n.readId3V2EncodingAndText(o),f=new Date(u);Number.isNaN(f.getTime())||(t.date??=f)}break;case"TYER":case"TYE":{const u=n.readId3V2EncodingAndText(o),f=Number.parseInt(u,10);Number.isInteger(f)&&(t.date??=new Date(f,0,1))}break;case"USLT":case"ULT":{const u=n.readU8();n.pos+=3,n.readId3V2Text(u,o),t.lyrics??=n.readId3V2Text(u,o)}break;case"COMM":case"COM":{const u=n.readU8();n.pos+=3,n.readId3V2Text(u,o),t.comment??=n.readId3V2Text(u,o)}break;case"APIC":case"PIC":{const u=n.readId3V2TextEncoding();let f;if(e.majorVersion===2){const b=n.readAscii(3);f=b==="PNG"?"image/png":b==="JPG"?"image/jpeg":"image/*"}else f=n.readId3V2Text(u,o);const h=n.readU8(),m=n.readId3V2Text(u,o).trimEnd(),k=o-n.pos;if(k>=0){const b=n.readBytes(k);t.images||(t.images=[]),t.images.push({data:b,mimeType:f,kind:h===3?"coverFront":h===4?"coverBack":"unknown",description:m})}}break;default:n.pos+=s.size;break}n.pos=o}};class Ba{constructor(e,t){this.header=e,this.bytes=t,this.pos=0,this.view=new DataView(t.buffer,t.byteOffset,t.byteLength)}frameHeaderSize(){return this.header.majorVersion===2?6:10}ununsynchronizeAll(){const e=[];for(let t=0;t<this.bytes.length;t++){const a=this.bytes[t];e.push(a),a===255&&t!==this.bytes.length-1&&this.bytes[t]===0&&t++}this.bytes=new Uint8Array(e),this.view=new DataView(this.bytes.buffer)}ununsynchronizeRegion(e,t){const a=[];for(let i=e;i<t;i++){const o=this.bytes[i];a.push(o),o===255&&i!==t-1&&this.bytes[i+1]===0&&i++}const n=this.bytes.subarray(0,e),s=this.bytes.subarray(t);this.bytes=new Uint8Array(n.length+a.length+s.length),this.bytes.set(n,0),this.bytes.set(a,n.length),this.bytes.set(s,n.length+a.length),this.view=new DataView(this.bytes.buffer)}removeFooter(){this.bytes=this.bytes.subarray(0,this.bytes.length-rt),this.view=new DataView(this.bytes.buffer)}readBytes(e){const t=this.bytes.subarray(this.pos,this.pos+e);return this.pos+=e,t}readU8(){const e=this.view.getUint8(this.pos);return this.pos+=1,e}readU16(){const e=this.view.getUint16(this.pos,!1);return this.pos+=2,e}readU24(){const e=this.view.getUint16(this.pos,!1),t=this.view.getUint8(this.pos+1);return this.pos+=3,e*256+t}readU32(){const e=this.view.getUint32(this.pos,!1);return this.pos+=4,e}readAscii(e){let t="";for(let a=0;a<e;a++)t+=String.fromCharCode(this.view.getUint8(this.pos+a));return this.pos+=e,t}readId3V2Frame(){if(this.header.majorVersion===2){const e=this.readAscii(3);if(e==="\0\0\0")return null;const t=this.readU24();return{id:e,size:t,flags:0}}else{const e=this.readAscii(4);if(e==="\0\0\0\0")return null;const t=this.readU32();let a=this.header.majorVersion===4?It(t):t;const n=this.readU16(),s=this.pos,i=o=>{const c=this.pos+o;if(c>this.bytes.length)return!1;if(c<=this.bytes.length-this.frameHeaderSize()){this.pos+=o;const l=this.readAscii(4);if(l!=="\0\0\0\0"&&!/[0-9A-Z]{4}/.test(l))return!1}return!0};if(!i(a)){const o=this.header.majorVersion===4?t:It(t);i(o)&&(a=o)}return this.pos=s,{id:e,size:a,flags:n}}}readId3V2TextEncoding(){const e=this.readU8();if(e>3)throw new Error(`Unsupported text encoding: ${e}`);return e}readId3V2Text(e,t){const a=this.pos,n=this.readBytes(t-this.pos);switch(e){case Ie.ISO_8859_1:{let s="";for(let i=0;i<n.length;i++){const o=n[i];if(o===0){this.pos=a+i+1;break}s+=String.fromCharCode(o)}return s}case Ie.UTF_16_WITH_BOM:if(n[0]===255&&n[1]===254){const s=new TextDecoder("utf-16le"),i=ge(n.findIndex((o,c)=>o===0&&n[c+1]===0&&c%2===0),n.length);return this.pos=a+Math.min(i+2,n.length),s.decode(n.subarray(2,i))}else if(n[0]===254&&n[1]===255){const s=new TextDecoder("utf-16be"),i=ge(n.findIndex((o,c)=>o===0&&n[c+1]===0&&c%2===0),n.length);return this.pos=a+Math.min(i+2,n.length),s.decode(n.subarray(2,i))}else{const s=ge(n.findIndex(i=>i===0),n.length);return this.pos=a+Math.min(s+1,n.length),K.decode(n.subarray(0,s))}case Ie.UTF_16_BE_NO_BOM:{const s=new TextDecoder("utf-16be"),i=ge(n.findIndex((o,c)=>o===0&&n[c+1]===0&&c%2===0),n.length);return this.pos=a+Math.min(i+2,n.length),s.decode(n.subarray(0,i))}case Ie.UTF_8:{const s=ge(n.findIndex(i=>i===0),n.length);return this.pos=a+Math.min(s+1,n.length),K.decode(n.subarray(0,s))}}}readId3V2EncodingAndText(e){if(this.pos>=e)return"";const t=this.readId3V2TextEncoding();return this.readId3V2Text(t,e)}}const Ct=async(r,e,t)=>{let a=e;for(;t===null||a<t;){let n=r.requestSlice(a,br);if(n instanceof Promise&&(n=await n),!n)break;const s=P(n),i=Aa(s,r.fileSize!==null?r.fileSize-a:null);if(i.header)return{header:i.header,startPos:a};a+=i.bytesAdvanced}return null};class Ra extends de{constructor(e){super(e),this.metadataPromise=null,this.firstFrameHeader=null,this.loadedSamples=[],this.metadataTags=null,this.tracks=[],this.readingMutex=new Ke,this.lastSampleLoaded=!1,this.lastLoadedPos=0,this.nextTimestampInSamples=0,this.reader=e._reader}async readMetadata(){return this.metadataPromise??=(async()=>{for(;!this.firstFrameHeader&&!this.lastSampleLoaded;)await this.advanceReader();if(!this.firstFrameHeader)throw new Error("No valid MP3 frame found.");this.tracks=[new se(this.input,new za(this))]})()}async advanceReader(){if(this.lastLoadedPos===0)for(;;){let o=this.reader.requestSlice(this.lastLoadedPos,rt);if(o instanceof Promise&&(o=await o),!o){this.lastSampleLoaded=!0;return}const c=at(o);if(!c)break;this.lastLoadedPos=o.filePos+c.size}const e=await Ct(this.reader,this.lastLoadedPos,this.reader.fileSize);if(!e){this.lastSampleLoaded=!0;return}const t=e.header;this.lastLoadedPos=e.startPos+t.totalSize-1;const a=Fa(t.mpegVersionId,t.channel);let n=this.reader.requestSlice(e.startPos+a,4);if(n instanceof Promise&&(n=await n),n){const o=P(n);if(o===_a||o===va)return}this.firstFrameHeader||(this.firstFrameHeader=t),t.sampleRate!==this.firstFrameHeader.sampleRate&&console.warn(`MP3 changed sample rate mid-file: ${this.firstFrameHeader.sampleRate} Hz to ${t.sampleRate} Hz. Might be a bug, so please report this file.`);const s=t.audioSamplesInFrame/this.firstFrameHeader.sampleRate,i={timestamp:this.nextTimestampInSamples/this.firstFrameHeader.sampleRate,duration:s,dataStart:e.startPos,dataSize:t.totalSize};this.loadedSamples.push(i),this.nextTimestampInSamples+=t.audioSamplesInFrame}async getMimeType(){return"audio/mpeg"}async getTracks(){return await this.readMetadata(),this.tracks}async computeDuration(){await this.readMetadata();const e=this.tracks[0];return p(e),e.computeDuration()}async getMetadataTags(){const e=await this.readingMutex.acquire();try{if(await this.readMetadata(),this.metadataTags)return this.metadataTags;this.metadataTags={};let t=0,a=!1;for(;;){let n=this.reader.requestSlice(t,rt);if(n instanceof Promise&&(n=await n),!n)break;const s=at(n);if(!s)break;a=!0;let i=this.reader.requestSlice(n.filePos,s.size);if(i instanceof Promise&&(i=await i),!i)break;Tr(i,s,this.metadataTags),t=n.filePos+s.size}if(!a&&this.reader.fileSize!==null&&this.reader.fileSize>=tt){let n=this.reader.requestSlice(this.reader.fileSize-tt,tt);n instanceof Promise&&(n=await n),p(n),M(n,3)==="TAG"&&Ea(n,this.metadataTags)}return this.metadataTags}finally{e()}}}class za{constructor(e){this.demuxer=e}getId(){return 1}async getFirstTimestamp(){return 0}getTimeResolution(){return p(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.sampleRate/this.demuxer.firstFrameHeader.audioSamplesInFrame}async computeDuration(){const e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getName(){return null}getLanguageCode(){return Q}getCodec(){return"mp3"}getInternalCodecId(){return null}getNumberOfChannels(){return p(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.channel===3?1:2}getSampleRate(){return p(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.sampleRate}async getDecoderConfig(){return p(this.demuxer.firstFrameHeader),{codec:"mp3",numberOfChannels:this.demuxer.firstFrameHeader.channel===3?1:2,sampleRate:this.demuxer.firstFrameHeader.sampleRate}}async getPacketAtIndex(e,t){if(e===-1)return null;const a=this.demuxer.loadedSamples[e];if(!a)return null;let n;if(t.metadataOnly)n=j;else{let s=this.demuxer.reader.requestSlice(a.dataStart,a.dataSize);if(s instanceof Promise&&(s=await s),!s)return null;n=F(s,a.dataSize)}return new O(n,"key",a.timestamp,a.duration,e,a.dataSize)}getFirstPacket(e){return this.getPacketAtIndex(0,e)}async getNextPacket(e,t){const a=await this.demuxer.readingMutex.acquire();try{const n=ot(this.demuxer.loadedSamples,e.timestamp,i=>i.timestamp);if(n===-1)throw new Error("Packet was not created from this track.");const s=n+1;for(;s>=this.demuxer.loadedSamples.length&&!this.demuxer.lastSampleLoaded;)await this.demuxer.advanceReader();return this.getPacketAtIndex(s,t)}finally{a()}}async getPacket(e,t){const a=await this.demuxer.readingMutex.acquire();try{for(;;){const n=z(this.demuxer.loadedSamples,e,s=>s.timestamp);if(n===-1&&this.demuxer.loadedSamples.length>0)return null;if(this.demuxer.lastSampleLoaded)return this.getPacketAtIndex(n,t);if(n>=0&&n+1<this.demuxer.loadedSamples.length)return this.getPacketAtIndex(n,t);await this.demuxer.advanceReader()}}finally{a()}}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}}const Sr=1399285583,Na=79764919,yr=new Uint32Array(256);for(let r=0;r<256;r++){let e=r<<24;for(let t=0;t<8;t++)e=e&2147483648?e<<1^Na:e<<1;yr[r]=e>>>0&4294967295}const Oa=r=>{const e=V(r),t=e.getUint32(22,!0);e.setUint32(22,0,!0);let a=0;for(let n=0;n<r.length;n++){const s=r[n];a=(a<<8^yr[a>>>24^s])>>>0}return e.setUint32(22,t,!0),a},Ma=(r,e,t)=>{let a=0,n=null;if(r.length>0)if(e.codec==="vorbis"){p(e.vorbisInfo);const s=e.vorbisInfo.modeBlockflags.length,o=(1<<Br(s-1))-1<<1,c=(r[0]&o)>>1;if(c>=e.vorbisInfo.modeBlockflags.length)throw new Error("Invalid mode number.");let l=t;const d=e.vorbisInfo.modeBlockflags[c];if(n=e.vorbisInfo.blocksizes[d],d===1){const u=(o|1)+1,f=r[0]&u?1:0;l=e.vorbisInfo.blocksizes[f]}a=l!==null?l+n>>2:0}else e.codec==="opus"&&(a=Yr(r).durationInSamples);return{durationInSamples:a,vorbisBlockSize:n}},Ua=r=>{let e="audio/ogg";if(r.codecStrings){const t=[...new Set(r.codecStrings)];e+=`; codecs="${t.join(", ")}"`}return e};const he=27,ve=282,Va=ve+65025,qe=r=>{const e=r.filePos;if(Ee(r)!==Sr)return null;r.skip(1);const a=D(r),n=vn(r),s=Ee(r),i=Ee(r),o=Ee(r),c=D(r),l=new Uint8Array(c);for(let h=0;h<c;h++)l[h]=D(r);const d=27+c,u=l.reduce((h,m)=>h+m,0),f=d+u;return{headerStartPos:e,totalSize:f,dataStartPos:e+d,dataSize:u,headerType:a,granulePosition:n,serialNumber:s,sequenceNumber:i,checksum:o,lacingValues:l}},Ha=(r,e)=>{for(;r.filePos<e-3;){const t=Ee(r),a=t&255,n=t>>>8&255,s=t>>>16&255,i=t>>>24&255,o=79;if(!(a!==o&&n!==o&&s!==o&&i!==o)){if(r.skip(-4),t===Sr)return!0;r.skip(1)}}return!1};class qa extends de{constructor(e){super(e),this.metadataPromise=null,this.bitstreams=[],this.tracks=[],this.metadataTags={},this.reader=e._reader}async readMetadata(){return this.metadataPromise??=(async()=>{let e=0;for(;;){let t=this.reader.requestSliceRange(e,he,ve);if(t instanceof Promise&&(t=await t),!t)break;const a=qe(t);if(!a||!!!(a.headerType&2))break;this.bitstreams.push({serialNumber:a.serialNumber,bosPage:a,description:null,numberOfChannels:-1,sampleRate:-1,codecInfo:{codec:null,vorbisInfo:null,opusInfo:null},lastMetadataPacket:null}),e=a.headerStartPos+a.totalSize}for(const t of this.bitstreams){const a=await this.readPacket(t.bosPage,0);a&&(a.data.byteLength>=7&&a.data[0]===1&&a.data[1]===118&&a.data[2]===111&&a.data[3]===114&&a.data[4]===98&&a.data[5]===105&&a.data[6]===115?await this.readVorbisMetadata(a,t):a.data.byteLength>=8&&a.data[0]===79&&a.data[1]===112&&a.data[2]===117&&a.data[3]===115&&a.data[4]===72&&a.data[5]===101&&a.data[6]===97&&a.data[7]===100&&await this.readOpusMetadata(a,t),t.codecInfo.codec!==null&&this.tracks.push(new se(this.input,new La(t,this))))}})()}async readVorbisMetadata(e,t){let a=await this.findNextPacketStart(e);if(!a)return;const n=await this.readPacket(a.startPage,a.startSegmentIndex);if(!n||(a=await this.findNextPacketStart(n),!a))return;const s=await this.readPacket(a.startPage,a.startSegmentIndex);if(!s||n.data[0]!==3||s.data[0]!==5)return;const i=[],o=u=>{for(;i.push(Math.min(255,u)),!(u<255);)u-=255};o(e.data.length),o(n.data.length);const c=new Uint8Array(1+i.length+e.data.length+n.data.length+s.data.length);c[0]=2,c.set(i,1),c.set(e.data,1+i.length),c.set(n.data,1+i.length+e.data.length),c.set(s.data,1+i.length+e.data.length+n.data.length),t.codecInfo.codec="vorbis",t.description=c,t.lastMetadataPacket=s;const l=V(e.data);t.numberOfChannels=l.getUint8(11),t.sampleRate=l.getUint32(12,!0);const d=l.getUint8(28);t.codecInfo.vorbisInfo={blocksizes:[1<<(d&15),1<<(d>>4)],modeBlockflags:Jr(s.data).modeBlockflags},mt(n.data.subarray(7),this.metadataTags)}async readOpusMetadata(e,t){const a=await this.findNextPacketStart(e);if(!a)return;const n=await this.readPacket(a.startPage,a.startSegmentIndex);if(!n)return;t.codecInfo.codec="opus",t.description=e.data,t.lastMetadataPacket=n;const s=Xr(e.data);t.numberOfChannels=s.outputChannelCount,t.sampleRate=Ge,t.codecInfo.opusInfo={preSkip:s.preSkip},mt(n.data.subarray(8),this.metadataTags)}async readPacket(e,t){p(t<e.lacingValues.length);let a=0;for(let u=0;u<t;u++)a+=e.lacingValues[u];let n=e,s=a,i=t;const o=[];e:for(;;){let u=this.reader.requestSlice(n.dataStartPos,n.dataSize);u instanceof Promise&&(u=await u),p(u);const f=F(u,n.dataSize);for(;;){if(i===n.lacingValues.length){o.push(f.subarray(a,s));break}const m=n.lacingValues[i];if(s+=m,m<255){o.push(f.subarray(a,s));break e}i++}let h=n.headerStartPos+n.totalSize;for(;;){let m=this.reader.requestSliceRange(h,he,ve);if(m instanceof Promise&&(m=await m),!m)return null;const k=qe(m);if(!k)return null;if(n=k,n.serialNumber===e.serialNumber)break;h=n.headerStartPos+n.totalSize}a=0,s=0,i=0}const c=o.reduce((u,f)=>u+f.length,0),l=new Uint8Array(c);let d=0;for(let u=0;u<o.length;u++){const f=o[u];l.set(f,d),d+=f.length}return{data:l,endPage:n,endSegmentIndex:i}}async findNextPacketStart(e){if(e.endSegmentIndex<e.endPage.lacingValues.length-1)return{startPage:e.endPage,startSegmentIndex:e.endSegmentIndex+1};if(!!(e.endPage.headerType&4))return null;let a=e.endPage.headerStartPos+e.endPage.totalSize;for(;;){let n=this.reader.requestSliceRange(a,he,ve);if(n instanceof Promise&&(n=await n),!n)return null;const s=qe(n);if(!s)return null;if(s.serialNumber===e.endPage.serialNumber)return{startPage:s,startSegmentIndex:0};a=s.headerStartPos+s.totalSize}}async getMimeType(){await this.readMetadata();const e=await Promise.all(this.tracks.map(t=>t.getCodecParameterString()));return Ua({codecStrings:e.filter(Boolean)})}async getTracks(){return await this.readMetadata(),this.tracks}async computeDuration(){const e=await this.getTracks(),t=await Promise.all(e.map(a=>a.computeDuration()));return Math.max(0,...t)}async getMetadataTags(){return await this.readMetadata(),this.metadataTags}}class La{constructor(e,t){this.bitstream=e,this.demuxer=t,this.encodedPacketToMetadata=new WeakMap,this.sequentialScanCache=[],this.sequentialScanMutex=new Ke,this.internalSampleRate=e.codecInfo.codec==="opus"?Ge:e.sampleRate}getId(){return this.bitstream.serialNumber}getNumberOfChannels(){return this.bitstream.numberOfChannels}getSampleRate(){return this.bitstream.sampleRate}getTimeResolution(){return this.bitstream.sampleRate}getCodec(){return this.bitstream.codecInfo.codec}getInternalCodecId(){return null}async getDecoderConfig(){return p(this.bitstream.codecInfo.codec),{codec:this.bitstream.codecInfo.codec,numberOfChannels:this.bitstream.numberOfChannels,sampleRate:this.bitstream.sampleRate,description:this.bitstream.description??void 0}}getName(){return null}getLanguageCode(){return Q}async getFirstTimestamp(){return 0}async computeDuration(){const e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}granulePositionToTimestampInSamples(e){return this.bitstream.codecInfo.codec==="opus"?(p(this.bitstream.codecInfo.opusInfo),e-this.bitstream.codecInfo.opusInfo.preSkip):e}createEncodedPacketFromOggPacket(e,t,a){if(!e)return null;const{durationInSamples:n,vorbisBlockSize:s}=Ma(e.data,this.bitstream.codecInfo,t.vorbisLastBlocksize),i=new O(a.metadataOnly?j:e.data,"key",Math.max(0,t.timestampInSamples)/this.internalSampleRate,n/this.internalSampleRate,e.endPage.headerStartPos+e.endSegmentIndex,e.data.byteLength);return this.encodedPacketToMetadata.set(i,{packet:e,timestampInSamples:t.timestampInSamples,durationInSamples:n,vorbisLastBlockSize:t.vorbisLastBlocksize,vorbisBlockSize:s}),i}async getFirstPacket(e){p(this.bitstream.lastMetadataPacket);const t=await this.demuxer.findNextPacketStart(this.bitstream.lastMetadataPacket);if(!t)return null;let a=0;this.bitstream.codecInfo.codec==="opus"&&(p(this.bitstream.codecInfo.opusInfo),a-=this.bitstream.codecInfo.opusInfo.preSkip);const n=await this.demuxer.readPacket(t.startPage,t.startSegmentIndex);return this.createEncodedPacketFromOggPacket(n,{timestampInSamples:a,vorbisLastBlocksize:null},e)}async getNextPacket(e,t){const a=this.encodedPacketToMetadata.get(e);if(!a)throw new Error("Packet was not created from this track.");const n=await this.demuxer.findNextPacketStart(a.packet);if(!n)return null;const s=a.timestampInSamples+a.durationInSamples,i=await this.demuxer.readPacket(n.startPage,n.startSegmentIndex);return this.createEncodedPacketFromOggPacket(i,{timestampInSamples:s,vorbisLastBlocksize:a.vorbisBlockSize},t)}async getPacket(e,t){if(this.demuxer.reader.fileSize===null)return this.getPacketSequential(e,t);const a=je(e*this.internalSampleRate,14);if(a===0)return this.getFirstPacket(t);if(a<0)return null;p(this.bitstream.lastMetadataPacket);const n=await this.demuxer.findNextPacketStart(this.bitstream.lastMetadataPacket);if(!n)return null;let s=n.startPage,i=this.demuxer.reader.fileSize;const o=[s];e:for(;s.headerStartPos+s.totalSize<i;){const g=s.headerStartPos,w=Math.floor((g+i)/2);let y=w;for(;;){const I=Math.min(y+Va,i-he);let v=this.demuxer.reader.requestSlice(y,I-y);if(v instanceof Promise&&(v=await v),p(v),!Ha(v,I)){i=w+he;continue e}let C=this.demuxer.reader.requestSliceRange(v.filePos,he,ve);C instanceof Promise&&(C=await C),p(C);const A=qe(C);p(A);let R=!1;if(A.serialNumber===this.bitstream.serialNumber)R=!0;else{let X=this.demuxer.reader.requestSlice(A.headerStartPos,A.totalSize);X instanceof Promise&&(X=await X),p(X);const We=F(X,A.totalSize);R=Oa(We)===A.checksum}if(!R){y=A.headerStartPos+4;continue}if(R&&A.serialNumber!==this.bitstream.serialNumber){y=A.headerStartPos+A.totalSize;continue}if(A.granulePosition===-1){y=A.headerStartPos+A.totalSize;continue}this.granulePositionToTimestampInSamples(A.granulePosition)>a?i=A.headerStartPos:(s=A,o.push(A));continue e}}let c=n.startPage;for(const g of o){if(g.granulePosition===s.granulePosition)break;(!c||g.headerStartPos>c.headerStartPos)&&(c=g)}let l=c;const d=[l];for(;!(l.serialNumber===this.bitstream.serialNumber&&l.granulePosition===s.granulePosition);){const g=l.headerStartPos+l.totalSize;let w=this.demuxer.reader.requestSliceRange(g,he,ve);w instanceof Promise&&(w=await w),p(w);const y=qe(w);p(y),l=y,l.serialNumber===this.bitstream.serialNumber&&d.push(l)}p(l.granulePosition!==-1);let u=null,f,h,m=l,k=0;if(l.headerStartPos===n.startPage.headerStartPos)f=this.granulePositionToTimestampInSamples(0),h=!0,u=0;else{f=0,h=!1;for(let y=l.lacingValues.length-1;y>=0;y--)if(l.lacingValues[y]<255){u=y+1;break}if(u===null)throw new Error("Invalid page with granule position: no packets end on this page.");k=u-1;const g={data:j,endPage:m,endSegmentIndex:k};if(await this.demuxer.findNextPacketStart(g)){const y=Pr(d,l,u);p(y);const I=wr(d,y.page,y.segmentIndex);I&&(l=I.page,u=I.segmentIndex)}else for(;;){const y=Pr(d,l,u);if(!y)break;const I=wr(d,y.page,y.segmentIndex);if(!I)break;if(l=I.page,u=I.segmentIndex,y.page.headerStartPos!==m.headerStartPos){m=y.page,k=y.segmentIndex;break}}}let b=null,T=null;for(;l!==null;){p(u!==null);const g=await this.demuxer.readPacket(l,u);if(!g)break;if(!(l.headerStartPos===n.startPage.headerStartPos&&u<n.startSegmentIndex)){let I=this.createEncodedPacketFromOggPacket(g,{timestampInSamples:f,vorbisLastBlocksize:T?.vorbisBlockSize??null},t);p(I);let v=this.encodedPacketToMetadata.get(I);if(p(v),!h&&g.endPage.headerStartPos===m.headerStartPos&&g.endSegmentIndex===k?(f=this.granulePositionToTimestampInSamples(l.granulePosition),h=!0,I=this.createEncodedPacketFromOggPacket(g,{timestampInSamples:f-v.durationInSamples,vorbisLastBlocksize:T?.vorbisBlockSize??null},t),p(I),v=this.encodedPacketToMetadata.get(I),p(v)):f+=v.durationInSamples,b=I,T=v,h&&(Math.max(f,0)>a||Math.max(v.timestampInSamples,0)===a))break}const y=await this.demuxer.findNextPacketStart(g);if(!y)break;l=y.startPage,u=y.startSegmentIndex}return b}async getPacketSequential(e,t){const a=await this.sequentialScanMutex.acquire();try{const n=je(e*this.internalSampleRate,14);e=n/this.internalSampleRate;const s=z(this.sequentialScanCache,n,c=>c.timestampInSamples);let i;if(s!==-1){const c=this.sequentialScanCache[s];i=this.createEncodedPacketFromOggPacket(c.packet,{timestampInSamples:c.timestampInSamples,vorbisLastBlocksize:c.vorbisLastBlockSize},t)}else i=await this.getFirstPacket(t);let o=0;for(;i&&i.timestamp<e;){const c=await this.getNextPacket(i,t);if(!c||c.timestamp>e)break;if(i=c,o++,o===100){o=0;const l=this.encodedPacketToMetadata.get(i);p(l),this.sequentialScanCache.length>0&&p(J(this.sequentialScanCache).timestampInSamples<=l.timestampInSamples),this.sequentialScanCache.push(l)}}return i}finally{a()}}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}}const wr=(r,e,t)=>{let a=e,n=t;e:for(;;){for(n--,n;n>=0;n--)if(a.lacingValues[n]<255){n++;break e}if(p(n===-1),!(a.headerType&1)){n=0;break}const i=Vt(r,o=>o.headerStartPos<a.headerStartPos);if(!i)return null;a=i,n=a.lacingValues.length}if(p(n!==-1),n===a.lacingValues.length){const s=r[r.indexOf(a)+1];p(s),a=s,n=0}return{page:a,segmentIndex:n}},Pr=(r,e,t)=>{if(t>0)return{page:e,segmentIndex:t-1};const a=Vt(r,n=>n.headerStartPos<e.headerStartPos);return a?{page:a,segmentIndex:a.lacingValues.length-1}:null};var ae;(function(r){r[r.PCM=1]="PCM",r[r.IEEE_FLOAT=3]="IEEE_FLOAT",r[r.ALAW=6]="ALAW",r[r.MULAW=7]="MULAW",r[r.EXTENSIBLE=65534]="EXTENSIBLE"})(ae||(ae={}));class Wa extends de{constructor(e){super(e),this.metadataPromise=null,this.dataStart=-1,this.dataSize=-1,this.audioInfo=null,this.tracks=[],this.lastKnownPacketIndex=0,this.metadataTags={},this.reader=e._reader}async readMetadata(){return this.metadataPromise??=(async()=>{let e=this.reader.requestSlice(0,12);e instanceof Promise&&(e=await e),p(e);const t=M(e,4),a=t!=="RIFX",n=t==="RF64",s=ue(e,a);let i=n?this.reader.fileSize:Math.min(s+8,this.reader.fileSize??1/0);if(M(e,4)!=="WAVE")throw new Error("Invalid WAVE file - wrong format");let c=0,l=null,d=e.filePos;for(;i===null||d<i;){let f=this.reader.requestSlice(d,8);if(f instanceof Promise&&(f=await f),!f)break;const h=M(f,4),m=ue(f,a),k=f.filePos;if(n&&c===0&&h!=="ds64")throw new Error('Invalid RF64 file: First chunk must be "ds64".');if(h==="fmt ")await this.parseFmtChunk(k,m,a);else if(h==="data"){if(l??=m,this.dataStart=f.filePos,this.dataSize=Math.min(l,(i??1/0)-this.dataStart),this.reader.fileSize===null)break}else if(h==="ds64"){let b=this.reader.requestSlice(k,m);if(b instanceof Promise&&(b=await b),!b)break;const T=_r(b,a);l=_r(b,a),i=Math.min(T+8,this.reader.fileSize??1/0)}else h==="LIST"?await this.parseListChunk(k,m,a):(h==="ID3 "||h==="id3 ")&&await this.parseId3Chunk(k,m);d=k+m+(m&1),c++}if(!this.audioInfo)throw new Error('Invalid WAVE file - missing "fmt " chunk');if(this.dataStart===-1)throw new Error('Invalid WAVE file - missing "data" chunk');const u=this.audioInfo.blockSizeInBytes;this.dataSize=Math.floor(this.dataSize/u)*u,this.tracks.push(new se(this.input,new Ka(this)))})()}async parseFmtChunk(e,t,a){let n=this.reader.requestSlice(e,t);if(n instanceof Promise&&(n=await n),!n)return;let s=Le(n,a);const i=Le(n,a),o=ue(n,a);n.skip(4);const c=Le(n,a);let l;if(t===14?l=8:l=Le(n,a),t>=18&&s!==357){const d=Le(n,a),u=t-18;if(Math.min(u,d)>=22&&s===ae.EXTENSIBLE){n.skip(6);const h=F(n,16);s=h[0]|h[1]<<8}}(s===ae.MULAW||s===ae.ALAW)&&(l=8),this.audioInfo={format:s,numberOfChannels:i,sampleRate:o,sampleSizeInBytes:Math.ceil(l/8),blockSizeInBytes:c}}async parseListChunk(e,t,a){let n=this.reader.requestSlice(e,t);if(n instanceof Promise&&(n=await n),!n)return;const s=M(n,4);if(s!=="INFO"&&s!=="INF0")return;let i=n.filePos;for(;i<=e+t-8;){n.filePos=i;const o=M(n,4),c=ue(n,a),l=F(n,c);let d=0;for(let f=0;f<l.length&&l[f]!==0;f++)d++;const u=String.fromCharCode(...l.subarray(0,d));switch(this.metadataTags.raw??={},this.metadataTags.raw[o]=u,o){case"INAM":case"TITL":this.metadataTags.title??=u;break;case"TIT3":this.metadataTags.description??=u;break;case"IART":this.metadataTags.artist??=u;break;case"IPRD":this.metadataTags.album??=u;break;case"IPRT":case"ITRK":case"TRCK":{const f=u.split("/"),h=Number.parseInt(f[0],10),m=f[1]&&Number.parseInt(f[1],10);Number.isInteger(h)&&h>0&&(this.metadataTags.trackNumber??=h),m&&Number.isInteger(m)&&m>0&&(this.metadataTags.tracksTotal??=m)}break;case"ICRD":case"IDIT":{const f=new Date(u);Number.isNaN(f.getTime())||(this.metadataTags.date??=f)}break;case"YEAR":{const f=Number.parseInt(u,10);Number.isInteger(f)&&f>0&&(this.metadataTags.date??=new Date(f,0,1))}break;case"IGNR":case"GENR":this.metadataTags.genre??=u;break;case"ICMT":case"CMNT":case"COMM":this.metadataTags.comment??=u;break}i+=8+c+(c&1)}}async parseId3Chunk(e,t){let a=this.reader.requestSlice(e,t);if(a instanceof Promise&&(a=await a),!a)return;const n=at(a);if(n){const s=a.slice(e+10,n.size);Tr(s,n,this.metadataTags)}}getCodec(){if(p(this.audioInfo),this.audioInfo.format===ae.MULAW)return"ulaw";if(this.audioInfo.format===ae.ALAW)return"alaw";if(this.audioInfo.format===ae.PCM){if(this.audioInfo.sampleSizeInBytes===1)return"pcm-u8";if(this.audioInfo.sampleSizeInBytes===2)return"pcm-s16";if(this.audioInfo.sampleSizeInBytes===3)return"pcm-s24";if(this.audioInfo.sampleSizeInBytes===4)return"pcm-s32"}return this.audioInfo.format===ae.IEEE_FLOAT&&this.audioInfo.sampleSizeInBytes===4?"pcm-f32":null}async getMimeType(){return"audio/wav"}async computeDuration(){await this.readMetadata();const e=this.tracks[0];return p(e),e.computeDuration()}async getTracks(){return await this.readMetadata(),this.tracks}async getMetadataTags(){return await this.readMetadata(),this.metadataTags}}const De=2048;class Ka{constructor(e){this.demuxer=e}getId(){return 1}getCodec(){return this.demuxer.getCodec()}getInternalCodecId(){return p(this.demuxer.audioInfo),this.demuxer.audioInfo.format}async getDecoderConfig(){const e=this.demuxer.getCodec();return e?(p(this.demuxer.audioInfo),{codec:e,numberOfChannels:this.demuxer.audioInfo.numberOfChannels,sampleRate:this.demuxer.audioInfo.sampleRate}):null}async computeDuration(){const e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getNumberOfChannels(){return p(this.demuxer.audioInfo),this.demuxer.audioInfo.numberOfChannels}getSampleRate(){return p(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}getTimeResolution(){return p(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}getName(){return null}getLanguageCode(){return Q}async getFirstTimestamp(){return 0}async getPacketAtIndex(e,t){p(this.demuxer.audioInfo);const a=e*De*this.demuxer.audioInfo.blockSizeInBytes;if(a>=this.demuxer.dataSize)return null;const n=Math.min(De*this.demuxer.audioInfo.blockSizeInBytes,this.demuxer.dataSize-a);if(this.demuxer.reader.fileSize===null){let c=this.demuxer.reader.requestSlice(this.demuxer.dataStart+a,n);if(c instanceof Promise&&(c=await c),!c)return null}let s;if(t.metadataOnly)s=j;else{let c=this.demuxer.reader.requestSlice(this.demuxer.dataStart+a,n);c instanceof Promise&&(c=await c),p(c),s=F(c,n)}const i=e*De/this.demuxer.audioInfo.sampleRate,o=n/this.demuxer.audioInfo.blockSizeInBytes/this.demuxer.audioInfo.sampleRate;return this.demuxer.lastKnownPacketIndex=Math.max(e,i),new O(s,"key",i,o,e,n)}getFirstPacket(e){return this.getPacketAtIndex(0,e)}async getPacket(e,t){p(this.demuxer.audioInfo);const a=Math.floor(Math.min(e*this.demuxer.audioInfo.sampleRate/De,(this.demuxer.dataSize-1)/(De*this.demuxer.audioInfo.blockSizeInBytes))),n=await this.getPacketAtIndex(a,t);if(n)return n;if(a===0)return null;p(this.demuxer.reader.fileSize===null);let s=await this.getPacketAtIndex(this.demuxer.lastKnownPacketIndex,t);for(;s;){const i=await this.getNextPacket(s,t);if(!i)break;s=i}return s}getNextPacket(e,t){p(this.demuxer.audioInfo);const a=Math.round(e.timestamp*this.demuxer.audioInfo.sampleRate/De);return this.getPacketAtIndex(a+1,t)}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}}const nt=7,it=9,_t=r=>{const e=r.filePos,t=F(r,9),a=new N(t);if(a.readBits(12)!==4095||(a.skipBits(1),a.readBits(2)!==0))return null;const i=a.readBits(1),o=a.readBits(2)+1,c=a.readBits(4);if(c===15)return null;a.skipBits(1);const l=a.readBits(3);if(l===0)throw new Error("ADTS frames with channel configuration 0 are not supported.");a.skipBits(1),a.skipBits(1),a.skipBits(1),a.skipBits(1);const d=a.readBits(13);a.skipBits(11);const u=a.readBits(2)+1;if(u!==1)throw new Error("ADTS frames with more than one AAC frame are not supported.");let f=null;return i===1?r.filePos-=2:f=a.readBits(16),{objectType:o,samplingFrequencyIndex:c,channelConfiguration:l,frameLength:d,numberOfAacFrames:u,crcCheck:f,startPos:e}};const vt=1024;class ja extends de{constructor(e){super(e),this.metadataPromise=null,this.firstFrameHeader=null,this.loadedSamples=[],this.tracks=[],this.readingMutex=new Ke,this.lastSampleLoaded=!1,this.lastLoadedPos=0,this.nextTimestampInSamples=0,this.reader=e._reader}async readMetadata(){return this.metadataPromise??=(async()=>{for(;!this.firstFrameHeader&&!this.lastSampleLoaded;)await this.advanceReader();p(this.firstFrameHeader),this.tracks=[new se(this.input,new Qa(this))]})()}async advanceReader(){let e=this.reader.requestSliceRange(this.lastLoadedPos,nt,it);if(e instanceof Promise&&(e=await e),!e){this.lastSampleLoaded=!0;return}const t=_t(e);if(!t){this.lastSampleLoaded=!0;return}if(this.reader.fileSize!==null&&t.startPos+t.frameLength>this.reader.fileSize){this.lastSampleLoaded=!0;return}this.firstFrameHeader||(this.firstFrameHeader=t);const a=$e[t.samplingFrequencyIndex];p(a!==void 0);const n=vt/a,s=t.crcCheck?it:nt,i={timestamp:this.nextTimestampInSamples/a,duration:n,dataStart:t.startPos+s,dataSize:t.frameLength-s};this.loadedSamples.push(i),this.nextTimestampInSamples+=vt,this.lastLoadedPos=t.startPos+t.frameLength}async getMimeType(){return"audio/aac"}async getTracks(){return await this.readMetadata(),this.tracks}async computeDuration(){await this.readMetadata();const e=this.tracks[0];return p(e),e.computeDuration()}async getMetadataTags(){return{}}}class Qa{constructor(e){this.demuxer=e}getId(){return 1}async getFirstTimestamp(){return 0}getTimeResolution(){return this.getSampleRate()/vt}async computeDuration(){const e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getName(){return null}getLanguageCode(){return Q}getCodec(){return"aac"}getInternalCodecId(){return p(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.objectType}getNumberOfChannels(){p(this.demuxer.firstFrameHeader);const e=Yt[this.demuxer.firstFrameHeader.channelConfiguration];return p(e!==void 0),e}getSampleRate(){p(this.demuxer.firstFrameHeader);const e=$e[this.demuxer.firstFrameHeader.samplingFrequencyIndex];return p(e!==void 0),e}async getDecoderConfig(){p(this.demuxer.firstFrameHeader);const e=new Uint8Array(3),t=new N(e),{objectType:a,samplingFrequencyIndex:n,channelConfiguration:s}=this.demuxer.firstFrameHeader;return a>31?(t.writeBits(5,31),t.writeBits(6,a-32)):t.writeBits(5,a),t.writeBits(4,n),t.writeBits(4,s),{codec:`mp4a.40.${this.demuxer.firstFrameHeader.objectType}`,numberOfChannels:this.getNumberOfChannels(),sampleRate:this.getSampleRate(),description:e.subarray(0,Math.ceil((t.pos-1)/8))}}async getPacketAtIndex(e,t){if(e===-1)return null;const a=this.demuxer.loadedSamples[e];if(!a)return null;let n;if(t.metadataOnly)n=j;else{let s=this.demuxer.reader.requestSlice(a.dataStart,a.dataSize);if(s instanceof Promise&&(s=await s),!s)return null;n=F(s,a.dataSize)}return new O(n,"key",a.timestamp,a.duration,e,a.dataSize)}getFirstPacket(e){return this.getPacketAtIndex(0,e)}async getNextPacket(e,t){const a=await this.demuxer.readingMutex.acquire();try{const n=ot(this.demuxer.loadedSamples,e.timestamp,i=>i.timestamp);if(n===-1)throw new Error("Packet was not created from this track.");const s=n+1;for(;s>=this.demuxer.loadedSamples.length&&!this.demuxer.lastSampleLoaded;)await this.demuxer.advanceReader();return this.getPacketAtIndex(s,t)}finally{a()}}async getPacket(e,t){const a=await this.demuxer.readingMutex.acquire();try{for(;;){const n=z(this.demuxer.loadedSamples,e,s=>s.timestamp);if(n===-1&&this.demuxer.loadedSamples.length>0)return null;if(this.demuxer.lastSampleLoaded)return this.getPacketAtIndex(n,t);if(n>=0&&n+1<this.demuxer.loadedSamples.length)return this.getPacketAtIndex(n,t);await this.demuxer.advanceReader()}}finally{a()}}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}}const $a=r=>r===0?null:r===1?192:r>=2&&r<=5?144*2**r:r===6?"uncommon-u8":r===7?"uncommon-u16":r>=8&&r<=15?2**r:null,Ga=(r,e)=>{switch(r){case 0:return e;case 1:return 88200;case 2:return 176400;case 3:return 192e3;case 4:return 8e3;case 5:return 16e3;case 6:return 22050;case 7:return 24e3;case 8:return 32e3;case 9:return 44100;case 10:return 48e3;case 11:return 96e3;case 12:return"uncommon-u8";case 13:return"uncommon-u16";case 14:return"uncommon-u16-10";default:return null}},Xa=r=>{let e=0;const t=new N(F(r,1));for(;t.readBits(1)===1;)e++;if(e===0)return t.readBits(7);const a=[],n=e-1,s=new N(F(r,n)),i=8-e-1;for(let c=0;c<i;c++)a.unshift(t.readBits(1));for(let c=0;c<n;c++)for(let l=0;l<8;l++){const d=s.readBits(1);l<2||a.unshift(d)}return a.reduce((c,l,d)=>c|l<<d,0)},Za=(r,e)=>{if(e==="uncommon-u16")return U(r)+1;if(e==="uncommon-u8")return D(r)+1;if(typeof e=="number")return e;ct(e),p(!1)},Ya=(r,e)=>e==="uncommon-u16"?U(r):e==="uncommon-u16-10"?U(r)*10:e==="uncommon-u8"?D(r):typeof e=="number"?e:null,Ja=r=>{let t=0;for(const a of r){t^=a;for(let n=0;n<8;n++)(t&128)!==0?t=t<<1^7:t<<=1,t&=255}return t};class en extends de{constructor(e){super(e),this.loadedSamples=[],this.metadataPromise=null,this.track=null,this.metadataTags={},this.audioInfo=null,this.lastLoadedPos=null,this.blockingBit=null,this.readingMutex=new Ke,this.lastSampleLoaded=!1,this.reader=e._reader}async computeDuration(){return await this.readMetadata(),p(this.track),this.track.computeDuration()}async getMetadataTags(){return await this.readMetadata(),this.metadataTags}async getTracks(){return await this.readMetadata(),p(this.track),[this.track]}async getMimeType(){return"audio/flac"}async readMetadata(){let e=4;return this.metadataPromise??=(async()=>{for(;this.reader.fileSize===null||e<this.reader.fileSize;){let t=this.reader.requestSlice(e,4);if(t instanceof Promise&&(t=await t),e+=4,t===null)throw new Error(`Metadata block at position ${e} is too small! Corrupted file.`);p(t);const a=D(t),n=Ae(t),s=(a&128)!==0;switch(a&127){case Te.STREAMINFO:{let o=this.reader.requestSlice(e,n);if(o instanceof Promise&&(o=await o),p(o),o===null)throw new Error(`StreamInfo block at position ${e} is too small! Corrupted file.`);const c=F(o,34),l=new N(c),d=l.readBits(16),u=l.readBits(16),f=l.readBits(24),h=l.readBits(24),m=l.readBits(20),k=l.readBits(3)+1;l.readBits(5);const b=l.readBits(36);l.skipBits(128);const T=new Uint8Array(42);T.set(new Uint8Array([102,76,97,67]),0),T.set(new Uint8Array([128,0,0,34]),4),T.set(c,8),this.audioInfo={numberOfChannels:k,sampleRate:m,totalSamples:b,minimumBlockSize:d,maximumBlockSize:u,minimumFrameSize:f,maximumFrameSize:h,description:T},this.track=new se(this.input,new tn(this));break}case Te.VORBIS_COMMENT:{let o=this.reader.requestSlice(e,n);o instanceof Promise&&(o=await o),p(o),mt(F(o,n),this.metadataTags);break}case Te.PICTURE:{let o=this.reader.requestSlice(e,n);o instanceof Promise&&(o=await o),p(o);const c=P(o),l=P(o),d=K.decode(F(o,l)),u=P(o),f=K.decode(F(o,u));o.skip(16);const h=P(o),m=F(o,h);this.metadataTags.images??=[],this.metadataTags.images.push({data:m,mimeType:d,kind:c===3?"coverFront":c===4?"coverBack":"unknown",description:f});break}}if(e+=n,s){this.lastLoadedPos=e;break}}})()}async readNextFlacFrame({startPos:e,isFirstPacket:t}){p(this.audioInfo);const a=6,s=this.audioInfo.maximumFrameSize+16,i=await this.reader.requestSliceRange(e,this.audioInfo.minimumFrameSize,s);if(!i)return null;const o=this.readFlacFrameHeader({slice:i,isFirstPacket:t});if(!o)return null;for(i.filePos=e+this.audioInfo.minimumFrameSize;;){if(i.filePos>i.end-a)return{num:o.num,blockSize:o.blockSize,sampleRate:o.sampleRate,size:i.end-e,isLastFrame:!0};if(D(i)===255){const l=D(i),d=this.blockingBit===1?249:248;if(l!==d){i.skip(-1);continue}i.skip(-2);const u=i.filePos-e,f=this.readFlacFrameHeader({slice:i,isFirstPacket:!1});if(!f){i.skip(-1);continue}if(this.blockingBit===0){if(f.num-o.num!==1){i.skip(-1);continue}}else if(f.num-o.num!==o.blockSize){i.skip(-1);continue}return{num:o.num,blockSize:o.blockSize,sampleRate:o.sampleRate,size:u,isLastFrame:!1}}}}readFlacFrameHeader({slice:e,isFirstPacket:t}){const a=e.filePos,n=F(e,4),s=new N(n);if(s.readBits(15)!==32764)return null;if(this.blockingBit===null){p(t);const b=s.readBits(1);this.blockingBit=b}else if(this.blockingBit===1){if(p(!t),s.readBits(1)!==1)return null}else if(this.blockingBit===0){if(p(!t),s.readBits(1)!==0)return null}else throw new Error("Invalid blocking bit");const o=$a(s.readBits(4));if(!o)return null;p(this.audioInfo);const c=Ga(s.readBits(4),this.audioInfo.sampleRate);if(!c||(s.readBits(4),s.readBits(3),s.readBits(1)!==0))return null;const d=Xa(e),u=Za(e,o),f=Ya(e,c);if(f===null||f!==this.audioInfo.sampleRate)return null;const h=e.filePos-a,m=D(e);e.skip(-h),e.skip(-1);const k=Ja(F(e,h));return m!==k?null:{num:d,blockSize:u,sampleRate:f}}async advanceReader(){await this.readMetadata(),p(this.lastLoadedPos!==null),p(this.audioInfo);const e=this.lastLoadedPos,t=await this.readNextFlacFrame({startPos:e,isFirstPacket:this.loadedSamples.length===0});if(!t){this.lastSampleLoaded=!0;return}const a=this.loadedSamples[this.loadedSamples.length-1],s={blockOffset:a?a.blockOffset+a.blockSize:0,blockSize:t.blockSize,byteOffset:e,byteSize:t.size};if(this.lastLoadedPos=this.lastLoadedPos+t.size,this.loadedSamples.push(s),t.isLastFrame){this.lastSampleLoaded=!0;return}}}class tn{constructor(e){this.demuxer=e}getId(){return 1}getCodec(){return"flac"}getInternalCodecId(){return null}getNumberOfChannels(){return p(this.demuxer.audioInfo),this.demuxer.audioInfo.numberOfChannels}async computeDuration(){const e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getSampleRate(){return p(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}getName(){return null}getLanguageCode(){return Q}getTimeResolution(){return p(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}async getFirstTimestamp(){return 0}async getDecoderConfig(){return p(this.demuxer.audioInfo),{codec:"flac",numberOfChannels:this.demuxer.audioInfo.numberOfChannels,sampleRate:this.demuxer.audioInfo.sampleRate,description:this.demuxer.audioInfo.description}}async getPacket(e,t){if(p(this.demuxer.audioInfo),e<0)throw new Error("Timestamp cannot be negative");const a=await this.demuxer.readingMutex.acquire();try{for(;;){const n=z(this.demuxer.loadedSamples,e,c=>c.blockOffset/this.demuxer.audioInfo.sampleRate);if(n===-1){await this.demuxer.advanceReader();continue}const s=this.demuxer.loadedSamples[n],i=s.blockOffset/this.demuxer.audioInfo.sampleRate,o=s.blockSize/this.demuxer.audioInfo.sampleRate;if(i+o<=e){if(this.demuxer.lastSampleLoaded)return this.getPacketAtIndex(this.demuxer.loadedSamples.length-1,t);await this.demuxer.advanceReader();continue}return this.getPacketAtIndex(n,t)}}finally{a()}}async getNextPacket(e,t){const a=await this.demuxer.readingMutex.acquire();try{const n=e.sequenceNumber+1;if(this.demuxer.lastSampleLoaded&&n>=this.demuxer.loadedSamples.length)return null;for(;n>=this.demuxer.loadedSamples.length&&!this.demuxer.lastSampleLoaded;)await this.demuxer.advanceReader();return this.getPacketAtIndex(n,t)}finally{a()}}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}async getPacketAtIndex(e,t){const a=this.demuxer.loadedSamples[e];if(!a)return null;let n;if(t.metadataOnly)n=j;else{let o=this.demuxer.reader.requestSlice(a.byteOffset,a.byteSize);if(o instanceof Promise&&(o=await o),!o)return null;n=F(o,a.byteSize)}p(this.demuxer.audioInfo);const s=a.blockOffset/this.demuxer.audioInfo.sampleRate,i=a.blockSize/this.demuxer.audioInfo.sampleRate;return new O(n,"key",s,i,e,a.byteSize)}async getFirstPacket(e){for(;this.demuxer.loadedSamples.length===0&&!this.demuxer.lastSampleLoaded;)await this.demuxer.advanceReader();return this.getPacketAtIndex(0,e)}}class le{}class xr extends le{async _getMajorBrand(e){let t=e._reader.requestSlice(0,12);return t instanceof Promise&&(t=await t),!t||(t.skip(4),M(t,4)!=="ftyp")?null:M(t,4)}_createDemuxer(e){return new ua(e)}}class rn extends xr{async _canReadInput(e){const t=await this._getMajorBrand(e);return!!t&&t!=="qt  "}get name(){return"MP4"}get mimeType(){return"video/mp4"}}class an extends xr{async _canReadInput(e){return await this._getMajorBrand(e)==="qt  "}get name(){return"QuickTime File Format"}get mimeType(){return"video/quicktime"}}class Ir extends le{async isSupportedEBMLOfDocType(e,t){let a=e._reader.requestSlice(0,ee);if(a instanceof Promise&&(a=await a),!a)return!1;const n=hr(a);if(n===null||n<1||n>8||E(a,n)!==S.EBML)return!1;const i=mr(a);if(i===null)return!1;let o=e._reader.requestSlice(a.filePos,i);if(o instanceof Promise&&(o=await o),!o)return!1;const c=a.filePos;for(;o.filePos<=c+i-$;){const l=te(o);if(!l)break;const{id:d,size:u}=l,f=o.filePos;if(u===null)return!1;switch(d){case S.EBMLVersion:if(E(o,u)!==1)return!1;break;case S.EBMLReadVersion:if(E(o,u)!==1)return!1;break;case S.DocType:if(Pe(o,u)!==t)return!1;break;case S.DocTypeVersion:if(E(o,u)>4)return!1;break}o.filePos=f+u}return!0}_canReadInput(e){return this.isSupportedEBMLOfDocType(e,"matroska")}_createDemuxer(e){return new ya(e)}get name(){return"Matroska"}get mimeType(){return"video/x-matroska"}}class nn extends Ir{_canReadInput(e){return this.isSupportedEBMLOfDocType(e,"webm")}get name(){return"WebM"}get mimeType(){return"video/webm"}}class sn extends le{async _canReadInput(e){let t=e._reader.requestSlice(0,10);if(t instanceof Promise&&(t=await t),!t)return!1;let a=0,n=!1;for(;;){let l=e._reader.requestSlice(a,rt);if(l instanceof Promise&&(l=await l),!l)break;const d=at(l);if(!d)break;n=!0,a=l.filePos+d.size}const s=await Ct(e._reader,a,a+4096);if(!s)return!1;if(n)return!0;a=s.startPos+s.header.totalSize;const i=await Ct(e._reader,a,a+br);if(!i)return!1;const o=s.header,c=i.header;return!(o.channel!==c.channel||o.sampleRate!==c.sampleRate)}_createDemuxer(e){return new Ra(e)}get name(){return"MP3"}get mimeType(){return"audio/mpeg"}}class on extends le{async _canReadInput(e){let t=e._reader.requestSlice(0,12);if(t instanceof Promise&&(t=await t),!t)return!1;const a=M(t,4);return a!=="RIFF"&&a!=="RIFX"&&a!=="RF64"?!1:(t.skip(4),M(t,4)==="WAVE")}_createDemuxer(e){return new Wa(e)}get name(){return"WAVE"}get mimeType(){return"audio/wav"}}class cn extends le{async _canReadInput(e){let t=e._reader.requestSlice(0,4);return t instanceof Promise&&(t=await t),t?M(t,4)==="OggS":!1}_createDemuxer(e){return new qa(e)}get name(){return"Ogg"}get mimeType(){return"application/ogg"}}class ln extends le{async _canReadInput(e){let t=e._reader.requestSlice(0,4);return t instanceof Promise&&(t=await t),t?M(t,4)==="fLaC":!1}get name(){return"FLAC"}get mimeType(){return"audio/flac"}_createDemuxer(e){return new en(e)}}class un extends le{async _canReadInput(e){let t=e._reader.requestSliceRange(0,nt,it);if(t instanceof Promise&&(t=await t),!t)return!1;const a=_t(t);if(!a||(t=e._reader.requestSliceRange(a.frameLength,nt,it),t instanceof Promise&&(t=await t),!t))return!1;const n=_t(t);return n?a.objectType===n.objectType&&a.samplingFrequencyIndex===n.samplingFrequencyIndex&&a.channelConfiguration===n.channelConfiguration:!1}_createDemuxer(e){return new ja(e)}get name(){return"ADTS"}get mimeType(){return"audio/aac"}}const dn=new rn,fn=new an,hn=new Ir,mn=new nn,pn=new sn,gn=new on,kn=new cn,bn=new un,Tn=new ln,Sn=[dn,fn,hn,mn,gn,kn,Tn,pn,bn];class Cr{constructor(){this._disposed=!1,this._sizePromise=null,this.onread=null}async getSizeOrNull(){if(this._disposed)throw new W;return this._sizePromise??=Promise.resolve(this._retrieveSize())}async getSize(){if(this._disposed)throw new W;const e=await this.getSizeOrNull();if(e===null)throw new Error("Cannot determine the size of an unsized source.");return e}}class yn extends Cr{constructor(e,t={}){if(!(e instanceof Blob))throw new TypeError("blob must be a Blob.");if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(t.maxCacheSize!==void 0&&(!Qt(t.maxCacheSize)||t.maxCacheSize<0))throw new TypeError("options.maxCacheSize, when provided, must be a non-negative number.");super(),this._readers=new WeakMap,this._blob=e,this._orchestrator=new Pn({maxCacheSize:t.maxCacheSize??8*2**20,maxWorkerCount:4,runWorker:this._runWorker.bind(this),prefetchProfile:wn.fileSystem})}_retrieveSize(){const e=this._blob.size;return this._orchestrator.fileSize=e,e}_read(e,t){return this._orchestrator.read(e,t)}async _runWorker(e){let t=this._readers.get(e);for(t===void 0&&("stream"in this._blob?t=this._blob.slice(e.currentPos).stream().getReader():t=null,this._readers.set(e,t));e.currentPos<e.targetPos&&!e.aborted;)if(t){const{done:a,value:n}=await t.read();if(a){if(this._orchestrator.forgetWorker(e),e.currentPos<e.targetPos)throw new Error("Blob reader stopped unexpectedly before all requested data was read.");break}if(e.aborted)break;this.onread?.(e.currentPos,e.currentPos+n.length),this._orchestrator.supplyWorkerData(e,n)}else{const a=await this._blob.slice(e.currentPos,e.targetPos).arrayBuffer();if(e.aborted)break;this.onread?.(e.currentPos,e.currentPos+a.byteLength),this._orchestrator.supplyWorkerData(e,new Uint8Array(a))}e.running=!1}_dispose(){this._orchestrator.dispose()}}const wn={fileSystem:(r,e)=>(r=Math.floor((r-65536)/65536)*65536,e=Math.ceil((e+65536)/65536)*65536,{start:r,end:e})};class Pn{constructor(e){this.options=e,this.fileSize=null,this.nextAge=0,this.workers=[],this.cache=[],this.currentCacheSize=0,this.disposed=!1}read(e,t){p(this.fileSize!==null);const a=this.options.prefetchProfile(e,t,this.workers),n=Math.max(a.start,0),s=Math.min(a.end,this.fileSize);p(n<=e&&t<=s);let i=null;const o=z(this.cache,e,g=>g.start),c=o!==-1?this.cache[o]:null;c&&c.start<=e&&t<=c.end&&(c.age=this.nextAge++,i={bytes:c.bytes,view:c.view,offset:c.start});const l=z(this.cache,n,g=>g.start),d=i?null:new Uint8Array(t-e);let u=0,f=n;const h=[];if(l!==-1){for(let g=l;g<this.cache.length;g++){const w=this.cache[g];if(w.start>=s)break;if(w.end<=n)continue;const y=Math.max(n,w.start),I=Math.min(s,w.end);if(p(y<=I),f<y&&h.push({start:f,end:y}),f=I,d){const v=Math.max(e,w.start),x=Math.min(t,w.end);if(v<x){const C=v-e;d.set(w.bytes.subarray(v-w.start,x-w.start),C),C===u&&(u=x-e)}}w.age=this.nextAge++}f<s&&h.push({start:f,end:s})}else h.push({start:n,end:s});if(d&&u>=d.length&&(i={bytes:d,view:V(d),offset:e}),h.length===0)return p(i),i;const{promise:m,resolve:k,reject:b}=L(),T=[];for(const g of h){const w=Math.max(e,g.start),y=Math.min(t,g.end);w===g.start&&y===g.end?T.push(g):w<y&&T.push({start:w,end:y})}for(const g of h){const w=d&&{start:e,bytes:d,holes:T,resolve:k,reject:b};let y=!1;for(const I of this.workers)if(Kt(g.start-131072,g.start,I.currentPos,I.targetPos)){I.targetPos=Math.max(I.targetPos,g.end),y=!0,w&&!I.pendingSlices.includes(w)&&I.pendingSlices.push(w),I.running||this.runWorker(I);break}if(!y){const I=this.createWorker(g.start,g.end);w&&(I.pendingSlices=[w]),this.runWorker(I)}}return i||(p(d),i=m.then(g=>({bytes:g,view:V(g),offset:e}))),i}createWorker(e,t){const a={startPos:e,currentPos:e,targetPos:t,running:!1,aborted:this.disposed,pendingSlices:[],age:this.nextAge++};for(this.workers.push(a);this.workers.length>this.options.maxWorkerCount;){let n=0,s=this.workers[0];for(let i=1;i<this.workers.length;i++){const o=this.workers[i];o.age<s.age&&(n=i,s=o)}if(s.running&&s.pendingSlices.length>0)break;s.aborted=!0,this.workers.splice(n,1)}return a}runWorker(e){p(!e.running),p(e.currentPos<e.targetPos),e.running=!0,e.age=this.nextAge++,this.options.runWorker(e).catch(t=>{if(e.running=!1,e.pendingSlices.length>0)e.pendingSlices.forEach(a=>a.reject(t)),e.pendingSlices.length=0;else throw t})}supplyWorkerData(e,t){p(!e.aborted);const a=e.currentPos,n=a+t.length;this.insertIntoCache({start:a,end:n,bytes:t,view:V(t),age:this.nextAge++}),e.currentPos+=t.length,e.targetPos=Math.max(e.targetPos,e.currentPos);for(let s=0;s<e.pendingSlices.length;s++){const i=e.pendingSlices[s],o=Math.max(a,i.start),c=Math.min(n,i.start+i.bytes.length);o<c&&i.bytes.set(t.subarray(o-a,c-a),o-i.start);for(let l=0;l<i.holes.length;l++){const d=i.holes[l];a<=d.start&&n>d.start&&(d.start=n),d.end<=d.start&&(i.holes.splice(l,1),l--)}i.holes.length===0&&(i.resolve(i.bytes),e.pendingSlices.splice(s,1),s--)}for(let s=0;s<this.workers.length;s++){const i=this.workers[s];e===i||i.running||Kt(a,n,i.currentPos,i.targetPos)&&(this.workers.splice(s,1),s--)}}forgetWorker(e){const t=this.workers.indexOf(e);p(t!==-1),this.workers.splice(t,1)}insertIntoCache(e){if(this.options.maxCacheSize===0)return;let t=z(this.cache,e.start,a=>a.start)+1;if(t>0){const a=this.cache[t-1];if(a.end>=e.end)return;if(a.end>e.start){const n=new Uint8Array(e.end-a.start);n.set(a.bytes,0),n.set(e.bytes,e.start-a.start),this.currentCacheSize+=e.end-a.end,a.bytes=n,a.view=V(n),a.end=e.end,t--,e=a}else this.cache.splice(t,0,e),this.currentCacheSize+=e.bytes.length}else this.cache.splice(t,0,e),this.currentCacheSize+=e.bytes.length;for(let a=t+1;a<this.cache.length;a++){const n=this.cache[a];if(e.end<=n.start)break;if(e.end>=n.end){this.cache.splice(a,1),this.currentCacheSize-=n.bytes.length,a--;continue}const s=new Uint8Array(n.end-e.start);s.set(e.bytes,0),s.set(n.bytes,n.start-e.start),this.currentCacheSize-=e.end-n.start,e.bytes=s,e.view=V(s),e.end=n.end,this.cache.splice(a,1);break}for(;this.currentCacheSize>this.options.maxCacheSize;){let a=0,n=this.cache[0];for(let s=1;s<this.cache.length;s++){const i=this.cache[s];i.age<n.age&&(a=s,n=i)}if(this.currentCacheSize-n.bytes.length<=this.options.maxCacheSize)break;this.cache.splice(a,1),this.currentCacheSize-=n.bytes.length}}dispose(){for(const e of this.workers)e.aborted=!0;this.workers.length=0,this.cache.length=0,this.disposed=!0}}jt();class xn{get disposed(){return this._disposed}constructor(e){if(this._demuxerPromise=null,this._format=null,this._disposed=!1,!e||typeof e!="object")throw new TypeError("options must be an object.");if(!Array.isArray(e.formats)||e.formats.some(t=>!(t instanceof le)))throw new TypeError("options.formats must be an array of InputFormat.");if(!(e.source instanceof Cr))throw new TypeError("options.source must be a Source.");if(e.source._disposed)throw new Error("options.source must not be disposed.");this._formats=e.formats,this._source=e.source,this._reader=new In(e.source)}_getDemuxer(){return this._demuxerPromise??=(async()=>{this._reader.fileSize=await this._source.getSizeOrNull();for(const e of this._formats)if(await e._canReadInput(this))return this._format=e,e._createDemuxer(this);throw new Error("Input has an unsupported or unrecognizable format.")})()}get source(){return this._source}async getFormat(){return await this._getDemuxer(),p(this._format),this._format}async computeDuration(){return(await this._getDemuxer()).computeDuration()}async getTracks(){return(await this._getDemuxer()).getTracks()}async getVideoTracks(){return(await this.getTracks()).filter(t=>t.isVideoTrack())}async getAudioTracks(){return(await this.getTracks()).filter(t=>t.isAudioTrack())}async getPrimaryVideoTrack(){return(await this.getTracks()).find(t=>t.isVideoTrack())??null}async getPrimaryAudioTrack(){return(await this.getTracks()).find(t=>t.isAudioTrack())??null}async getMimeType(){return(await this._getDemuxer()).getMimeType()}async getMetadataTags(){return(await this._getDemuxer()).getMetadataTags()}dispose(){this._disposed||(this._disposed=!0,this._source._disposed=!0,this._source._dispose())}[Symbol.dispose](){this.dispose()}}class W extends Error{constructor(e="Input has been disposed."){super(e),this.name="InputDisposedError"}}class In{constructor(e){this.source=e}requestSlice(e,t){if(this.source._disposed)throw new W;if(this.fileSize!==null&&e+t>this.fileSize)return null;const a=e+t,n=this.source._read(e,a);return n instanceof Promise?n.then(s=>s?new Fe(s.bytes,s.view,s.offset,e,a):null):n?new Fe(n.bytes,n.view,n.offset,e,a):null}requestSliceRange(e,t,a){if(this.source._disposed)throw new W;if(this.fileSize!==null)return this.requestSlice(e,Lt(this.fileSize-e,t,a));{const n=this.requestSlice(e,a),s=i=>{if(i)return i;const o=l=>(p(l!==null),this.requestSlice(e,Lt(l-e,t,a))),c=this.source._retrieveSize();return c instanceof Promise?c.then(o):o(c)};return n instanceof Promise?n.then(s):s(n)}}}class Fe{constructor(e,t,a,n,s){this.bytes=e,this.view=t,this.offset=a,this.start=n,this.end=s,this.bufferPos=n-a}static tempFromBytes(e){return new Fe(e,V(e),0,0,e.length)}get length(){return this.end-this.start}get filePos(){return this.offset+this.bufferPos}set filePos(e){this.bufferPos=e-this.offset}get remainingLength(){return Math.max(this.end-this.filePos,0)}skip(e){this.bufferPos+=e}slice(e,t=this.end-e){if(e<this.start||e+t>this.end)throw new RangeError("Slicing outside of original slice.");return new Fe(this.bytes,this.view,this.offset,e,e+t)}}const q=(r,e)=>{if(r.filePos<r.start||r.filePos+e>r.end)throw new RangeError(`Tried reading [${r.filePos}, ${r.filePos+e}), but slice is [${r.start}, ${r.end}). This is likely an internal error, please report it alongside the file that caused it.`)},F=(r,e)=>{q(r,e);const t=r.bytes.subarray(r.bufferPos,r.bufferPos+e);return r.bufferPos+=e,t},D=r=>(q(r,1),r.view.getUint8(r.bufferPos++)),Le=(r,e)=>{q(r,2);const t=r.view.getUint16(r.bufferPos,e);return r.bufferPos+=2,t},U=r=>{q(r,2);const e=r.view.getUint16(r.bufferPos,!1);return r.bufferPos+=2,e},Ae=r=>{q(r,3);const e=qt(r.view,r.bufferPos);return r.bufferPos+=3,e},Dt=r=>{q(r,2);const e=r.view.getInt16(r.bufferPos,!1);return r.bufferPos+=2,e},ue=(r,e)=>{q(r,4);const t=r.view.getUint32(r.bufferPos,e);return r.bufferPos+=4,t},P=r=>{q(r,4);const e=r.view.getUint32(r.bufferPos,!1);return r.bufferPos+=4,e},Ee=r=>{q(r,4);const e=r.view.getUint32(r.bufferPos,!0);return r.bufferPos+=4,e},me=r=>{q(r,4);const e=r.view.getInt32(r.bufferPos,!1);return r.bufferPos+=4,e},Cn=r=>{q(r,4);const e=r.view.getInt32(r.bufferPos,!0);return r.bufferPos+=4,e},_r=(r,e)=>{let t,a;return e?(t=ue(r,!0),a=ue(r,!0)):(a=ue(r,!1),t=ue(r,!1)),a*4294967296+t},G=r=>{const e=P(r),t=P(r);return e*4294967296+t},_n=r=>{const e=me(r),t=P(r);return e*4294967296+t},vn=r=>{const e=Ee(r);return Cn(r)*4294967296+e},Dn=r=>{q(r,4);const e=r.view.getFloat32(r.bufferPos,!1);return r.bufferPos+=4,e},vr=r=>{q(r,8);const e=r.view.getFloat64(r.bufferPos,!1);return r.bufferPos+=8,e},M=(r,e)=>{q(r,e);let t="";for(let a=0;a<e;a++)t+=String.fromCharCode(r.bytes[r.bufferPos++]);return t};class Fn{#s=null;#a=null;#e=[];#o=!1;#t;#r;#n=null;constructor(e,t){this.#r=e,this.#t=t}async initialize(e,t){try{this.#o=!0,this.#e=[];const a=new yn(e);this.#s=new xn({source:a,formats:Sn});const n=await this.#s.computeDuration(),s=await this.#s.getPrimaryVideoTrack();if(!s){this.#i("No video track found in the file");return}if(s.codec===null){this.#i("Unsupported video codec");return}if(!await s.canDecode()){this.#i("Unable to decode the video track");return}this.#a=new oa(s);const i=await this.#c(n,t),o=s.displayWidth,c=s.displayHeight;console.log(`[DemuxProcessor] Video dimensions: ${o}x${c}`);const l=n*1e3;this.#t({type:"complete",videoId:this.#r,timestamps:[...i],width:o,height:c,totalTimeInMilSeconds:l})}catch(a){console.error("DemuxProcessor initialization error:",a),this.cleanup(),this.#i(a instanceof Error?a.message:"Unknown initialization error")}}async#c(e,t){if(!this.#a)return[];try{const a=1/t,n=Math.floor(e*t);console.log(`[DemuxProcessor] Extracting timestamps at ${t} fps (${n} total frames)`);let s=0,i=0;const o=this.#a.samples(0);for await(const c of o)try{if(!this.#o)break;const l=c.timestamp;if(l>=i&&s<n){this.#e.push(l),s++,i=s*a;const d=n>0?Math.min(100,s/n*100):0;this.#t({type:"progress",videoId:this.#r,progress:d})}if(s>=n)break}finally{c.close()}console.log(`[DemuxProcessor] Extracted ${this.#e.length} timestamps at ${t} fps`)}catch(a){console.error("[DemuxProcessor] Error extracting timestamps:",a),this.#i(a instanceof Error?a.message:"Error extracting timestamps")}return this.#e}async getFrame(e){if(!this.#a||e<0||e>=this.#e.length){this.#t({type:"frame",videoId:this.#r,index:e,frame:null});return}try{const t=this.#e[e];if(t===void 0){console.warn(`[DemuxProcessor] Not found frame at index ${e}`),this.#t({type:"frame",videoId:this.#r,index:e,frame:null});return}const a=await this.#a.getSample(t);if(a){const n=a.toVideoFrame();try{const s=await createImageBitmap(n);this.#t({type:"frame",videoId:this.#r,index:e,frame:s},[s])}finally{n.close(),a.close()}}else this.#t({type:"frame",videoId:this.#r,index:e,frame:null})}catch(t){console.error(`[DemuxProcessor] Error loading frame at index ${e}:`,t),this.#t({type:"frame",videoId:this.#r,index:e,frame:null})}}async getBatchFrames(e,t,a){if(!this.#a||e<0||t>this.#e.length){this.#i("Invalid batch range");return}this.#n=a;const n=t-e;let s=0;const i=this.#e[e],o=t<this.#e.length?this.#e[t-1]+.001:1/0;try{const c=this.#a.samples(i,o);let l=e;for await(const d of c)try{if(this.#n!==a){console.log(`[DemuxProcessor] Batch ${a} cancelled at frame ${l}`);return}if(l>=t)break;let u=null,f=null;try{u=d.toVideoFrame(),f=await createImageBitmap(u),s++;const h=s===n;this.#t({type:"batch-frame",videoId:this.#r,requestId:a,index:l,frame:f,progress:s/n,isComplete:h},[f])}catch(h){console.error(`[DemuxProcessor] Error creating bitmap at index ${l}:`,h),f?.close()}finally{u?.close()}l++}finally{d.close()}this.#n===a&&(this.#n=null)}catch(c){console.error("[DemuxProcessor] Error in batch decode:",c),this.#n=null,this.#i(`Batch decode failed: ${c instanceof Error?c.message:"Unknown error"}`)}}cancelBatch(e){this.#n===e&&(console.log(`[DemuxProcessor] Cancelling batch ${e}`),this.#n=null)}cleanup(){try{this.#o=!1,this.#e=[],this.#s=null,this.#a=null}catch(e){console.error("[DemuxProcessor] Error during cleanup:",e)}}#i(e){this.#o=!1,this.#t({type:"error",videoId:this.#r,message:e})}}const Be=new Map;self.addEventListener("message",async r=>{const e=r.data;if(e)switch(e.type){case"initialize":{const t=new Fn(e.videoId,self.postMessage.bind(self));Be.set(e.videoId,t),await t.initialize(e.file,e.targetFps);break}case"get-frame":{const t=Be.get(e.videoId);t&&await t.getFrame(e.index);break}case"batch-get-frames":{const t=Be.get(e.videoId);t&&await t.getBatchFrames(e.startIndex,e.endIndex,e.requestId);break}case"cancel-batch":{const t=Be.get(e.videoId);t&&t.cancelBatch(e.requestId);break}case"cleanup":{const t=Be.get(e.videoId);t&&(t.cleanup(),Be.delete(e.videoId));break}default:console.warn("Unknown message received in demux worker:",e)}})})();
